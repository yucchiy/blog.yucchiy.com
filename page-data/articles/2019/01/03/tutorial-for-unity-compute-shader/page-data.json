{"componentChunkName":"component---src-templates-post-tsx","path":"/articles/2019/01/03/tutorial-for-unity-compute-shader/","result":{"data":{"markdownRemark":{"html":"<p>演出で使われるようなシミュレーションをGPUで行いたいなと思い、UnityでCompute shaderを扱う方法について調べてみた。</p>\n<h1 id=\"compute-shaderとは\" style=\"position:relative;\"><a href=\"#compute-shader%E3%81%A8%E3%81%AF\" aria-label=\"compute shaderとは permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Compute shaderとは</h1>\n<blockquote>\n<p>Compute shaders are programs that run on the graphics card, outside of the normal rendering pipeline. They can be used for massively parallel GPGPU algorithms, or to accelerate parts of game rendering.</p>\n</blockquote>\n<p><a href=\"https://docs.unity3d.com/Manual/class-ComputeShader.html\">https://docs.unity3d.com/Manual/class-ComputeShader.html</a> より。</p>\n<p>通常のレンダリングパイプラインとは異なり、GPU上で実行するプログラムのことである。\nこれは、GPGPUによる並列アルゴリズムやゲームのレンダリングの一部を加速させるために使用できる。</p>\n<p>Compute shaderは、<a href=\"https://docs.unity3d.com/ja/current/Manual/SL-ShadingLanguage.html\">DX11 HLSL</a>で記載されます。</p>\n<h1 id=\"compute-shaderの基礎\" style=\"position:relative;\"><a href=\"#compute-shader%E3%81%AE%E5%9F%BA%E7%A4%8E\" aria-label=\"compute shaderの基礎 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Compute shaderの基礎</h1>\n<h2 id=\"kernel\" style=\"position:relative;\"><a href=\"#kernel\" aria-label=\"kernel permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Kernel</h2>\n<p>Kernelは、GPUで実行される処理の単位を指します。シェーダー上では、1つの関数として扱われます。</p>\n<p>例として、2次元の放物線を計算するKernelです。\n<code>#pragma kernel KernelName</code>構文で、シェーダー内の関数がKernelであることを伝えます。\nちなみに、Kernelは1つのシェーダーファイル内に、複数書くことができます。</p>\n<div class=\"gatsby-highlight\" data-language=\"hlsl\"><pre class=\"language-hlsl\"><code class=\"language-hlsl\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\">kernel CalculateParabolaCurve</span></span>\n\n<span class=\"token class-name\">RWStructuredBuffer</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">float</span><span class=\"token operator\">></span> buffer<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">float</span> a<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">,</span> q<span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token function\">numthreads</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">CalculateParabolaCurve</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">uint3</span> dispatchThreadID <span class=\"token operator\">:</span> SV_DispatchThreadID<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    buffer<span class=\"token punctuation\">[</span>dispatchThreadID<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> a <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>dispatchThreadID<span class=\"token punctuation\">.</span>x <span class=\"token operator\">-</span> p<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>dispatchThreadID<span class=\"token punctuation\">.</span>x <span class=\"token operator\">-</span> p<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> q<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"thread\" style=\"position:relative;\"><a href=\"#thread\" aria-label=\"thread permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Thread</h2>\n<p>KernelはThreadによって実行されます。Threadは、3次元で指定します（上記の<code>numthreads</code>の指定がそれ）。\n上記の場合、<code>4 * 1 * 1 = 4</code> Threadが同時に実行されます。</p>\n<h2 id=\"group\" style=\"position:relative;\"><a href=\"#group\" aria-label=\"group permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Group</h2>\n<p>GroupはThreadを実行する単位です。Groupが持つThreadのことを、Group threadと呼びます。\nこのGroupも、3次元で表されます。Groupは、下記のように、Compute shaderを実行するときに指定します。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">Shader<span class=\"token punctuation\">.</span><span class=\"token function\">Dispatch</span><span class=\"token punctuation\">(</span>kernelIndex<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Threadが<code>(4, 1, 1)</code>、Groupが<code>(2, 1, 1)</code>の場合、合計のスレッド数は、<code>(4 * 1 * 1) * (2 * 1 * 1) = 8</code> となります。</p>\n<h2 id=\"computer-shaderを用いて放物線を求める方針\" style=\"position:relative;\"><a href=\"#computer-shader%E3%82%92%E7%94%A8%E3%81%84%E3%81%A6%E6%94%BE%E7%89%A9%E7%B7%9A%E3%82%92%E6%B1%82%E3%82%81%E3%82%8B%E6%96%B9%E9%87%9D\" aria-label=\"computer shaderを用いて放物線を求める方針 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Computer shaderを用いて放物線を求める方針</h2>\n<p>上記の<code>CalculateParabolaCurve</code>では、与えられた x に対して、y を求めています。xは、1次元配列のインデックスで表されています。</p>\n<p>ここで放物線の y の値を 0 &#x3C;= x &#x3C; N まで求めたい場合は、このスレッド数がNになるようにしなければ、すべての値を計算できません(当然ですが…)。</p>\n<p><code>CalculateParabolaCurve</code>をCompute shaderで計算するときには、下記の図のようにThreadとGroupを割り当てて計算します。</p>\n<p><img src=\"https://d2mxuefqeaa7sj.cloudfront.net/s_4724A288696BE9EFDEA1D6D344F94735D0F1D06506938994AA0CED4AC2D63D5F_1546454388167_Compute_shader.jpg\" alt=\"\"></p>\n<p>上記の方針で計算するとして、そのThreadがKernelで計算した結果を書き込む先のバッファの要素を決めるには、そのスレッドIDを用います(バッファの各要素にスレッドが割り当てられている前提なので、バッファの各要素にユニークなスレッドIDが割り当てられている為）。</p>\n<p>スレッドIDを取得するには、Kernelの引数に、<code>uint3 dispatchThreadID : SV_DispatchThreadID</code>と指定します。<code>uint3</code>なのは、Threadが3次元で表現されているからです。</p>\n<p>上記を踏まえて、放物線の計算には、下記のようにしています。</p>\n<div class=\"gatsby-highlight\" data-language=\"hlsl\"><pre class=\"language-hlsl\"><code class=\"language-hlsl\"><span class=\"token keyword\">void</span> <span class=\"token function\">CalculateParabolaCurve</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">uint3</span> dispatchThreadID <span class=\"token operator\">:</span> SV_DispatchThreadID<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 今回y, zは分割をしていないため</span>\n    buffer<span class=\"token punctuation\">[</span>dispatchThreadID<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> a <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>dispatchThreadID<span class=\"token punctuation\">.</span>x <span class=\"token operator\">-</span> p<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>dispatchThreadID<span class=\"token punctuation\">.</span>x <span class=\"token operator\">-</span> p<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> q<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ちなみに、<code>SV_DispatchThreadID</code>は、DirectX HLSLのセマンティクスで、GroupIDやGroupThreadIDなど、様々な値を取ることができます（参考: <a href=\"https://msdn.microsoft.com/ja-jp/library/ee422449(v=vs.85).aspx\">SV_GroupID</a>、<a href=\"https://msdn.microsoft.com/ja-jp/library/ee422451(v=vs.85).aspx\">SV_GroupThreadID</a>）。</p>\n<p>まだ勉強不足なので、それらの値を利用したいケースが思い浮かんでないのですが、バッファ先を特定する場合は、たいてい<code>SV_DispatchThreadID</code>で済む気がします。</p>\n<p>これらの値の算出については、MSDN公式の図及びドキュメントが参考になります。</p>\n<p><img src=\"https://d2mxuefqeaa7sj.cloudfront.net/s_4724A288696BE9EFDEA1D6D344F94735D0F1D06506938994AA0CED4AC2D63D5F_1546455517147_IC340506.png\" alt=\"\"></p>\n<p>この例では1次元利用するだけで十分でしたが、用途に合わせてThreadとGroupをうまく指定します。\n例えば画像処理をCompute shaderで行いたい場合は、2次元をうまく使うと効率よく計算することができます。</p>\n<h1 id=\"compute-shaderをスクリプトから実行する\" style=\"position:relative;\"><a href=\"#compute-shader%E3%82%92%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%8B%E3%82%89%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B\" aria-label=\"compute shaderをスクリプトから実行する permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Compute shaderをスクリプトから実行する</h1>\n<p><code>CalculateParabolaCurve</code>を例に、実際にCompute shaderを実行してみます。</p>\n<div class=\"gatsby-highlight\" data-language=\"hlsl\"><pre class=\"language-hlsl\"><code class=\"language-hlsl\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">pragma</span> <span class=\"token expression\">kernel CalculateParabolaCurve</span></span>\n\n<span class=\"token class-name\">RWStructuredBuffer</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">float</span><span class=\"token operator\">></span> buffer<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">float</span> a<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">,</span> q<span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token function\">numthreads</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">CalculateParabolaCurve</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">uint3</span> dispatchThreadID <span class=\"token operator\">:</span> SV_DispatchThreadID<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    buffer<span class=\"token punctuation\">[</span>dispatchThreadID<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> a <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>dispatchThreadID<span class=\"token punctuation\">.</span>x <span class=\"token operator\">-</span> p<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>dispatchThreadID<span class=\"token punctuation\">.</span>x <span class=\"token operator\">-</span> p<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> q<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>上記のShaderでは、結果を保存するための<code>buffer</code>と、パラメータ<code>a, p, q</code>が変数として定義されています。</p>\n<p>まず、上記のShaderを実行するスクリプトは下記となります。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">UnityEngine</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token namespace\">Yucchiy<span class=\"token punctuation\">.</span>Sandbox<span class=\"token punctuation\">.</span>SimpleComputeShader</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span>  <span class=\"token class-name\">ParabolaCurveCalculator</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">MonoBehaviour</span></span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">public</span> <span class=\"token class-name\">ComputeShader</span> Shader<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">public</span> <span class=\"token class-name\"><span class=\"token keyword\">float</span></span> a<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">,</span> q<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">public</span> <span class=\"token class-name\"><span class=\"token keyword\">uint</span></span> CurveLength <span class=\"token operator\">=</span> <span class=\"token number\">32</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ComputeBuffer</span> Buffer<span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">private</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> kernelIndex <span class=\"token operator\">=</span> Shader<span class=\"token punctuation\">.</span><span class=\"token function\">FindKernel</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CalculateParabolaCurve\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            Buffer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ComputeBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>CurveLength<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\"><span class=\"token keyword\">float</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            Shader<span class=\"token punctuation\">.</span><span class=\"token function\">SetBuffer</span><span class=\"token punctuation\">(</span>kernelIndex<span class=\"token punctuation\">,</span> <span class=\"token string\">\"buffer\"</span><span class=\"token punctuation\">,</span> Buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            Shader<span class=\"token punctuation\">.</span><span class=\"token function\">SetFloat</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            Shader<span class=\"token punctuation\">.</span><span class=\"token function\">SetFloat</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"p\"</span><span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            Shader<span class=\"token punctuation\">.</span><span class=\"token function\">SetFloat</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"q\"</span><span class=\"token punctuation\">,</span> q<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token class-name\"><span class=\"token keyword\">uint</span></span> sizeX<span class=\"token punctuation\">,</span> sizeY<span class=\"token punctuation\">,</span> sizeZ<span class=\"token punctuation\">;</span>\n            Shader<span class=\"token punctuation\">.</span><span class=\"token function\">GetKernelThreadGroupSizes</span><span class=\"token punctuation\">(</span>\n                kernelIndex<span class=\"token punctuation\">,</span>\n                <span class=\"token keyword\">out</span> sizeX<span class=\"token punctuation\">,</span>\n                <span class=\"token keyword\">out</span> sizeY<span class=\"token punctuation\">,</span>\n                <span class=\"token keyword\">out</span> sizeZ\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            Shader<span class=\"token punctuation\">.</span><span class=\"token function\">Dispatch</span><span class=\"token punctuation\">(</span>kernelIndex<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>CurveLength <span class=\"token operator\">/</span> sizeX<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\"><span class=\"token keyword\">float</span></span><span class=\"token punctuation\">[</span>CurveLength<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n            Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">GetData</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> eachResult <span class=\"token keyword\">in</span> result<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                Debug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span>eachResult<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">private</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">OnDestroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">Release</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            Buffer <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"compute-shaderをスクリプトから参照する\" style=\"position:relative;\"><a href=\"#compute-shader%E3%82%92%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%8B%E3%82%89%E5%8F%82%E7%85%A7%E3%81%99%E3%82%8B\" aria-label=\"compute shaderをスクリプトから参照する permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Compute shaderをスクリプトから参照する</h2>\n<p>スクリプトからCompute shader内のKernelにアクセスするには、<code>ComputeShader.FindKernel</code>で取得できるインデックスを用います。<code>FindKernel</code>の引数は文字列で、シェーダー内で定義されたKernel名を指定します(Kernel名は<code>#pragma kernel KernelName</code>の<code>KernelName</code>部分)。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> kernelIndex <span class=\"token operator\">=</span> Shader<span class=\"token punctuation\">.</span><span class=\"token function\">FindKernel</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CalculateParabolaCurve\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"compute-buffer\" style=\"position:relative;\"><a href=\"#compute-buffer\" aria-label=\"compute buffer permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Compute buffer</h2>\n<p>先程の図で述べたとおり、Compute shaderでは、計算結果をCompute bufferと呼ばれる専用バッファを介してやりとりします。このCompute bufferは、スクリプト側で定義して、<code>ComputeShader.SetBuffer</code>によってCompute shaderに渡してやります。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">Buffer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ComputeBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>CurveLength<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\"><span class=\"token keyword\">float</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nShader<span class=\"token punctuation\">.</span><span class=\"token function\">SetBuffer</span><span class=\"token punctuation\">(</span>kernelIndex<span class=\"token punctuation\">,</span> <span class=\"token string\">\"buffer\"</span><span class=\"token punctuation\">,</span> Buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code>ComputeBuffer</code>コンストラクタの第1引数にはバッファサイズを、第2引数にはバッファ1つあたりのサイズを指定します。今回は、計算結果を<code>float</code>で扱うため、<code>sizeof(float)</code>の結果を渡しています。</p>\n<p>作成したバッファを<code>ComputeShader.SetBuffer</code>で渡してやります。第1引数には、Kernelインデックスを渡します。第2引数には、Shader内で定義された変数のうち、バインドしたい変数名を指定します。今回は<code>RWStructuredBuffer&#x3C;float> buffer;</code>に渡してやりたいので、<code>\"``buffer``\"</code>としています。第3引数には作成したバッファを指定します。</p>\n<h2 id=\"compute-shaderへの変数の渡し方\" style=\"position:relative;\"><a href=\"#compute-shader%E3%81%B8%E3%81%AE%E5%A4%89%E6%95%B0%E3%81%AE%E6%B8%A1%E3%81%97%E6%96%B9\" aria-label=\"compute shaderへの変数の渡し方 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Compute shaderへの変数の渡し方</h2>\n<p>今回の例だと<code>a, p, q</code>が、放物線のパラメータとなっていて、Compute shader内では、変数として定義しており、様々な放物線を計算できるようにしています。</p>\n<p>このShader内の変数に、スクリプトから値を渡すには、各種型(<code>Int</code>や<code>Float</code>、<code>Matrix</code>や各種配列)に対して、Setメソッドが用意されています(参考: <a href=\"https://docs.unity3d.com/ScriptReference/ComputeShader.html\">ComputeShader - Unity Documentation</a>)。</p>\n<p>どのSetメソッドも、第1引数にはKernelインデックスを、 第2引数には値や参照を渡します。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">Shader<span class=\"token punctuation\">.</span><span class=\"token function\">SetFloat</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nShader<span class=\"token punctuation\">.</span><span class=\"token function\">SetFloat</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"p\"</span><span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nShader<span class=\"token punctuation\">.</span><span class=\"token function\">SetFloat</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"q\"</span><span class=\"token punctuation\">,</span> q<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"compute-shaderを実行する\" style=\"position:relative;\"><a href=\"#compute-shader%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B\" aria-label=\"compute shaderを実行する permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Compute shaderを実行する</h2>\n<p>バッファや変数の設定が終わったら、いよいよShaderを実行します。実行には、<code>ComputeShader.Dispatch</code>を呼び出します(参考: <a href=\"https://docs.unity3d.com/ScriptReference/ComputeShader.Dispatch.html\">ComputeShader.Dispatch - Unity Documentation</a>)。</p>\n<p>第1引数には、Shader内の、実行したいKernelのインデックスを指定し、第2 〜 4引数にはそれぞれ、(x, y, z)のGroup数を指定します。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">uint</span></span> sizeX<span class=\"token punctuation\">,</span> sizeY<span class=\"token punctuation\">,</span> sizeZ<span class=\"token punctuation\">;</span>\nShader<span class=\"token punctuation\">.</span><span class=\"token function\">GetKernelThreadGroupSizes</span><span class=\"token punctuation\">(</span>\n    handler<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">out</span> sizeX<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">out</span> sizeY<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">out</span> sizeZ\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nShader<span class=\"token punctuation\">.</span><span class=\"token function\">Dispatch</span><span class=\"token punctuation\">(</span>kernelIndex<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>CurveLength <span class=\"token operator\">/</span> sizeX<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>先程の例で、スレッド数とバッファサイズを一致させる必要があると述べました。上記の例だと、Thread * Group で計算される合計スレッド数と、<code>CurveLength</code>のサイズが一致する必要があります。</p>\n<p>アプリケーションとして、<code>CurveLength</code>はユーザ入力として動的に変わります。しかし、Compute shaderの<code>numthreads</code>は、動的に変更することができません。なので、一致させるためには、このGroup数を動的に調整してやる必要があります。</p>\n<p>求めたいGroup数は、合計スレッド数をThread数で割ってやればよいです。KernelのThread数(<code>numthreads</code>で指定されている値)は、<code>ComputeShader.GetKernelThreadGroupSizes</code>によって取得できるため、Group数は、<code>((int)(CurveLength / sizeX), 1, 1)</code>で計算して渡してやります。</p>\n<h2 id=\"compute-shaderの計算結果を受け取る\" style=\"position:relative;\"><a href=\"#compute-shader%E3%81%AE%E8%A8%88%E7%AE%97%E7%B5%90%E6%9E%9C%E3%82%92%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8B\" aria-label=\"compute shaderの計算結果を受け取る permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Compute shaderの計算結果を受け取る</h2>\n<p>Compute shader計算後に、その結果を取り出すには、<code>ComputeShader.GetData</code>を利用します。\n引数には、バッファの結果を書き出す先の配列を指定します。当然ですが、バッファとこの配列のサイズと要素の型は一致させる必要があります(もしかしたらあっていなくても問題ないケースもありそうだけど…。当然期待した結果にはならないはず)。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\"><span class=\"token keyword\">float</span></span><span class=\"token punctuation\">[</span>CurveLength<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\nBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">GetData</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> eachResult <span class=\"token keyword\">in</span> result<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    Debug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span>eachResult<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code>CurveLength=8, a = 2, p = 0, q = 0</code>の時、結果は以下のようになることが確認できます。</p>\n<p><img src=\"https://d2mxuefqeaa7sj.cloudfront.net/s_4724A288696BE9EFDEA1D6D344F94735D0F1D06506938994AA0CED4AC2D63D5F_1546453285963_Screen+Shot+2019-01-03+at+3.20.50.png\" alt=\"\"></p>\n<h1 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h1>\n<p>簡単な計算を通して、Compute shaderの概念・Unityでの使い方について勉強してみました。\n次は、実際に演出などのシミュレーションの計算の実装に使ってみたり、効率の良いGroup・Threadの指定について調べてみたいと思う。</p>\n<h1 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h1>\n<ul>\n<li><a href=\"https://docs.unity3d.com/Manual/class-ComputeShader.html\">Compute shaders - Unity Documentation</a></li>\n<li><a href=\"https://docs.unity3d.com/ScriptReference/ComputeShader.html\">ComputeShader - Unity Documentation</a></li>\n<li><a href=\"https://docs.unity3d.com/ScriptReference/ComputeBuffer.html\">ComputeBuffer - Unity Documentation</a></li>\n<li><a href=\"http://edom18.hateblo.jp/entry/2017/05/10/083421\">ComputeShaderを触ってみる その1 ～スレッド編～</a></li>\n<li><a href=\"https://github.com/keijiro/Swarm\">kenjiro/Swarm - Github</a></li>\n</ul>","excerpt":"演出で使われるようなシミュレーションをGPUで行いたいなと思い、UnityでCompute shaderを扱う方法について調べてみた。 Compute shaderとは Compute shaders are programs that run on the graphics card, outside of the normal rendering pipeline. They can be used for massively parallel GPGPU algorithms, or to…","fields":{"slug":"/articles/2019/01/03/tutorial-for-unity-compute-shader/"},"frontmatter":{"date":"January 02, 2019","type":null,"tags":["Unity","Compute shader","C#","Tutorial"],"title":"UnityのCompute shaderについて理解してみる","description":null,"eyecatch":null}}},"pageContext":{"id":"2df74752-6060-5e07-929d-ee7f907d7e2b"}},"staticQueryHashes":["1480509143","3159585216"]}