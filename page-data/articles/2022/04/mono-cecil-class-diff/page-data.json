{"componentChunkName":"component---src-templates-post-tsx","path":"/articles/2022/04/mono-cecil-class-diff/","result":{"data":{"markdownRemark":{"html":"<h2 id=\"はじめに\" style=\"position:relative;\"><a href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\" aria-label=\"はじめに permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>はじめに</h2>\n<p>Unityの最適化の一環でManaged Code Strippingを調整してたりすると、本来必要な型が最適化で省かれてしまって、ビルドが正常に動かない時があります。</p>\n<p>実機のログを追うと場合によってはログから欠けている型を特定できる場合もありますが、ログのみから特定が難しい場合もあります。</p>\n<p>そこでManaged Code Strippingの設定によって動くビルドと動かないビルドからそれぞれdllを抽出して、Mono.Cecilを用いてdllに入っている型の差分を出す方法を紹介します。</p>\n<h2 id=\"monocecilとは\" style=\"position:relative;\"><a href=\"#monocecil%E3%81%A8%E3%81%AF\" aria-label=\"monocecilとは permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mono.Cecilとは</h2>\n<p>Mono.Cecilについては<a href=\"https://twitter.com/pcysl5edgo\">pCYSl5EDgo</a>さんの <a href=\"https://qiita.com/pCYSl5EDgo/items/4146989d08e169dde81d\">Mono.Cecil入門</a>という記事にかなり丁寧な紹介があるので、この記事では簡単に触れておきます。</p>\n<p><a href=\"https://github.com/jbevain/cecil\">Mono.Cecil</a>はECMA標準に則って構築されたDLLの中身（型とかフィールドとか）を確認したり、DLLを編集・生成するためのライブラリです。</p>\n<p>今回はMono.Cecilを用いてUnityから生成されたアプリから抽出したDLLから型の一覧を抽出します。</p>\n<h2 id=\"unityで作成したアプリからdllを抽出する\" style=\"position:relative;\"><a href=\"#unity%E3%81%A7%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9F%E3%82%A2%E3%83%97%E3%83%AA%E3%81%8B%E3%82%89dll%E3%82%92%E6%8A%BD%E5%87%BA%E3%81%99%E3%82%8B\" aria-label=\"unityで作成したアプリからdllを抽出する permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Unityで作成したアプリからDLLを抽出する</h2>\n<p>Scripting Backendがmonoの場合は、DLLが直接アプリに組み込まれています。例えばStandaloneビルドをしたアプリは、assets/bin/Data/Managedフォルダ配下にDLLが格納されています。</p>\n<p>Scripting Backendがil2cppの場合はC#コードがすべてC++に変換され、soやaなどプラットフォームごとのネイティブライブラリになっているのでDLLは存在しませんが、<a href=\"https://github.com/Perfare/Il2CppDumper\">Il2CppDumper</a>などをツールを用いると型とフィールドのみのDLL（実装が存在しないDLL）を復元できます。</p>\n<p>（※これらのツールの悪用はお控えください）</p>\n<h2 id=\"monocecilを用いて型一覧を取得する\" style=\"position:relative;\"><a href=\"#monocecil%E3%82%92%E7%94%A8%E3%81%84%E3%81%A6%E5%9E%8B%E4%B8%80%E8%A6%A7%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B\" aria-label=\"monocecilを用いて型一覧を取得する permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mono.Cecilを用いて型一覧を取得する</h2>\n<p>適当なC#コンソールアプリケーションのプロジェクトを作成します。</p>\n<p>作成後、NuGet経由でMono.Cecilをインストールします。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6021222b3783f48b5d8f780cef71aea5/5faa8/01.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB00lEQVQoz1WSTW7UQBBGfRB2sIFsUOAMXIoFKEFhyyHYcQySmaAoCSQZe/z/0253u7vdHg+wfsgOiZTFU0m1eF9VqYJv5zVfT0tWNwVt09KbEet2WLvDDdMThmHCugltdiizoxQ9VWuoxExP0WiCTWkopCdpR+7qgZvCcrHtuNhKfhWWn7nhKrvnMjNsSkujR4Q09NpirUdrS9cZhOwJ3p58583Jitefzjg8WXP4+ZyD4xUvj1YcHK95dbTm+YczXnw849n7U959+UFcKmqhMNYzTX/Y7/9i7YjSjiC7vWZ9uWF9HXMVltxlkjDvFtLGUXTjskEhB/J2IKk0ndT0vcP7/SPDsMO5kcBZTxxuSaKYPM3Jkoy6qFFSoVqFFBLdaZxxeDdijSPPK6IweWQbZYSbmKaWBLrriaJ0IUlK8qKhLAVCaKQ0C0o5Br9f1urNQFUJ0rRcaq/d4w2N8QRSWW5vQrZRSlW1lGVD22qUsgtau/uq3CKcV5tFedFSS0fdWoyb8OPvJTRIxcAmTBfRnCJlv0jmF7m/zYRzuyc0jSTNasK4YhNX5FVH3Ro67QmMtqRJsaSWRYMQaplolj/wIJ9l84R13XJ3GyGajmHu/e97P/EPrviFelh+CiYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Mono.CecilをNuGet経由でインストールする\"\n        title=\"Mono.CecilをNuGet経由でインストールする\"\n        src=\"/static/6021222b3783f48b5d8f780cef71aea5/5a190/01.png\"\n        srcset=\"/static/6021222b3783f48b5d8f780cef71aea5/772e8/01.png 200w,\n/static/6021222b3783f48b5d8f780cef71aea5/e17e5/01.png 400w,\n/static/6021222b3783f48b5d8f780cef71aea5/5a190/01.png 800w,\n/static/6021222b3783f48b5d8f780cef71aea5/c1b63/01.png 1200w,\n/static/6021222b3783f48b5d8f780cef71aea5/5faa8/01.png 1444w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\"><p>Mono.CecilをNuGet経由でインストールする</p></figcaption>\n  </figure></p>\n<p>Mono.CecilをNuGet経由でインストールする</p>\n<p>Mono.Cecilを用いてDLL内の型一覧を取得します。下記に実装を示します。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">Mono<span class=\"token punctuation\">.</span>Cecil</span><span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token comment\">// 比較したいDLLのパス</span>\r\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> dll1 <span class=\"token operator\">=</span> <span class=\"token string\">@\"C:\\PATH\\TO\\OptimizedBuild\\assets\\bin\\Data\\Managed\\Assembly-CSharp.dll\"</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> dll2 <span class=\"token operator\">=</span> <span class=\"token string\">@\"C:\\PATH\\TO\\NoOptimizedBuild\\assets\\bin\\Data\\Managed\\Assembly-CSharp.dll\"</span><span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token comment\">// dllをモジュールとして読み込み</span>\r\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> module1 <span class=\"token operator\">=</span> ModuleDefinition<span class=\"token punctuation\">.</span><span class=\"token function\">ReadModule</span><span class=\"token punctuation\">(</span>dll1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> module2 <span class=\"token operator\">=</span> ModuleDefinition<span class=\"token punctuation\">.</span><span class=\"token function\">ReadModule</span><span class=\"token punctuation\">(</span>dll2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token comment\">// モジュールに入っている型情報一覧を型名一覧に変換</span>\r\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> types1 <span class=\"token operator\">=</span> module1<span class=\"token punctuation\">.</span>Types<span class=\"token punctuation\">.</span><span class=\"token function\">Select</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span>FullName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> types2 <span class=\"token operator\">=</span> module2<span class=\"token punctuation\">.</span>Types<span class=\"token punctuation\">.</span><span class=\"token function\">Select</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span>FullName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token comment\">// 型一覧の差集合をとって一覧表示</span>\r\n<span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> typeName <span class=\"token keyword\">in</span> types2<span class=\"token punctuation\">.</span><span class=\"token function\">Except</span><span class=\"token punctuation\">(</span>types1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n    Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span>typeName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>そこまで複雑な実装ではないですが簡単に説明すると、 <code>ModuleDefinition.ReadModule</code> にdllのパスを渡すことでdllのモジュール情報を読み込めます。戻り値の型の <code>Types</code> フィールドにそのモジュールの型一覧が格納されているので、その情報から2つのDLL間の差分をLINQの <code>Except</code> メソッドで計算して、それを一覧表示しています。</p>\n<p>上記の実装では <code>dll2</code> に存在して <code>dll1</code> に存在しない型一覧を表示しています。下図のように型の差分を取得できます。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dd3377314d86989a90087f051a129ad1/adc48/02.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAzUlEQVQoz+WRyaqEMBBFsxDFEeOUoOAsDuj/f95tbh5x+bTXvThUUVW5NUR0XYe+71HXNTIp4fs+PM/7iiAI4Loutm2DmOcZ0zShbVsopZGmqSl4QxiGN47jYF1XCCtmUUohz3MURYGyLFFVFbTWJk6fOcZprc88B9n3HWIcR5znaca9rstYnmAYBjRNY4RtA5Jl2R2jT3guNjuOA4Lj2oSU0hTSJkliiKLo1epceVmWP8H/7kPBJ+I4Np9zCz49eKqxgvxg8XaKJ35Y8AOX0QNBrmJMMAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"2つのDLL間の型一覧の差分を表示\"\n        title=\"2つのDLL間の型一覧の差分を表示\"\n        src=\"/static/dd3377314d86989a90087f051a129ad1/5a190/02.png\"\n        srcset=\"/static/dd3377314d86989a90087f051a129ad1/772e8/02.png 200w,\n/static/dd3377314d86989a90087f051a129ad1/e17e5/02.png 400w,\n/static/dd3377314d86989a90087f051a129ad1/5a190/02.png 800w,\n/static/dd3377314d86989a90087f051a129ad1/adc48/02.png 979w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\"><p>2つのDLL間の型一覧の差分を表示</p></figcaption>\n  </figure></p>","excerpt":"はじめに Unityの最適化の一環でManaged Code Strippingを調整してたりすると、本来必要な型が最適化で省かれてしまって、ビルドが正常に動かない時があります。 実機のログを追うと場合によってはログから欠けている型を特定できる場合もありますが、ログのみから特定が難しい場合もあります。 そこでManaged Code Strippingの設定によって動くビルドと動かないビルドからそれぞれdllを抽出して、Mono.Cecilを用いてdll…","fields":{"slug":"/articles/2022/04/mono-cecil-class-diff/"},"frontmatter":{"date":"April 12, 2022","type":"memo","tags":["C#","Mono.Cecil","IL","Unity"],"title":"Mono.Cecilを用いて２つのDLLの間の型の差分を出す","description":null,"eyecatch":null}}},"pageContext":{"id":"45df16ea-baf9-5c30-b434-e7f5e2c4b533"}},"staticQueryHashes":["1480509143","3159585216"]}