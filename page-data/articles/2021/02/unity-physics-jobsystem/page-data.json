{"componentChunkName":"component---src-templates-post-tsx","path":"/articles/2021/02/unity-physics-jobsystem/","result":{"data":{"markdownRemark":{"html":"<p>PhysicsのレイキャストをC# Job Systemで実行する<a href=\"https://docs.unity3d.com/2020.2/Documentation/ScriptReference/RaycastCommand.html\">RaycastCommand</a>について検証します。</p>\n<h2 id=\"physicsの当たり判定メソッドについて\" style=\"position:relative;\"><a href=\"#physics%E3%81%AE%E5%BD%93%E3%81%9F%E3%82%8A%E5%88%A4%E5%AE%9A%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"physicsの当たり判定メソッドについて permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Physicsの当たり判定メソッドについて</h2>\n<p><code>RaycastCommand</code>を説明する前に、まずは、通常のPhysicsを用いた当たり判定について説明します。</p>\n<p>Physicsでレイキャストによる当たり判定を行うには<a href=\"https://docs.unity3d.com/2020.2/Documentation/ScriptReference/Physics.Raycast.html\">Physics.Raycast</a>というAPIが用意されています。</p>\n<p>ちなみにレイキャストは線分による当たり判定ですが、Physicsにはその他の形状による当たり判定を行うメソッドも用意されています。</p>\n<ul>\n<li><a href=\"https://docs.unity3d.com/2020.2/Documentation/ScriptReference/Physics.BoxCast.html\">Physics.BoxCast</a></li>\n<li><a href=\"https://docs.unity3d.com/2020.2/Documentation/ScriptReference/Physics.CapsuleCast.html\">Physics.CapsuleCast</a></li>\n<li><a href=\"https://docs.unity3d.com/2020.2/Documentation/ScriptReference/Physics.SphereCast.html\">Physics.SphereCast</a></li>\n</ul>\n<p>上記のAPIでは、当たったかどうかを戻り値で取得できます。さらに当たり判定の結果を１つ、<code>RaycastHit</code>型の変数で取得することも出来ます。</p>\n<p>例えば、<code>Physics.Raycast</code>を用いて当たり判定を行うコードは下記のとおりです。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> origin <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector3</span><span class=\"token punctuation\">(</span><span class=\"token number\">1f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3f</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> direction <span class=\"token operator\">=</span> Vector3<span class=\"token punctuation\">.</span>forward<span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> distance <span class=\"token operator\">=</span> <span class=\"token number\">3f</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// ワールド座標(1f, 2f, 3f)から、(0f, 0f, 1f)方向に、</span>\n<span class=\"token comment\">// 距離3でレイを飛ばして当たり判定を行います</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Physics<span class=\"token punctuation\">.</span><span class=\"token function\">Raycast</span><span class=\"token punctuation\">(</span>origin<span class=\"token punctuation\">,</span> direction<span class=\"token punctuation\">,</span> <span class=\"token keyword\">out</span> <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> hit<span class=\"token punctuation\">,</span> distance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// レイがコリジョンに当たった場合はここに入ります</span>\n    <span class=\"token comment\">// hitという変数に当たり判定の結果が格納されるので</span>\n    <span class=\"token comment\">// これを利用することもできます</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>もちろん複数個のコライダーと当たる可能性があります。すべての当たり判定の情報を取得したい場合は<a href=\"https://docs.unity3d.com/2020.2/Documentation/ScriptReference/Physics.RaycastAll.html\">Physics.RaycastAll</a>というメソッドが用意されています。</p>\n<p>また、他の形状の当たり判定メソッドも同様に用意されています。</p>\n<ul>\n<li><a href=\"https://docs.unity3d.com/2020.2/Documentation/ScriptReference/Physics.BoxCastAll.html\">Physics.BoxCastAll</a></li>\n<li><a href=\"https://docs.unity3d.com/2020.2/Documentation/ScriptReference/Physics.CapsuleCastAll.html\">Physics.CapsuleCastAll</a></li>\n<li><a href=\"https://docs.unity3d.com/2020.2/Documentation/ScriptReference/Physics.SphereCastAll.html\">Physics.SphereCastAll</a></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> origin <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector3</span><span class=\"token punctuation\">(</span><span class=\"token number\">1f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3f</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> direction <span class=\"token operator\">=</span> Vector3<span class=\"token punctuation\">.</span>forward<span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> distance <span class=\"token operator\">=</span> <span class=\"token number\">3f</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// ワールド座標(1f, 2f, 3f)から、(0f, 0f, 1f)方向に、</span>\n<span class=\"token comment\">// 距離3でレイを飛ばして当たり判定を行い、</span>\n<span class=\"token comment\">// 当たったコライダーの当たり情報をすべて返却します</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> hits <span class=\"token operator\">=</span> Physics<span class=\"token punctuation\">.</span><span class=\"token function\">RaycastAll</span><span class=\"token punctuation\">(</span>origin<span class=\"token punctuation\">,</span> direction<span class=\"token punctuation\">,</span> distance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">int</span></span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> hits<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> hit <span class=\"token operator\">=</span> hits<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// ここで当たり判定の結果をもとに処理を行います</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ただし上記のAPIでは、当たり判定の結果を格納する配列を都度を確保してしまいます。\nこれを毎フレーム行うとGCによるスパイクの原因になるため、事前に用意した結果を格納する配列を引数に渡して、\nその中に当たり判定の結果を書き込む<a href=\"https://docs.unity3d.com/2020.2/Documentation/ScriptReference/Physics.RaycastNonAlloc.html\">Physics.RaycastNonAlloc</a>というメソッドも合わせて用意されています。</p>\n<p>利用方法は下記のとおりです。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token comment\">// 当たり判定の結果を格納する変数を事前に確保しておきます</span>\n<span class=\"token comment\">// 実際にゲームで利用する場合は当たり判定を取る</span>\n<span class=\"token comment\">// 最大数分配列を確保しておき利用することが多いです(この場合は10)</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> hits <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">RaycastHit</span><span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> origin <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector3</span><span class=\"token punctuation\">(</span><span class=\"token number\">1f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3f</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> direction <span class=\"token operator\">=</span> Vector3<span class=\"token punctuation\">.</span>forward<span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> distance <span class=\"token operator\">=</span> <span class=\"token number\">3f</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// ワールド座標(1f, 2f, 3f)から、(0f, 0f, 1f)方向に、</span>\n<span class=\"token comment\">// 距離3でレイを飛ばして当たり判定を行い、</span>\n<span class=\"token comment\">// 当たったコライダーの当たり情報を書き込み、戻り値に当たり数を返却します</span>\n\n<span class=\"token comment\">// 結果は事前に確保したhitに前方から順番に書き込みされます</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> hitCount <span class=\"token operator\">=</span> Physics<span class=\"token punctuation\">.</span><span class=\"token function\">RaycastNonAlloc</span><span class=\"token punctuation\">(</span>origin<span class=\"token punctuation\">,</span> direction<span class=\"token punctuation\">,</span> hits<span class=\"token punctuation\">,</span> distance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">int</span></span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> hitCount<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> hit <span class=\"token operator\">=</span> hits<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// ここで当たり判定の結果をもとに処理を行います</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>他の形状による当たり判定メソッドも同様に用意されています。</p>\n<ul>\n<li><a href=\"https://docs.unity3d.com/2020.2/Documentation/ScriptReference/Physics.BoxCastNonAlloc.html\">Physics.BoxCastNonAlloc</a></li>\n<li><a href=\"https://docs.unity3d.com/2020.2/Documentation/ScriptReference/Physics.CapsuleCastNonAlloc.html\">Physics.CapsuleCastNonAlloc</a></li>\n<li><a href=\"https://docs.unity3d.com/2020.2/Documentation/ScriptReference/Physics.SphereCastNonAlloc.html\">Physics.SphereCastNonAlloc</a></li>\n</ul>\n<h2 id=\"c-job-systemで当たり判定を行う\" style=\"position:relative;\"><a href=\"#c-job-system%E3%81%A7%E5%BD%93%E3%81%9F%E3%82%8A%E5%88%A4%E5%AE%9A%E3%82%92%E8%A1%8C%E3%81%86\" aria-label=\"c job systemで当たり判定を行う permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>C# Job Systemで当たり判定を行う</h2>\n<p>上記で紹介したAPIに加えてUnityでは<code>Physics.Raycast</code>をC# Job Systemで実行する<code>RaycastCommand</code>というAPIが用意されています。もちろんそれぞれの形状ごとに用意されています。</p>\n<ul>\n<li><a href=\"https://docs.unity3d.com/2020.2/Documentation/ScriptReference/BoxcastCommand.html\">BoxcastCommand</a></li>\n<li><a href=\"https://docs.unity3d.com/2020.2/Documentation/ScriptReference/CapsulecastCommand.html\">CapsulecastCommand</a></li>\n<li><a href=\"https://docs.unity3d.com/2020.2/Documentation/ScriptReference/SpherecastCommand.html\">SpherecastCommand</a></li>\n</ul>\n<p>まずは利用方法を示します。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token comment\">// 一度に実行するレイキャスト数</span>\n<span class=\"token keyword\">const</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> kTestCount <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// レイキャストコマンドと当たり結果を格納する配列を確保します</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> hits <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">NativeArray<span class=\"token punctuation\">&lt;</span>RaycastHit<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>kTestCount<span class=\"token punctuation\">,</span> Allocator<span class=\"token punctuation\">.</span>Persistent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> commands <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">NativeArray<span class=\"token punctuation\">&lt;</span>RaycastCommand<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>kTestCount<span class=\"token punctuation\">,</span> Allocator<span class=\"token punctuation\">.</span>Persistent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 実行するレイキャスト一覧をコマンド化します</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> kTestCount<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// _origins, _directions, _maxDistancesは</span>\n    <span class=\"token comment\">// それぞれの要素がi番目のレイキャスト情報を表します</span>\n    commands<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">RaycastCommand</span><span class=\"token punctuation\">(</span>\n        _origins<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        _directions<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        _maxDistances<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// レイキャストコマンドを一括実行するジョブを作成します</span>\n<span class=\"token comment\">// 1ジョブで実行する最小コマンド数は20とします</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> handle <span class=\"token operator\">=</span> RaycastCommand<span class=\"token punctuation\">.</span><span class=\"token function\">ScheduleBatch</span><span class=\"token punctuation\">(</span>\n    commands<span class=\"token punctuation\">,</span> hits<span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">default</span><span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\">JobHandle</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// ジョブを実行して結果をまちます</span>\nhandle<span class=\"token punctuation\">.</span><span class=\"token function\">Complete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// ここではすべてのレイキャストの実行が完了していて</span>\n<span class=\"token comment\">// 結果がhits配列に格納されています</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> hits<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> hit <span class=\"token operator\">=</span> hits<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// ここで当たり判定の結果をもとに処理を行います</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>まず前提として、ジョブシステムを用いて高速に行うためには、<strong>複数の当たり判定を一括でジョブシステムに投げる</strong>必要があります。\n<strong>当たり判定を複数のコアに割り当てて並列に当たり判定を実行</strong>して、複数の当たり判定の実行を高速化するためです。</p>\n<p>そのため上記コードでは、事前にレイキャストによる当たり判定のパラメータであるレイの原点や方向、\nレイの距離をそれぞれ <code>_origins</code>と<code>_directions</code>、<code>_maxDistances</code>変数に格納しています。その情報から<code>RaycastCommand</code>を生成します。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> kTestCount<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// commandsはNativeArray&lt;RaycastCommand>型</span>\n    commands<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">RaycastCommand</span><span class=\"token punctuation\">(</span>\n        _origins<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        _directions<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        _maxDistances<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>レイキャスト命令の一覧は事前に確保しておきます（<code>commands</code>配列が該当します）。ジョブシステムでは通常の配列は利用できないので、かわりに<code>NativeArray</code>を利用します。\nこの配列はレイキャストコマンド実行前に都度確保しても良いですが、都度配列を確保するのも効率が悪いため、可能であれば事前に確保できることが望ましいです。</p>\n<p>その都度確保する場合は<code>NativeArray</code>のコストラクタ呼び出しの第２引数に<code>Allocator.Temp</code>を指定します。\n事前に確保してクラスのフィールド変数で保持しておく場合は、<code>Allocator.Persistent</code>を指定します。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token comment\">// commandsは事前確保します</span>\n<span class=\"token keyword\">const</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> kTestCount <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> commands <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">NativeArray<span class=\"token punctuation\">&lt;</span>RaycastCommand<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>\n    kTestCount<span class=\"token punctuation\">,</span> Allocator<span class=\"token punctuation\">.</span>Persistent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code>NativeArray</code>は、確保したあと不要になったら、必ず<code>Dispose</code>を呼び出して破棄を行います。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token comment\">// 不要になったら必ず破棄のためにDisposeを呼び出します</span>\ncommands<span class=\"token punctuation\">.</span><span class=\"token function\">Dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>レイキャストの一覧を用意したら、あとはジョブシステムに当たり判定の実行を依頼します。具体的には下記のように記述します。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token comment\">// hitsは事前確保します</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> hits <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">NativeArray<span class=\"token punctuation\">&lt;</span>RaycastHit<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>kTestCount<span class=\"token punctuation\">,</span> Allocator<span class=\"token punctuation\">.</span>Persistent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// レイキャストの一括実行をスケジュールします</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> handle <span class=\"token operator\">=</span> RaycastCommand<span class=\"token punctuation\">.</span><span class=\"token function\">ScheduleBatch</span><span class=\"token punctuation\">(</span>\n    commands<span class=\"token punctuation\">,</span> hits<span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">default</span><span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\">JobHandle</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 完了待ち</span>\nhandle<span class=\"token punctuation\">.</span><span class=\"token function\">Complete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// このタイミングでは当たり判定はすべて実行済み</span>\n\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> hits<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> hit <span class=\"token operator\">=</span> hits<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// ここで当たり判定の結果をもとに処理を行います</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a href=\"https://docs.unity3d.com/2020.2/Documentation/ScriptReference/RaycastCommand.ScheduleBatch.html\">RaycastCommand.ScheduleBatch</a>でジョブシステムに対してレイキャストの一括実行をスケジュールします。\n第１引数にはレイキャスト一覧を、第２引数にはその結果を格納する配列を、第３引数には１ジョブあたりで実行する最小のコマンド数を指定します。</p>\n<p>あとは<code>handle.Complete()</code>を呼び出すことで、レイキャスト実行の完了を待ちます。\n完了すると<code>hits</code>配列に結果が書き込まれます。ちなみに<code>commands</code>と同様に<code>hits</code>配列も事前に確保しておきます。</p>\n<h2 id=\"パフォーマンス検証\" style=\"position:relative;\"><a href=\"#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E6%A4%9C%E8%A8%BC\" aria-label=\"パフォーマンス検証 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>パフォーマンス検証</h2>\n<p>それでは、<code>Physics.Raycast</code>と<code>RaycastCommand</code>のパフォーマンスを検証します。</p>\n<p>著者は下記の環境で検証を行いました。</p>\n<ul>\n<li>Unity 2020.2.3f1</li>\n<li>MacBook Pro 2.9GHz 6-Core Intel Core i9</li>\n</ul>\n<p>テストシーンとして、下図のように左下が<code>(-30f, -30f, -30f)</code>、右上<code>(30f, 30f, 30f)</code>の立方体の空間に半径<code>0.5f ~ 2f</code>の<code>SphereCollider</code>を1000個ランダムに配置します。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7dc35b3711bcf6dd2c1d92d7a6a3ac60/8da59/testscene.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAADH0lEQVQoz11PW08bVxj0e98qEcCYXRsnQXloguyAl3WMnfiCCXXq2lzW9u56bza76yQkQIpERUKJEgVjTJvnXtKqIcVIBGNU/lalxlWbxWeqtUqV9mE0R983M98ch89De65eoV8Peb0HF4eG9r1ud8NNUQ2X09lwDTgbLmd/gx4cbNDUYGPA2d+d20y5XA0PTTcG+vr2+y707Pf39h729vQwjofrG6FvD5t41Tr9B7/ih+YJvjs8wqvDY/z4tomf3jbx89Ex9o5a2Ds6xptmC7+cnODg9BR7rRZeH7fw/cE+NneqikPWNLZar/9Z290926ptv39RrVrPtp5bz6rPrce1J9bG1lfW0+qmtf7isbW6vWY9qW1amztPre2dmlWt1azabt2qf/Pyr/rXL7G8+khwxCMTrJybszSeg8rPE43niMzPkTtagrB6gIQUhlzXh8nIsp9ce3SVsEaAxMosSYsJohU4ohbmicpzHZXncCeZEB1T8VvsgixYplaEqYrEUEXcVSTM3k/jxiqL0FoAI1/4MbY+honlMdxaDGFyKY60mbT1MLUiMbVix/bNfDYtOpKxm2xZyluGIkBXeGIoPGx8bkxjYiWAGw+uwb/iw8jSKMKVIGL3QogaDJTSHEz53CN0dJlHJjVlB0bYctEO7AYR3WaZh6TOIFaKYPyBH4FlH4KVcfjW/IguTuC2HkFJyXUP60rBLtHR5QIyqeT/AuUCsRd2YFnkEL0fBrsRAGuOInQ3gMjKGEIPGUxXbmJBztl66PKHgXbDaIQti7n33aWU7+hSnhhSgZRljiTMOGHXWMIu+UhwkSWxUpQkdJao8iwxJZ7YWttjyIWzBSmPzKdJwTEViwTtYUUVYCp8F3bbe4oITs0gsRhG6MtPcNuIIWtOQiin/9Wdo6J2f4eZ1FTREQ0HA+J85jcpN/OHxGXfFXPZdhdcti3kM+20GG+HS9fbaWGyzQmptszNtj/UFLnsOymX/b3IZc9Sk1HO4ezr/cjroUe9bmp8yE0xNrznTNPMMOVlLlMXmWHay1yiPIzHM/gfzfnb66EZyuX8+G/KZcD4r4qLjgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"テストシーン。緑色の球がSphereCollider表す。\"\n        title=\"テストシーン。緑色の球がSphereCollider表す。\"\n        src=\"/static/7dc35b3711bcf6dd2c1d92d7a6a3ac60/5a190/testscene.png\"\n        srcset=\"/static/7dc35b3711bcf6dd2c1d92d7a6a3ac60/772e8/testscene.png 200w,\n/static/7dc35b3711bcf6dd2c1d92d7a6a3ac60/e17e5/testscene.png 400w,\n/static/7dc35b3711bcf6dd2c1d92d7a6a3ac60/5a190/testscene.png 800w,\n/static/7dc35b3711bcf6dd2c1d92d7a6a3ac60/c1b63/testscene.png 1200w,\n/static/7dc35b3711bcf6dd2c1d92d7a6a3ac60/29007/testscene.png 1600w,\n/static/7dc35b3711bcf6dd2c1d92d7a6a3ac60/8da59/testscene.png 2742w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\"><p>テストシーン。緑色の球がSphereCollider表す。</p></figcaption>\n  </figure></p>\n<p>また、レイキャストは立方体内のランダムな位置から、ランダムな方向に1000回行います。</p>\n<p>具体的には、下記のコードでシーンを用意します。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token comment\">// _rootTransform下にSphereColliderを配置する</span>\n_rootTransform <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">GameObject</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"root\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">;</span>\n_rootTransform<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">.</span>position <span class=\"token operator\">=</span> Vector3<span class=\"token punctuation\">.</span>zero<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// _sphereCountはSphereColliderの数</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> _sphereCount<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> sphereObject <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">GameObject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">.</span><span class=\"token function\">Format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sphere-{0:0000}\"</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    sphereObject<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">.</span><span class=\"token function\">SetParent</span><span class=\"token punctuation\">(</span>_rootTransform<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> sphereCollider <span class=\"token operator\">=</span> sphereObject<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddComponent</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>SphereCollider<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// _minRadiusは最小半径、_maxRadiusが最大半径</span>\n    sphereCollider<span class=\"token punctuation\">.</span>radius <span class=\"token operator\">=</span> Random<span class=\"token punctuation\">.</span><span class=\"token function\">Range</span><span class=\"token punctuation\">(</span>_minRadius<span class=\"token punctuation\">,</span> _maxRadius<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// _leftBottomは左下、_rightTopは右上</span>\n    sphereObject<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">.</span>localPosition <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector3</span><span class=\"token punctuation\">(</span>\n        Random<span class=\"token punctuation\">.</span><span class=\"token function\">Range</span><span class=\"token punctuation\">(</span>_leftBottom<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> _rightTop<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        Random<span class=\"token punctuation\">.</span><span class=\"token function\">Range</span><span class=\"token punctuation\">(</span>_leftBottom<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">,</span> _rightTop<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        Random<span class=\"token punctuation\">.</span><span class=\"token function\">Range</span><span class=\"token punctuation\">(</span>_leftBottom<span class=\"token punctuation\">.</span>z<span class=\"token punctuation\">,</span> _rightTop<span class=\"token punctuation\">.</span>z<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// それぞれレイキャストの位置、方向、距離</span>\n_testOrigins <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector3</span><span class=\"token punctuation\">[</span>_testCount<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n_testDirections <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector3</span><span class=\"token punctuation\">[</span>_testCount<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n_testMaxDistances <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\"><span class=\"token keyword\">float</span></span><span class=\"token punctuation\">[</span>_testCount<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> _testCount<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    _testOrigins<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector3</span><span class=\"token punctuation\">(</span>\n        Random<span class=\"token punctuation\">.</span><span class=\"token function\">Range</span><span class=\"token punctuation\">(</span>_leftBottom<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> _rightTop<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        Random<span class=\"token punctuation\">.</span><span class=\"token function\">Range</span><span class=\"token punctuation\">(</span>_leftBottom<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">,</span> _rightTop<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        Random<span class=\"token punctuation\">.</span><span class=\"token function\">Range</span><span class=\"token punctuation\">(</span>_leftBottom<span class=\"token punctuation\">.</span>z<span class=\"token punctuation\">,</span> _rightTop<span class=\"token punctuation\">.</span>z<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    _testDirections<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector3</span><span class=\"token punctuation\">(</span>\n        Random<span class=\"token punctuation\">.</span><span class=\"token function\">Range</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1f</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        Random<span class=\"token punctuation\">.</span><span class=\"token function\">Range</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1f</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        Random<span class=\"token punctuation\">.</span><span class=\"token function\">Range</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1f</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    _testMaxDistances<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span>\n        Random<span class=\"token punctuation\">.</span><span class=\"token function\">Range</span><span class=\"token punctuation\">(</span><span class=\"token number\">0f</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>_rightTop <span class=\"token operator\">-</span> _leftBottom<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>magnitude<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>また、<code>RaycastCommand.ScheduleBatch</code>のジョブあたりの最小コマンド実行数はそれぞれ<code>100</code>、<code>500</code>、<code>1000</code>を試します。\nこれはそれぞれジョブのワーカー数を<code>1</code>、<code>2</code>、<code>10</code>で検証するためです。(例えばレイキャストコマンド数が<code>1000</code>なので、最小コマンド実行数<code>500</code>とすると、ジョブを実行するワーカー数が<code>2</code>となります。）</p>\n<p>下記が実行結果です。</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">レイキャスト種類</th>\n<th align=\"right\">実行時間(ms)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"left\"><code>Raycast</code></td>\n<td align=\"right\">1.11</td>\n</tr>\n<tr>\n<td align=\"left\"><code>RaycastCommand-min1000</code> (最小コマンド実行数<code>1000</code>)</td>\n<td align=\"right\">1.00</td>\n</tr>\n<tr>\n<td align=\"left\"><code>RaycastCommand-min500</code> (最小コマンド実行数<code>500</code>)</td>\n<td align=\"right\">0.65</td>\n</tr>\n<tr>\n<td align=\"left\"><code>RaycastCommand-min100</code> (最小コマンド実行数<code>100</code>)</td>\n<td align=\"right\">0.15</td>\n</tr>\n</tbody>\n</table>\n<p><code>Raycast</code>と<code>RaycastCommand-min1000</code>が同程度、<code>RaycastCommand-min500</code>が<code>RaycastCommand-min1000</code>より2倍弱高速、<code>RaycastCommand-min100</code>が<code>RaycastCommand-min1000</code>より10倍程度高速になり、概ね期待通りの検証結果になることを確認できました。\nまた、プロファイルのタイムラインを確認してジョブが並列に実行されているか確認します。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/77df88eda11870dd22842f72c57fa271/8da59/raycastcommand-tl-1000-1000.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAACzklEQVQoz02SzW/bNhiHfYiTg4vAGHJY2lhTLIni95esjyiKlfojdWosh6Ethg1JgV22DOih2GF/0Q7JgP1tA1YPWxXzHaSsww4PfiQf8iUJsldxdnxW6l+kVr9O0vwuscm9UupeStWlEKJLa+29lPJfJ+855x2MsTshxJ1S6jeMcdGTSpxNp2eQ5zlYa4EzCpxzEJIBYwIoZUAIBcY4MMo7xxgDgikIIUEpBcZYSNMUwjD8rsc4Kufz+V9VVT1IKT4KFTRpGTZJFjUmjRozQY2yqEny8H9EzeQkbGwWde28iv8+qRgcjZ5e9zjF5enpaZNlOWSpcmUZufN56M4q5M6fIzetY1fXyM3myC0uHnM+i9xsEbn6HLm6jtzzWbitawRB8OymNw6C0hjTcC7hpGTu9RWGV2sCL19iWF0iWF4EsFwGsF5z+PLKwItVDIvlGBbLoHOXa+xWa7FdXHAwFt30fN8vOWcN5wKkit2yPIaryoNiNoHqm69g9cN1x6v338O3P7+DNz/dwuWPb2F1ewOr22soXyTOJNE2ySgozR4LKqUarTVEIXKHTz04fPYFtImCMZxnBOo0hjpjMM0ETFMKuRxDqYPORcfH7vDzo63n+YAxuemNx+OuoBAC4jh2URgApQQIwd1rIoQgjiPAcQxBEIDv++B5HkRRO4YB49gRgrftGozx4wm11h+llK3cCo6clswJzpzWxmmtnVLCGSOdEMIppZyU0llrO8c53wohHtrNR6PRdVvw1Fq7ba+MMQbOYphYBWmaQJIk0L6+MQomEw1aG2jntWRZ1vm2bYzp/qPv+297nuflQojfGWN/IoQ+EEw2grMNpWTDOe+glG44ZxtCyH8IITpHCPlAKf2DEPLged7Xvf39/cFwOEyHw+HJwcFBcTQ6KgZPnhQ7O/2i398t+v2dYnd3t+u3+Yl+v9/xqb+3t1cMBoPP/gFvv0dj3Pl6VwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"RaycastCommand-min1000のタイムライン\"\n        title=\"RaycastCommand-min1000のタイムライン\"\n        src=\"/static/77df88eda11870dd22842f72c57fa271/5a190/raycastcommand-tl-1000-1000.png\"\n        srcset=\"/static/77df88eda11870dd22842f72c57fa271/772e8/raycastcommand-tl-1000-1000.png 200w,\n/static/77df88eda11870dd22842f72c57fa271/e17e5/raycastcommand-tl-1000-1000.png 400w,\n/static/77df88eda11870dd22842f72c57fa271/5a190/raycastcommand-tl-1000-1000.png 800w,\n/static/77df88eda11870dd22842f72c57fa271/c1b63/raycastcommand-tl-1000-1000.png 1200w,\n/static/77df88eda11870dd22842f72c57fa271/29007/raycastcommand-tl-1000-1000.png 1600w,\n/static/77df88eda11870dd22842f72c57fa271/8da59/raycastcommand-tl-1000-1000.png 2742w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\"><p>RaycastCommand-min1000のタイムライン</p></figcaption>\n  </figure></p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2e64174faf405b44be6b6d73cf183ad4/8da59/raycastcommand-tl-1000-100.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAAC4ElEQVQozz2RbWvjRhSFRZ1NYJ2kSXYLcXbtSLGlSJpXzUiesV5iO469lrNQCtmlX3YL/W/9EBf62wpdlXYVzy1Syn54mOHAPZx7rpVj5BQp/41y+nsyVo9Syi1j7BuEkC2ldCuEaF/G2ZZSssUYtyCEHgklj5yzP3z/WluUkeLmpgClFAghACMMGGNA6JkgCIEQChiT/zUCYYggCAIgmACjDDjnEHEBruv+aiHspYvF4p88L54oxV9db1Qz4dVR4tZcejUTbp0WtOYiqAlr9Ea7rgnza8obgpry63+ZcOHS7n+ycOinWZbV47GCZMxMojyTz1wzuxuZ2d3QZDPH5HPPpFPP6Nw1+a1j9M2ViWLPjNORUZOhyaberpgPYeT1P1tXV8OUEFI38QklJiQIAowgbIgVpHe3MFvNYV4uYP3jBjY/vYfF/RLm6xnMNktIFivjB94uCDywbfuzZdt2yhirGWNNRwZjCoSQtjNMGWRawruZgvUig3I5hfvVFO6mCm5zCbdFAnqSGozJrpnxfb9JeJUKIeqmeEJCIyWCKIqAcQIxGUEpe7AWPbjXDryfDGGjbHgnerCR56DoEDChRgqxaw8T8eeEnPPWkFJk4hgDpRSEFCAiDJv4Aj7o1/CQvoEPhQ0fCxse0gt4UD9AGb+BiFMjpWwNOeffVv7aREYI7ShlhjFuwtA3SeSZgjtmLc7NOn5ryvGlKdWlKZO+WcteS4TdHWX8iRAMjuN8agwzIcSu6bBJJqVsVxaRACFiyIUHK2XDUvmwnHiwynxYZ43mwFK5IDmGJBlDM9/v93+xBoOBIoT8iRD6OwiCL4yxilJaYYyrEOEqJ2+rTfSqKuNedT8etJTyvCr5q2oaXVQhCr9QSv8KguBpMBj8bB0fH3dPTk6Ss7OzSbfb1YeHh/r09FR3Oh29v7+vrc6Rtjrfa+u7I21ZL7VldZ//jdY50i9e7Ou9vT19cHCgu93u2X9LAEc6MZVJJwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"RaycastCommand-min100のときのタイムライン\"\n        title=\"RaycastCommand-min100のときのタイムライン\"\n        src=\"/static/2e64174faf405b44be6b6d73cf183ad4/5a190/raycastcommand-tl-1000-100.png\"\n        srcset=\"/static/2e64174faf405b44be6b6d73cf183ad4/772e8/raycastcommand-tl-1000-100.png 200w,\n/static/2e64174faf405b44be6b6d73cf183ad4/e17e5/raycastcommand-tl-1000-100.png 400w,\n/static/2e64174faf405b44be6b6d73cf183ad4/5a190/raycastcommand-tl-1000-100.png 800w,\n/static/2e64174faf405b44be6b6d73cf183ad4/c1b63/raycastcommand-tl-1000-100.png 1200w,\n/static/2e64174faf405b44be6b6d73cf183ad4/29007/raycastcommand-tl-1000-100.png 1600w,\n/static/2e64174faf405b44be6b6d73cf183ad4/8da59/raycastcommand-tl-1000-100.png 2742w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\"><p>RaycastCommand-min100のときのタイムライン</p></figcaption>\n  </figure></p>\n<p><code>RaycastCommand-min1000</code>のタイムラインではジョブの実行が１並列（<code>RaycastCommand</code>がメインスレッドのみでしか実行されていない）ですが、<code>RaycastCommand100</code>のタイムラインではジョブが並列に実行されていることが確認できます。（JobのWorkerに<code>RaycastCommand</code>が割り当てられていることが確認できます）</p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p><code>Physics.Raycast</code>をジョブシステムで実行する<code>RaycastCommand</code>についてその利用方法を紹介し、また<code>Physics.Raycast</code>と<code>RaycastCommand</code>についてそのパフォーマンスを検証しました。</p>","excerpt":"PhysicsのレイキャストをC# Job Systemで実行するRaycastCommandについて検証します。 Physicsの当たり判定メソッドについて RaycastCommandを説明する前に、まずは、通常のPhysicsを用いた当たり判定について説明します。 Physicsでレイキャストによる当たり判定を行うにはPhysics.RaycastというAPIが用意されています。 ちなみにレイキャストは線分による当たり判定ですが、Physics…","fields":{"slug":"/articles/2021/02/unity-physics-jobsystem/"},"frontmatter":{"date":"February 11, 2021","type":null,"tags":["Unity","Physics","Job System"],"title":"UnityのRaycastCommandでレイキャストをジョブシステムで実行する","description":null,"eyecatch":null}}},"pageContext":{"id":"59d188c9-fc68-5e9c-ad66-9c74db028b69"}},"staticQueryHashes":["1480509143","3159585216"]}