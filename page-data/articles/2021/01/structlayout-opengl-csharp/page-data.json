{"componentChunkName":"component---src-templates-post-tsx","path":"/articles/2021/01/structlayout-opengl-csharp/","result":{"data":{"markdownRemark":{"html":"<p>ポリゴンの描画において、それぞれの頂点は位置や法線、テクスチャ座標など複数の属性を持ちます。\nそれらの頂点配列(VBO)のメモリレイアウトをインターリーブ形式にすることで描画を高速に行うテクニックがあります。</p>\n<p>具体的には下記のような配列をGPUに転送します。(コードはOpenTK)</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// vboを生成</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> vbo <span class=\"token operator\">=</span> GL<span class=\"token punctuation\">.</span><span class=\"token function\">GenBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 頂点カラーを持つ頂点</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> positionColorVertices <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\"><span class=\"token keyword\">float</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span>\n<span class=\"token punctuation\">{</span>\n     <span class=\"token comment\">// 位置             // 色</span>\n     <span class=\"token operator\">-</span><span class=\"token number\">0.5f</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">0.5f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1.0f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0f</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 左下</span>\n      <span class=\"token number\">0.5f</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">0.5f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1.0f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0f</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 右下</span>\n      <span class=\"token number\">0.0f</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">0.5f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1.0f</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 上</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 頂点配列に上記のvboをバインド</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">BindBuffer</span><span class=\"token punctuation\">(</span>BufferTarget<span class=\"token punctuation\">.</span>ArrayBuffer<span class=\"token punctuation\">,</span> vbo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// GPUに配列を転送。</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">BufferData</span><span class=\"token punctuation\">(</span>BufferTarget<span class=\"token punctuation\">.</span>ArrayBuffer<span class=\"token punctuation\">,</span> <span class=\"token number\">72</span><span class=\"token punctuation\">,</span> positionColorVertices<span class=\"token punctuation\">,</span> BufferUsageHint<span class=\"token punctuation\">.</span>StaticDraw<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n\n<span class=\"token comment\">// positionLocationは事前に計算しているものとする</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">EnableVertexAttribArray</span><span class=\"token punctuation\">(</span>positionLocation<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">VertexAttribPointer</span><span class=\"token punctuation\">(</span>positionLocation<span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> GL_FLOAT<span class=\"token punctuation\">,</span> GL_FALSE<span class=\"token punctuation\">,</span> <span class=\"token number\">32</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// positionLocationは事前に計算しているものとする</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">EnableVertexAttribArray</span><span class=\"token punctuation\">(</span>colorLocation<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">VertexAttribPointer</span><span class=\"token punctuation\">(</span>colorLocation<span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> GL_FLOAT<span class=\"token punctuation\">,</span> GL_FALSE<span class=\"token punctuation\">,</span> <span class=\"token number\">32</span><span class=\"token punctuation\">,</span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 3頂点をGL_TRIANGLESで描画</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">DrawElements</span><span class=\"token punctuation\">(</span>PrimitiveType<span class=\"token punctuation\">.</span>Triangles<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 708px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c44a7843a87d2742d64fb3150c838ec2/3cb0f/colored-triangle.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABxElEQVQ4y6WSO28TQRSFz9zZTZbVKkZ5WDhScOFYcUEaUrgBS6mQQGmIQiQiY0yJvAQ/+BOkiCKKdJTwA2joIZYgBVJ+SESKPASTPdHsjqNgQEAoPp2ZO/eeOasdHB+fXCX5gOTKf7BKcunw6ChAs9msra8/Z7vdZq/XO6fbzdSexfEztuLY9bw4P7tIp9M9aTQaJQCoASCA7wBOL4Fx818BzMLzvJrWmiJiRCS5iBadIoJEFBLRXjLcIyKnIkKt9YHv+yUopQYJ7U2JWztUqt6VLhGuZjWl+WNPmtLqgYj83lAgqRb1HS7M7DG49YGYms9MRP7NUFyyOVTYzm/zfvUVbzzcptd6SeTzzlT9naG4m2cxzte5OjcWnvDp8iMuxWssbT0mtu4SOd+Z/sFQuYQVgLvRNX6+eZ1vlqe50SmwtTnFe29zLHwZI975xIT7ZPWz4W1X+OZSmhnAVEdg5sZgypMwxWmYQhFmvAwTVmBQhcFk1uuem53fHxguDv21y2KfXdkaziuldgF8BLADoC9AX6sMsUiGsmj0YVHo214380kp9V5rXUAQBIiiyA/DcDQMwxGng/XwfvQXpPUoirx6vY4z984+Wyatgs8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"描画した色付き三角形\"\n        title=\"描画した色付き三角形\"\n        src=\"/static/c44a7843a87d2742d64fb3150c838ec2/3cb0f/colored-triangle.png\"\n        srcset=\"/static/c44a7843a87d2742d64fb3150c838ec2/772e8/colored-triangle.png 200w,\n/static/c44a7843a87d2742d64fb3150c838ec2/e17e5/colored-triangle.png 400w,\n/static/c44a7843a87d2742d64fb3150c838ec2/3cb0f/colored-triangle.png 708w\"\n        sizes=\"(max-width: 708px) 100vw, 708px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\"><p>描画した色付き三角形</p></figcaption>\n  </figure></p>\n<p>ただ、これだと配列のどの要素が位置で、どこが色だっけ... となるので、頂点を構造体の配列で管理したくなります。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// 頂点カラー付き頂点情報の構造体</span>\n<span class=\"token punctuation\">[</span><span class=\"token function\">StructLayout</span><span class=\"token punctuation\">(</span>LayoutKind<span class=\"token punctuation\">.</span>Sequential<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">PositionColor</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Vector3</span> Position<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Vector3</span> Color<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">PositionColor</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Vector3</span> position<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Vector3</span> color<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Position <span class=\"token operator\">=</span> position<span class=\"token punctuation\">;</span>\n        Color <span class=\"token operator\">=</span> color<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// このように定義すると管理しやすい</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> positionColorVerticesWithStruct <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">PositionColor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">PositionColor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector3</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">0.5f</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">0.5f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0f</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector3</span><span class=\"token punctuation\">(</span><span class=\"token number\">1f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0f</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">PositionColor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector3</span><span class=\"token punctuation\">(</span> <span class=\"token number\">0.5f</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">0.5f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0f</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector3</span><span class=\"token punctuation\">(</span><span class=\"token number\">0f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0f</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">PositionColor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector3</span><span class=\"token punctuation\">(</span> <span class=\"token number\">0.0f</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">0.5f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0f</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector3</span><span class=\"token punctuation\">(</span><span class=\"token number\">0f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1f</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>C#の構造体はそれぞれの要素が素直にメモリ上に並びます。なのでこのまま<code>BufferData</code>で転送すれば、GPU上は前述した<code>float</code>の配列と同様のメモリアライメントとなり、上記のコードがそのまま動きます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// GPUに配列を転送。</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">BufferData</span><span class=\"token punctuation\">(</span>BufferTarget<span class=\"token punctuation\">.</span>ArrayBuffer<span class=\"token punctuation\">,</span> <span class=\"token number\">72</span><span class=\"token punctuation\">,</span> positionColorVerticesWithStruct<span class=\"token punctuation\">,</span> BufferUsageHint<span class=\"token punctuation\">.</span>StaticDraw<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </code></pre></div>\n<p>ただし、要素が確実に定義順に並ぶように、<code>StructLayoutAttribute</code>で<code>LayoutKind.Sequential</code>を設定しました。（どの位置にどの要素が来るかを指定しないといけないため。）</p>\n<h2 id=\"参考\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://qiita.com/emadurandal/items/0bb83b545670475f51a3\">GPU本来の性能を引き出すWebGL頂点データ作成法 - Qiita</a></li>\n<li><a href=\"https://wgld.org/d/webgl/w088.html\">wgld.org | WebGL: インターリーブ配列 VBO |</a></li>\n<li><a href=\"https://docs.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.structlayoutattribute?view=net-5.0\">StructLayoutAttribute Class (System.Runtime.InteropServices) | Microsoft Docs</a></li>\n<li><a href=\"https://ufcpp.net/study/csharp/interop/memorylayout/\">複合型のレイアウト - C# によるプログラミング入門 | ++C++; // 未確認飛行 C</a></li>\n</ul>","excerpt":"ポリゴンの描画において、それぞれの頂点は位置や法線、テクスチャ座標など複数の属性を持ちます。\nそれらの頂点配列(VBO)のメモリレイアウトをインターリーブ形式にすることで描画を高速に行うテクニックがあります。 具体的には下記のような配列をGPUに転送します。(コードはOpenTK)  ただ、これだと配列のどの要素が位置で、どこが色だっけ... となるので、頂点を構造体の配列で管理したくなります。 C#の構造体はそれぞれの要素が素直にメモリ上に並びます。なのでこのままBufferData…","fields":{"slug":"/articles/2021/01/structlayout-opengl-csharp/"},"frontmatter":{"date":"January 07, 2021","type":null,"tags":["C#","OpenGL","OpenTK"],"title":"C#の構造体のメモリレイアウトとインターリーブ配列","description":null,"eyecatch":null}}},"pageContext":{"id":"494c8bfb-7f41-56bd-95d1-e9a095e9cfed"}},"staticQueryHashes":["1480509143","3159585216"]}