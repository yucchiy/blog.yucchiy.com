{"componentChunkName":"component---src-templates-post-tsx","path":"/articles/2020/12/advent-calendar-intern/","result":{"data":{"markdownRemark":{"html":"<p>この記事は<a href=\"https://qiita.com/advent-calendar/2020/applibot\">Applibot Advent Calendar 2020</a>および<a href=\"https://adventar.org/calendars/5711\">CyberAgent Developers Advent Calendar 2020</a>の10日目の記事です。\n昨日は<a href=\"https://qiita.com/kbt_\">kbt_</a>さんの<a href=\"https://qiita.com/kbt_/items/99715802e01099995886\">個人とチームの習慣化について</a>とTomomatsu Yutaさんの<a href=\"https://www.ai-shift.co.jp/techblog/1435\">Tableauのダッシュボードの限界を引き上げる拡張機能の紹介</a>でした。</p>\n<p>この記事では、社内のエンジニア向けイベントのヒダッカソンで開催したゲームAIコンテストの設計や実装について、裏側について紹介します。</p>\n<h2 id=\"ヒダッカソンについて\" style=\"position:relative;\"><a href=\"#%E3%83%92%E3%83%80%E3%83%83%E3%82%AB%E3%82%BD%E3%83%B3%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"ヒダッカソンについて permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ヒダッカソンについて</h2>\n<p>ヒダッカソンは、サイバーエージェントのゲーム事業部（SGE）の社内エンジニア向けイベントです。ここ数回は隔年ごとに開催されています。参考ですが前々回のヒダッカソンのレポートは<a href=\"https://creator.game.cyberagent.co.jp/?p=5425\">こちら</a>になります。\nクライアントとサーバー部門があり、それぞれイベントごとにお題を変えて開催します。クライアント部門は例年ゲームの仕様書が渡されて、そのゲームの機能の実装量で順位を競うイベントでした。</p>\n<p>今回クライアント部門はお題を刷新し、とあるゲームを攻略するAIを実装するイベントとしました。運営メンバーは4人で、私以外にサーバー・インフラ・作問の担当者がいました。私はこのイベントの企画立案から実装・運用を担当しました。</p>\n<p>また、クライアント部門のイベントをもとにした1dayインターンを「<a href=\"https://www.cyberagent.co.jp/careers/students/event/detail/id=24421\">ゲームAI×プロコン型インターン</a>」として開催しました。</p>\n<h3 id=\"今回のお題について\" style=\"position:relative;\"><a href=\"#%E4%BB%8A%E5%9B%9E%E3%81%AE%E3%81%8A%E9%A1%8C%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"今回のお題について permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>今回のお題について</h3>\n<p>今年のイベントは「ゲームAIコンテスト」と題して、とある2Dのターンベースなゲーム\b\bのAIを書いて、そのスコアを競います。\n具体的にはゲームルールとそのゲームの複数のステージ（課題）が与えられ、競技者は課題をクリアするプレイヤーAIをそれぞれの課題に提出し、課題を解いた数の総数で競いました。</p>\n<h3 id=\"ゲームaiの実装方法\" style=\"position:relative;\"><a href=\"#%E3%82%B2%E3%83%BC%E3%83%A0ai%E3%81%AE%E5%AE%9F%E8%A3%85%E6%96%B9%E6%B3%95\" aria-label=\"ゲームaiの実装方法 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ゲームAIの実装方法</h3>\n<p>競技者はゲームAIを具体的に下記の<code>PlayerBrain</code>クラスを継承して実装します。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PlayerBrain</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token return-type class-name\">PlayerCommand</span> <span class=\"token function\">Think</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Environment</span> environment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>今回のお題のゲームはターンベースで、この<code>Think</code>メソッドがターンごとに呼び出されます。引数に渡される<code>environment</code>はそのターンにおけるゲームの状況を表しています。\nこの引数を元に、プレイヤーはゲームの状況を把握し、戻り値として自プレイヤーのそのターンの行動を返却します。</p>\n<p><code>Environment</code>の一部実装は下記のとおりです。このように、現在のフィールドの状況やプレイヤー情報の一覧が配列で格納されています。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Environment</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/// 現在のターン</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> Turn<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">/// フィールド情報の配列</span>\n    <span class=\"token comment\">/// [y座標, x座標]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">FieldType<span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">]</span></span> Fields<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">/// プレイヤー情報の配列</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Player<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> Players<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">/// AIを操作する自身のプレイヤーId</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> YourPlayerId<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">/// ...</span>\n    <span class=\"token comment\">/// 他にもたくさんある</span>\n    <span class=\"token comment\">/// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ちなみに、このゲームに自プレイヤー以外にも敵プレイヤーが登場するのですが、<strong>システム上はどちらも同じプレイヤーとして実装されているため</strong>、<code>Players</code>は配列になっています。\n自プレイヤーを把握するために<code>YourPlayerId</code>があわせて渡されています。</p>\n<p>戻り値のプレイヤーの行動を表す<code>PlayerCommand</code>は下記のように実装されています。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PlayerCommand</span> \n<span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PlayerCommandMove</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">PlayerCommand</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">enum</span> <span class=\"token class-name\">Direction</span>\n    <span class=\"token punctuation\">{</span>\n        Up<span class=\"token punctuation\">,</span>\n        Down<span class=\"token punctuation\">,</span>\n        Left<span class=\"token punctuation\">,</span>\n        Right<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Vector2</span> DeltaPosition <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">PlayerCommandMove</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Direction</span> direction<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>direction<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">case</span> Direction<span class=\"token punctuation\">.</span>Down<span class=\"token punctuation\">:</span>\n                DeltaPosition <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector2</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">case</span> Direction<span class=\"token punctuation\">.</span>Up<span class=\"token punctuation\">:</span>\n                DeltaPosition <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector2</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">case</span> Direction<span class=\"token punctuation\">.</span>Left<span class=\"token punctuation\">:</span>\n                DeltaPosition <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector2</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">case</span> Direction<span class=\"token punctuation\">.</span>Right<span class=\"token punctuation\">:</span>\n                DeltaPosition <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector2</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">/// ...</span>\n<span class=\"token comment\">/// 他にもコマンドがたくさんある</span>\n<span class=\"token comment\">/// ...</span></code></pre></div>\n<p>たとえばえば左に移動したい場合は、<code>Think</code>メソッドを下記のように実装します。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MoveOnlyLeftPlayerBrain</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">PlayerBrain</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">override</span> <span class=\"token return-type class-name\">PlayerCommand</span> <span class=\"token function\">Think</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Environment</span> environment<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">PlayerCommandMove</span><span class=\"token punctuation\">(</span>PlayerCommandMove<span class=\"token punctuation\">.</span>Direction<span class=\"token punctuation\">.</span>Left<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>競技者はお題ごとに適切なクラスを実装し、その正答数で順位を競いました。</p>\n<h2 id=\"ゲームaiコンテストの設計と実装\" style=\"position:relative;\"><a href=\"#%E3%82%B2%E3%83%BC%E3%83%A0ai%E3%82%B3%E3%83%B3%E3%83%86%E3%82%B9%E3%83%88%E3%81%AE%E8%A8%AD%E8%A8%88%E3%81%A8%E5%AE%9F%E8%A3%85\" aria-label=\"ゲームaiコンテストの設計と実装 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ゲームAIコンテストの設計と実装</h2>\n<p>コンテストは主業務を持ちながら準備する必要があったため、できる<strong>限り省ける実装は省きたい、でもクオリティに妥協はしたくない</strong>という点が念頭にありました。\nそこでアイデアとして<a href=\"https://www.slideshare.net/UnityTechnologiesJapan/unite-2017-tokyocunirx\">C#大統一理論</a>を参考に、<strong>ゲームクライアント実装から採点サーバー・ツール類の実装言語を揃えてロジックを共有しあう</strong>ことで（複数言語実装と比べて）ムダを省くようにしました。また、重複実装を省くことで、その実装によるバグを埋め込むリスクもなくなりました。</p>\n<p>競技者にはAIの実装に集中してほしかったため、ゲームのシミュレーターなどのAI以外の実装はすべて開発キットを用意しました。開発キットの技術選定は、SGEではUnityを使ってゲームを開発している子会社が大半なため、Unity上で実装して（つまりC#で実装して）、そのプロジェクトファイルをそのまま配布しました。\nただし、後述しますがUnity以外のプロジェクトを利用されている方や特定のUnityの機能の熟練度に順位が依存しないように、プレイヤーAIの実装にはUnityのAPIの利用を禁止（厳密にはコンパイルが通らない）とし、C#の基礎が分かれば参加できるような課題を出題しました。</p>\n<p>開発キットはC#で固定のため、こちらの<a href=\"https://www.slideshare.net/neuecc/cedec-2018-c-c\">トライアングル論法</a>的にゲームに深く関わる実装はC#で実装しました。具体的にはゲームを採点するジャッジサーバーと、テストデータなどを作成するツール類はC#で実装しています。</p>\n<h3 id=\"採点システムを安定させる\" style=\"position:relative;\"><a href=\"#%E6%8E%A1%E7%82%B9%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%92%E5%AE%89%E5%AE%9A%E3%81%95%E3%81%9B%E3%82%8B\" aria-label=\"採点システムを安定させる permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>採点システムを安定させる</h3>\n<p>この手の競技イベントでもっとも大事なのは、<strong>採点システムが快適に利用できること</strong>だと思っています。採点が遅かったり、不安定だったりすると、参加者が競技に集中することが難しくなります。</p>\n<p>今回のイベントでは採点システムを安定させるために<strong>マシンリソースを増強させるだけで、採点が安定する</strong>ように注意して設計しました。具体的には下図の構成としました。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cf17e6c37691ed6ce8343ec893a78848/ed9a5/img_hidakkason_05.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAOABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAECBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHcmkMgs//EABcQAQEBAQAAAAAAAAAAAAAAAAABEDH/2gAIAQEAAQUCRMjr/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGBAAAgMAAAAAAAAAAAAAAAAAAAERICH/2gAIAQEABj8Crjg//8QAHBAAAgICAwAAAAAAAAAAAAAAAREAYRBRITHR/9oACAEBAAE/IfI3L3pYWz1EDuIkSWk//9oADAMBAAIAAwAAABAQH//EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAEDAQE/EFf/xAAXEQEAAwAAAAAAAAAAAAAAAAAAARFR/9oACAECAQE/EFRr/8QAHRABAQACAgMBAAAAAAAAAAAAAREAMSFRQWFxwf/aAAgBAQABPxCcaA9MoLwQXR+/c5De+pgRdiI6MAQBVYbcTAl0DP/Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"AIコンテストの構成\"\n        title=\"AIコンテストの構成\"\n        src=\"/static/cf17e6c37691ed6ce8343ec893a78848/4b190/img_hidakkason_05.jpg\"\n        srcset=\"/static/cf17e6c37691ed6ce8343ec893a78848/e07e9/img_hidakkason_05.jpg 200w,\n/static/cf17e6c37691ed6ce8343ec893a78848/066f9/img_hidakkason_05.jpg 400w,\n/static/cf17e6c37691ed6ce8343ec893a78848/4b190/img_hidakkason_05.jpg 800w,\n/static/cf17e6c37691ed6ce8343ec893a78848/ed9a5/img_hidakkason_05.jpg 940w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\"><p>AIコンテストの構成</p></figcaption>\n  </figure></p>\n<p>競技者がポータルサイトで解答となるソースコードを提出すると、ポータルサーバーはまずソースコードをデータベースに保存します。あわせてそのコードを採点するためのスコアサーバーとジャッジサーバーの起動をキックして（起動だけで実行終了を待つわけではありません）リクエストを閉じます。後述しますが、本システムはすべてKubernetes上で動作しており、スコアサーバーとジャッジサーバーはそれらを内包する1つのPodを事前に用意していて、そのPodを起動しています。</p>\n<p>スコアサーバーは、ソースコードを採点するためのテストケースをデータベースから読み取った後に、採点をジャッジサーバーにHTTPでリクエストします。\nただし、スコアサーバーはジャッジサーバーのヘルスチェックをおこない、実際に採点をおこなえるようになってから採点をリクエストします。\nリクエストを受けつけると、テストケースごとに競技のゲームを実行して、採点結果をHTTPレスポンスとして返却してプロセスが終了します。\nその結果をスコアサーバーが受け取ったのち、データベースに採点結果を書き込んで、スコアサーバーもプロセスを終了します。これが採点までの一連の流れになります。</p>\n<p>各々のサーバーはそれぞれDockerイメージで管理され、各イメージはKubernetesのPodとしてアプリケーションインスタンスが立ち上げられます。そのため、Kubernetesが立ち上がっている<strong>マシン・クラスターを増強するだけで採点をスケールさせることができるようになっています</strong>。</p>\n<p>この構成は、採点のためのジョブキュー・ジョブプール（ジャッジサーバーのプール管理）を作り込んでいないのもこのシステムの特徴となっています。もし何かしらの問題があって採点が正常に行われてない場合は、管理画面で未採点の提出に対してスコアサーバーをキックしたり、一括で採点しなおしたい場合はバッチスクリプトなどで一括でスコアサーバーをキックするだけです。</p>\n<p>この部分を作り込まない分、結果的に他の大事な実装に集中できたり、シンプルな設計なため当日の運営がかなり安定したと感じています。\nこの設計は当時新卒としてポータルサーバーの実装とインフラ構築・運用を手伝ってもらった2人の提案だったのですが（私の当初の構成ではここを作り込むつもりでした）、いざやってみて、かなり機転の利いた良い設計だったのではと個人的には思っています。</p>\n<p>余談ですが本来ジャッジサーバーはHTTPサーバーとして立ち上がる必要はまったくないのですが、当初ジャッジサーバーはその名の通りサーバーアプリケーションとして動作させる予定だったため、その名残が残っています。\nDockerイメージとして立ち上がった直後にジャッジサーバーは起動した状態で構築されているので、スコアサーバーはほぼCLIとしてジャッジサーバーを利用しています。</p>\n<p>これも結果として、<strong>ジャッジサーバーのメモリ管理をそこまで気にしなくて良くなり（都度起動し直すため、そこでメモリは一括で開放するからです。）</strong>、ジャッジサーバーの実装難易度を下げる要因になりました。</p>\n<h3 id=\"ゲーム開発キットとジャッジサーバーのゲームロジック共有\" style=\"position:relative;\"><a href=\"#%E3%82%B2%E3%83%BC%E3%83%A0%E9%96%8B%E7%99%BA%E3%82%AD%E3%83%83%E3%83%88%E3%81%A8%E3%82%B8%E3%83%A3%E3%83%83%E3%82%B8%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%AE%E3%82%B2%E3%83%BC%E3%83%A0%E3%83%AD%E3%82%B8%E3%83%83%E3%82%AF%E5%85%B1%E6%9C%89\" aria-label=\"ゲーム開発キットとジャッジサーバーのゲームロジック共有 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ゲーム開発キットとジャッジサーバーのゲームロジック共有</h3>\n<p>先述の通り、競技者がAI開発につかうゲーム開発キットはUnityで、ジャッジサーバーもC#で実装しています。</p>\n<p>この2つを同じC#で実装した目的としては、<strong>ゲームのロジックを同じものを利用するため</strong>です。</p>\n<p>それぞれ違う言語で開発すると、ゲームのロジックはゲーム仕様に合わせて各々独自実装になるため、ジャッジサーバーと開発キットの採点結果を確実に一致させることが難しくなります。\n(実際にはやれるとは思うのですが、ここに神経を尖らせながらイベントの各種開発や運営をしていくのはなかなか厳しいです。)</p>\n<p>ゲームロジック自体はジャッジサーバーと開発キットとは別プロジェクト（csproj上、別）に切り出して開発しました。開発キットにはdllを、ジャッジサーバーはそのプロジェクトを参照しています。</p>\n<p>プロジェクトは複数ですが、gitレポジトリ上は1レポジトリで管理し、下記のようにディレクトリを切って管理しました。それぞれ<code>client</code>が開発キットで、<code>judge-server</code>がジャッジサーバー、<code>logic</code>がゲームロジックのプロジェクトとなります。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">.\n├── README.md\n├── cloudbuild.yaml\n├── cloudbuild_prod.yaml\n├── hidakkathon-2019-client.sln\n└── src\n    ├── client\n    │   ├── Assets\n    │   ├── Packages\n    │   └── ProjectSettings\n    ├── judge-server\n    │   ├── Dockerfile\n    │   ├── README.md\n    │   ├── judge-server.csproj\n    │   └── src\n    └── logic \n        ├── src\n        └── logic.csproj</code></pre></div>\n<p>ゲームロジックプロジェクトの<code>logic.csproj</code>は、下記のようにとてもシンプルです。</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Project</span> <span class=\"token attr-name\">Sdk</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Microsoft.NET.Sdk<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>OutputType</span><span class=\"token punctuation\">></span></span>Library<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>OutputType</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TargetFramework</span><span class=\"token punctuation\">></span></span>netstandard2.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TargetFramework</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>GenerateDocumentationFile</span><span class=\"token punctuation\">></span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>GenerateDocumentationFile</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Project</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>dll出力を行いたいので<code>OutputType</code>は<code>Library</code>を指定しています。Unityがdllを利用するために<code>TargetFramework</code>は <a href=\"https://docs.microsoft.com/ja-jp/dotnet/standard/net-standard\">.NET Standard</a>を参考に<code>netstandard2.0</code>を指定しました。</p>\n<p>また、競技者がdll内に入ったクラスや構造体の実装をRiderやVisual Studioで確認する際にドキュメントがそのまま残っているほうが親切であろうと判断し、<a href=\"https://docs.microsoft.com/ja-jp/dotnet/csharp/codedoc\">XML コメントを含むコードの文書化</a>を参考に<code>GenerateDocumentationFile</code>を<code>true</code>に指定しました。</p>\n<p>ジャッジサーバーのプロジェクトもゲームロジックのAPIを利用するため、<code>logic.csproj</code>を参照する必要があります。ただし、dllを参照する必要はないので、プロジェクトを直接参照しています。ジャッジサーバーのプロジェクト<code>judge-server.csproj</code>\b（の一部）は下記のとおりです。</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Project</span> <span class=\"token attr-name\">Sdk</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Microsoft.NET.Sdk<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>OutputType</span><span class=\"token punctuation\">></span></span>Exe<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>OutputType</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TargetFramework</span><span class=\"token punctuation\">></span></span>netcoreapp3.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TargetFramework</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RootNamespace</span><span class=\"token punctuation\">></span></span>Hidakkathon.Server<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>RootNamespace</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">></span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ItemGroup</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ProjectReference</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>..\\logic\\logic.csproj<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ItemGroup</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Project</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>具体的には<code>ProjectReference</code>プロパティで、<code>logic.csproj</code>を相対パスで参照しています。\n<code>TargetFramework</code>は、ジャッジサーバーで比較的新しい機能を利用したかったため、<code>netcoreapp3.0</code>としました（現在では少し古いですが、社内イベントの開催は今年の2月で、その当時の最新を利用しました）。</p>\n<p>余談ですが、dllは難読化するべきかは検討したのですが、デコンパイルしてコードを復元したところで想定解がわかるようなものでもなかったので見送りました。</p>\n<h2 id=\"コードの採点方法\" style=\"position:relative;\"><a href=\"#%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E6%8E%A1%E7%82%B9%E6%96%B9%E6%B3%95\" aria-label=\"コードの採点方法 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>コードの採点方法</h2>\n<p>競技者のコードを採点する際\bに受け取ったC#のソースコードを、ジャッジサーバー上で動的にコンパイルして、コンパイルしたクラスを<code>PlayerBrain</code>クラスのインスタンスとして扱い、ゲームを実行します。</p>\n<p>動的にコンパイルを行う方法は、先日書いた<a href=\"https://blog.yucchiy.com/2020/11/csharp-compile-sourcecode-runtime/\">C#でソースをランタイムでコンパイルし、実行する</a>で詳細を記載しています。具体的にはソースコードを動的にコンパイルして<code>PlayerBrain</code>クラスを生成する<code>PlayerBrainGenerator</code>の実装の一部は下記のとおりです。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">System</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Collections<span class=\"token punctuation\">.</span>Generic</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>IO</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Reflection</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Runtime<span class=\"token punctuation\">.</span>Loader</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Text</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>CodeAnalysis</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>CodeAnalysis<span class=\"token punctuation\">.</span>CSharp</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PlayerBrainGenerator</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IDisposable</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token function\">PlayerBrainGenerator</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CSharpCompilationOptions</span> compilationOptions<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _compilation <span class=\"token operator\">=</span> CSharpCompilation<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span><span class=\"token punctuation\">(</span>\n            Path<span class=\"token punctuation\">.</span><span class=\"token function\">GetRandomFileName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token named-parameter punctuation\">options</span><span class=\"token punctuation\">:</span> compilationOptions\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">AddDefaultReference</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> references <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span>MetadataReference<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> assemblyPath <span class=\"token operator\">=</span> Path<span class=\"token punctuation\">.</span><span class=\"token function\">GetDirectoryName</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\"><span class=\"token keyword\">object</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Assembly<span class=\"token punctuation\">.</span>Location<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 必要な分リファレンスを追加する</span>\n        references<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>MetadataReference<span class=\"token punctuation\">.</span><span class=\"token function\">CreateFromFile</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">assemblyPath</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">/System.dll\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        references<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>MetadataReference<span class=\"token punctuation\">.</span><span class=\"token function\">CreateFromFile</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">assemblyPath</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">/mscorlib.dll\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        references<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>MetadataReference<span class=\"token punctuation\">.</span><span class=\"token function\">CreateFromFile</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">assemblyPath</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">/netstandard.dll\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// ...</span>\n\n        _compilation <span class=\"token operator\">=</span> _compilation<span class=\"token punctuation\">.</span><span class=\"token function\">AddReferences</span><span class=\"token punctuation\">(</span>references<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">/// &lt;summary></span>\n    <span class=\"token comment\">/// ソースを追加する(複数追加可能)</span>\n    <span class=\"token comment\">/// &lt;/summary></span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">AddSourceCode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> path<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> sourceCode<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> syntaxTree <span class=\"token operator\">=</span> CSharpSyntaxTree<span class=\"token punctuation\">.</span><span class=\"token function\">ParseText</span><span class=\"token punctuation\">(</span>\n            sourceCode<span class=\"token punctuation\">,</span>\n            <span class=\"token named-parameter punctuation\">options</span><span class=\"token punctuation\">:</span> CSharpParseOptions<span class=\"token punctuation\">.</span>Default<span class=\"token punctuation\">,</span>\n            path\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        _compilation <span class=\"token operator\">=</span> _compilation<span class=\"token punctuation\">.</span><span class=\"token function\">AddSyntaxTrees</span><span class=\"token punctuation\">(</span>syntaxTree<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">/// &lt;summary></span>\n    <span class=\"token comment\">/// コンパイルを実施してアセンブリを生成する</span>\n    <span class=\"token comment\">/// &lt;/summary></span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Compile</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">out</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> message<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> messageBuilder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">StringBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">using</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> dllStream <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">MemoryStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> emitResult <span class=\"token operator\">=</span> _compilation<span class=\"token punctuation\">.</span><span class=\"token function\">Emit</span><span class=\"token punctuation\">(</span>dllStream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> diagnostic <span class=\"token keyword\">in</span> emitResult<span class=\"token punctuation\">.</span>Diagnostics<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> pos <span class=\"token operator\">=</span> diagnostic<span class=\"token punctuation\">.</span>Location<span class=\"token punctuation\">.</span><span class=\"token function\">GetLineSpan</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> location <span class=\"token operator\">=</span> <span class=\"token string\">\"(\"</span> <span class=\"token operator\">+</span> pos<span class=\"token punctuation\">.</span>Path <span class=\"token operator\">+</span> <span class=\"token string\">\"@Line\"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>pos<span class=\"token punctuation\">.</span>StartLinePosition<span class=\"token punctuation\">.</span>Line <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\":\"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>pos<span class=\"token punctuation\">.</span>StartLinePosition<span class=\"token punctuation\">.</span>Character <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\")\"</span><span class=\"token punctuation\">;</span>\n                messageBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">AppendLine</span><span class=\"token punctuation\">(</span>\n                    <span class=\"token interpolation-string\"><span class=\"token string\">$\"[</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">diagnostic<span class=\"token punctuation\">.</span>Severity</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">, </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">location</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">] </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">diagnostic<span class=\"token punctuation\">.</span>Id</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">, </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">diagnostic<span class=\"token punctuation\">.</span><span class=\"token function\">GetMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>emitResult<span class=\"token punctuation\">.</span>Success<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// コンパイル失敗</span>\n                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">FailedToCompileException</span><span class=\"token punctuation\">(</span>messageBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            dllStream<span class=\"token punctuation\">.</span><span class=\"token function\">Seek</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> SeekOrigin<span class=\"token punctuation\">.</span>Begin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            _assembly <span class=\"token operator\">=</span> AssemblyLoadContext<span class=\"token punctuation\">.</span>Default<span class=\"token punctuation\">.</span><span class=\"token function\">LoadFromStream</span><span class=\"token punctuation\">(</span>dllStream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        message <span class=\"token operator\">=</span> messageBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">/// &lt;summary></span>\n    <span class=\"token comment\">/// コンパイル済みのアセンブリから、ブレインクラスのインスタンスを取得する</span>\n    <span class=\"token comment\">/// &lt;/summary></span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">T</span> <span class=\"token generic-method\"><span class=\"token function\">CreateBrain</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>T<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> fullName<span class=\"token punctuation\">)</span> <span class=\"token keyword\">where</span> <span class=\"token class-name\">T</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token keyword\">class</span></span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>_assembly <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">InvalidOperationException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"アセンブリがまだ生成されていません\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> type <span class=\"token operator\">=</span> _assembly<span class=\"token punctuation\">.</span><span class=\"token function\">GetType</span><span class=\"token punctuation\">(</span>fullName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>type <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> Activator<span class=\"token punctuation\">.</span><span class=\"token function\">CreateInstance</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> assembly <span class=\"token keyword\">in</span> AppDomain<span class=\"token punctuation\">.</span>CurrentDomain<span class=\"token punctuation\">.</span><span class=\"token function\">GetAssemblies</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            type <span class=\"token operator\">=</span> assembly<span class=\"token punctuation\">.</span><span class=\"token function\">GetType</span><span class=\"token punctuation\">(</span>fullName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>type <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">return</span> Activator<span class=\"token punctuation\">.</span><span class=\"token function\">CreateInstance</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token class-name\">T</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">fullName</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">に該当するクラスが存在しません\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">CSharpCompilation</span> _compilation <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Assembly</span> _assembly <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>上記のクラスを利用して、下記のようにインスタンスを生成します。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> generator <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">PlayerBrainGenerator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ngenerator<span class=\"token punctuation\">.</span><span class=\"token function\">AddDefaultReference</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> sourceCode <span class=\"token keyword\">in</span> task<span class=\"token punctuation\">.</span>sourceCodes<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// FilePathがコードのファイルパスで、</span>\n    <span class=\"token comment\">// Contentにソースコードそのものが格納されているとする</span>\n    generator<span class=\"token punctuation\">.</span><span class=\"token function\">AddUserSource</span><span class=\"token punctuation\">(</span>\n        sourceCode<span class=\"token punctuation\">.</span>FilePath<span class=\"token punctuation\">,</span>\n        sourceCode<span class=\"token punctuation\">.</span>Content\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// コンパイルする。</span>\n<span class=\"token comment\">// 失敗すると例外を吐くので外でキャッチする。</span>\ngenerator<span class=\"token punctuation\">.</span><span class=\"token function\">CompileUserSource</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">out</span> <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 課題は複数題用意されている。</span>\n<span class=\"token comment\">// 競技者にはこの課題はこのクラス名で</span>\n<span class=\"token comment\">// 実装するという取り決めをしている。</span>\n<span class=\"token comment\">// そのクラス名がBrainNameに入っているとする。</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> brain <span class=\"token operator\">=</span> generator\n    <span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">CreateBrain</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>PlayerBrain<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">.</span>BrainName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// ...</span>\n\n<span class=\"token comment\">// ゲーム内で競技者の次の1手を取得するときは</span>\n<span class=\"token comment\">// 下記のようにコマンドを得る</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> command <span class=\"token operator\">=</span> brain<span class=\"token punctuation\">.</span><span class=\"token function\">Think</span><span class=\"token punctuation\">(</span>environment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>C#では、C#のソースコードをスクリプトとして実行する方法もあるのですが、今回は上記のようにソースコードを動的にコンパイルし、かつ<code>PlayerBrain</code>クラスのインスタンスとしてリフレクションなしで実行することで<strong>競技者のローカル実行とジャッジサーバーでのリモート実行の差異をできるだけ無くすように</strong>気をつけました。</p>\n<p>またジャッジサーバーは、.NET Coreで作成したアプリのためUnityのAPIが利用できません。そのため今回の競技ではAIの実装にUnityのAPIの利用は禁止しました。\nただし、<code>UnityEngine.Debug.Log</code>などによるプリントデバッグは多いだろう（そしてそれを消し忘れて提出してしまいコンパイルエラーとなるストレスが多いだろう）と想定し、<code>UnityEngine.Debug</code>配下のメソッドなどの呼び出しは許可としました。\n内部的には、ジャッジサーバー上では下記のような<code>UnityEngine.Debug</code>のスタブ実装（といっても中身は空）を差し込むことで、コンパイルエラーとならないようにしました。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">namespace</span> <span class=\"token namespace\">UnityEngine</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Debug</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// stub for https://docs.unity3d.com/2018.4/Documentation/ScriptReference/Debug.html</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">object</span></span> message<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">object</span></span> message<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// ...つづく...</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>UnityのAPIが利用できないのは、ヘッドレスでUnityを実行するための実行環境を構築するコストや、そもそも台数を増やして実行するときのライセンスなど、システム的な要因が大きいです。 ですが今回はこの要因を逆手に取って、こういうイベントをきっかけに <strong>「このAPIが使いたかったらどのように実装するんだろう？」と考えてほしかったり</strong> 、またUnityをメインで使っていないプロジェクトもあるため、<strong>関わっているプロジェクトの開発環境による有利不利を減らすため</strong>に、さらに、サーバーサイドの方にもぜひ参加してほしかったため、UnityのAPIの利用を禁止しました（実際数人参加していただきました。また、上位に食い込む方もおられました）。</p>\n<h2 id=\"開発補助運用のツール類について\" style=\"position:relative;\"><a href=\"#%E9%96%8B%E7%99%BA%E8%A3%9C%E5%8A%A9%E9%81%8B%E7%94%A8%E3%81%AE%E3%83%84%E3%83%BC%E3%83%AB%E9%A1%9E%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"開発補助運用のツール類について permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>開発補助・運用のツール類について</h2>\n<p>開発キットとジャッジサーバーはC#で開発したので、テストケースや問題文などのマスタデータを作成するツールだったり、テストケースや想定解法を一括でテストするためのツール（レポーター）も基本C#で実装しました。\nそれぞれ下記のツールを利用しました。</p>\n<ul>\n<li><a href=\"https://github.com/commandlineparser/commandline\">CommandLineParser</a>\n<ul>\n<li>CLIの実装に利用。</li>\n</ul>\n</li>\n<li><a href=\"https://github.com/neuecc/Utf8Json\">Utf8Json</a>\n<ul>\n<li>JSONのシリアライズ・デシリアライズに利用。</li>\n</ul>\n</li>\n<li><a href=\"https://joshclose.github.io/CsvHelper/\">CSVHelper</a>\n<ul>\n<li>ポータルサイトのデータをCSVで管理していたため書き出しに利用。</li>\n</ul>\n</li>\n<li><a href=\"https://github.com/lunet-io/markdig\">Markdig</a>\n<ul>\n<li>問題文はMarkdownで書いていたので、サイト掲載のために、HTML変換するために利用。</li>\n</ul>\n</li>\n<li><a href=\"https://github.com/mono/SkiaSharp\">SkiaSharp</a>\n<ul>\n<li>GoogleのSkia(Graphics Library)のC#ラッパー。テストケースから盤面を出力する際に利用。</li>\n</ul>\n</li>\n<li><a href=\"https://github.com/mono/t4\">Mono.TextTemplating(T4)</a>\n<ul>\n<li>テンプレートエンジン。主に問題文の生成に利用。</li>\n<li>参考: <a href=\"https://blog.yucchiy.com/2019/12/t4-template-engine-with-dotnet/\">.NET CoreでのT4の利用と、実行時テキスト生成の挙動を追ってみる</a></li>\n</ul>\n</li>\n</ul>\n<p>これを実装した当時は、C#でCLI実装をほとんどやったことがなかったのですが、いざやってみるとライブラリはかなり充実していると感じました。</p>\n<p>強いていうと画像を扱うライブラリを選定する際に、公式ライブラリの歴史があまりわからず少し苦戦したのですが、Twitterで<a href=\"https://twitter.com/neuecc/status/1196583415732064257\">フィードバックをいただいたり</a>、<a href=\"https://www.hanselman.com/blog/how-do-you-use-systemdrawing-in-net-core\">こちらの記事</a>を参考にしてSkiaSharpとしました。</p>\n<p>開発キットやジャッジサーバーをすべてC#で作ったので、C#で実装されているツール類もそれらのAPIを直接利用でき、開発コストを下げることができました。\nたとえば、テストケースや想定解法のテストツールであるレポーターの実装の際、下記のようにジャッジサーバーをC#レベルでそのまま利用できました。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token comment\">// System.Net.Http.HttpClient</span>\n<span class=\"token keyword\">using</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">HttpClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// サーバーを実際に起動してリクエストを待つ</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> server <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">JudgeServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> serverTask <span class=\"token operator\">=</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// JudgeJob.JudgeJobRequestはジャッジサーバー側の</span>\n    <span class=\"token comment\">// リクエストクラスをそのまま利用。</span>\n    <span class=\"token comment\">// (ツール用に再定義必要なし)</span>\n    <span class=\"token comment\">// requestはそのデータ。</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> requestString <span class=\"token operator\">=</span> Encoding<span class=\"token punctuation\">.</span>UTF8<span class=\"token punctuation\">.</span><span class=\"token function\">GetString</span><span class=\"token punctuation\">(</span>\n        Utf8Json<span class=\"token punctuation\">.</span>JsonSerializer<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Serialize</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>JudgeJob<span class=\"token punctuation\">.</span>JudgeJobRequest<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>\n            request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> content <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">StringContent</span><span class=\"token punctuation\">(</span>\n        requestString<span class=\"token punctuation\">,</span>\n        Encoding<span class=\"token punctuation\">.</span>UTF8\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// サーバーにリクエストするタスクを生成</span>\n    <span class=\"token comment\">// judgeUrlはジャッジサーバーのURL</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> httpClientTask <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">PostAsync</span><span class=\"token punctuation\">(</span>\n        judgeUrl<span class=\"token punctuation\">,</span>\n        content\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// レスポンス待ち</span>\n    httpClientTask<span class=\"token punctuation\">.</span><span class=\"token function\">Wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// レスポンスを読み込む</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> receivingResponseTask <span class=\"token operator\">=</span> httpClientTask<span class=\"token punctuation\">.</span>Result<span class=\"token punctuation\">.</span>Content<span class=\"token punctuation\">.</span><span class=\"token function\">ReadAsStringAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    receivingResponseTask<span class=\"token punctuation\">.</span><span class=\"token function\">Wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// レスポンスをJSONに変換</span>\n    <span class=\"token comment\">// JudgeJob.JudgeJobResponseもジャッジサーバー側の</span>\n    <span class=\"token comment\">// レスポンスデータをそのまま利用</span>\n    <span class=\"token comment\">// (ツール用に再定義必要なし)</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> response <span class=\"token operator\">=</span> Utf8Json<span class=\"token punctuation\">.</span>JsonSerializer<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Deserialize</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>\n        JudgeJob<span class=\"token punctuation\">.</span>JudgeJobResponse<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>receivingResponseTask<span class=\"token punctuation\">.</span>Result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>上記のように、<strong>ジャッジサーバーをそのままC#レベルで利用したり</strong>、リクエスト・レスポンスクラスもジャッジサーバーで定義した型をレポーターがそのまま利用したり、とくにツール類についてはすでにあるものを使いまわして実装することができたので、実装コストを抑えることができたと思います。</p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>ゲームAIを題材とした社内イベントの、主にクライアントと採点側の設計および実装について紹介しました。</p>\n<p><strong>実装言語を統一することでムダな実装を省き</strong>、少ない期間・手数で社内イベントの実装・運営をクオリティ高く行えたのではないかと自負しています。</p>\n<p>開発キットと採点サーバーでロジックを共有する方法や動的なC#ソースコードのコンパイルと実行、採点サーバーの安定化、ツール類の実装と内容はバラバラですが、少しでも参考になれば幸いです。</p>","excerpt":"この記事はApplibot Advent Calendar 2020およびCyberAgent Developers Advent Calendar 2020の10日目の記事です。\n昨日はkbt_さんの個人とチームの習慣化についてとTomomatsu YutaさんのTableauのダッシュボードの限界を引き上げる拡張機能の紹介でした。 この記事では、社内のエンジニア向けイベントのヒダッカソンで開催したゲームAI…","fields":{"slug":"/articles/2020/12/advent-calendar-intern/"},"frontmatter":{"date":"December 09, 2020","type":null,"tags":["Advent Calendar","C#","Unity"],"title":"社内イベント・インターンのゲームAIコンテストの裏側について解説","description":null,"eyecatch":null}}},"pageContext":{"id":"4cae26b2-d53f-5f13-837d-39e786fefca0"}},"staticQueryHashes":["1480509143","3159585216"]}