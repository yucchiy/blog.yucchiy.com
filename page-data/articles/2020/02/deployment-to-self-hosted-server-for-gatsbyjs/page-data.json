{"componentChunkName":"component---src-templates-post-tsx","path":"/articles/2020/02/deployment-to-self-hosted-server-for-gatsbyjs/","result":{"data":{"markdownRemark":{"html":"<p><a href=\"https://blog.yucchiy.com/\">Yucchiy's Note</a>は2019/02/13時点で、<a href=\"https://www.gatsbyjs.org/\">Gatsby.js</a>で作成していて、sakura VPSに立ち上げたサーバー上でホストしています。</p>\n<p>このブログを<a href=\"https://help.github.com/en/actions\">Github Actions</a>を用いてサーバーにデプロイしてみます。</p>\n<p>ただし下記を前提とします。</p>\n<ul>\n<li>サーバーに対して公開鍵認証でSSHができる</li>\n<li>サーバー上ではnginxが構築されている(nginxである必要はないが)</li>\n<li>レポジトリ直下にGatsby.jsコンテンツが配置されている(<code>package.json</code>などが直下に配置されている)</li>\n</ul>\n<h2 id=\"workflow-fileの作成\" style=\"position:relative;\"><a href=\"#workflow-file%E3%81%AE%E4%BD%9C%E6%88%90\" aria-label=\"workflow fileの作成 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>workflow fileの作成</h2>\n<p>Github Actionsを設定するためには、まずworkflow fileと呼ばれるファイルを<code>.github/workflows</code>ディレクトリ以下に作成する必要があります。このディレクトリ下に<code>.yml</code>または<code>.yaml</code>拡張子でファイルを配置したものをworkflow fileとして認識します。</p>\n<p>今回、デプロイ設定を記述するworkflow fileは<code>.github/workflow/deployment.yml</code>で作成します。このファイルは下記の処理を行います。</p>\n<ol>\n<li>Gatsby.jsを動作させるためにNode.jsを利用できるようにする</li>\n<li>Gatsby.jsを動かしてブログをビルドする</li>\n<li>2.で作成した成果物をサーバーにrsyncで配信する</li>\n<li>Slackにデプロイ通知をする</li>\n</ol>\n<p>早速ですが、上記の処理を行う<code>.github/workflow/deployment.yml</code>は以下となります。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deployment for blog\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> master\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">build-deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Use Node.js $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> matrix.node<span class=\"token punctuation\">-</span>version <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v1\n      <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> 10.x\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Cache dependencies\n      <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/cache@v1\n      <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> ~/.npm\n        <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> runner.os <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>node<span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> hashFiles('<span class=\"token important\">**/package-lock.json')</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">restore-keys</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          ${{ runner.os }}-node-</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm install\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm run build <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>if<span class=\"token punctuation\">-</span>present\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> deploy to server\n      <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> AEnterprise/rsync<span class=\"token punctuation\">-</span>deploy@v1.0\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">DEPLOY_KEY</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.SERVER_SSH_KEY <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">ARGS</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"-avzr --delete\"</span>\n        <span class=\"token key atrule\">SERVER_PORT</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.SERVER_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">FOLDER</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"./public/\"</span>\n        <span class=\"token key atrule\">SERVER_IP</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.SERVER_IP <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">USERNAME</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.USERNAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">SERVER_DESTINATION</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.SERVER_DESTINATION <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Slack Notification\n      <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> rtCamp/action<span class=\"token punctuation\">-</span>slack<span class=\"token punctuation\">-</span>notify@v2.0.0\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">SLACK_WEBHOOK</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.SLACK_WEBHOOK <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"ワークフローのトリガーイベントの設定\" style=\"position:relative;\"><a href=\"#%E3%83%AF%E3%83%BC%E3%82%AF%E3%83%95%E3%83%AD%E3%83%BC%E3%81%AE%E3%83%88%E3%83%AA%E3%82%AC%E3%83%BC%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%81%AE%E8%A8%AD%E5%AE%9A\" aria-label=\"ワークフローのトリガーイベントの設定 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ワークフローのトリガーイベントの設定</h2>\n<p>まず、このワークフローの名前とワークフローの呼び出しトリガーとなるイベントを設定します。該当箇所を抜粋すると以下のとおりです。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># このワークフローの名前</span>\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deployment for blog\n\n<span class=\"token comment\"># トリガーは、`on:`で記述</span>\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> master</code></pre></div>\n<p>ワークフロー名は<code>Deployment for blog</code>とし、<code>master</code>にプッシュされたタイミングでこのワークフローを実行しています。\nちなみにイベントは複数指定できますし、<code>branchs</code>を省く事もできます。その時は全てのプッシュイベントに対してワークフローが呼び出されます。</p>\n<p>詳細は<a href=\"https://help.github.com/en/actions/reference/events-that-trigger-workflows#webhook-events\">Events that trigger workflows - GitHub Actions / Reference</a>に記載されています。\n<a href=\"https://help.github.com/en/actions/reference/events-that-trigger-workflows#scheduled-events-schedule\">スケジュールジョブ</a>を実行することもできますし<a href=\"https://help.github.com/en/actions/reference/events-that-trigger-workflows#external-events-repository_dispatch\">外部からWebHook経由でイベントを実行</a>することもできそうです。また、<a href=\"https://help.github.com/en/actions/reference/events-that-trigger-workflows#webhook-events\">レポジトリに対しての各種イベントのハンドリング</a>も簡単そうです。</p>\n<h2 id=\"ジョブを記述する\" style=\"position:relative;\"><a href=\"#%E3%82%B8%E3%83%A7%E3%83%96%E3%82%92%E8%A8%98%E8%BF%B0%E3%81%99%E3%82%8B\" aria-label=\"ジョブを記述する permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ジョブを記述する</h2>\n<p>このワークフローでやることを書きます。<code>job</code>の<code>steps</code>に順繰り処理の内容を書いていきます。まずはそのジョブの環境を下記のように記載します。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># build-deployというジョブを記述する。複数定義すると並列に動く?</span>\n  <span class=\"token key atrule\">build-deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># ジョブはubuntu-latest上で実行される</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token comment\"># ここからジョブの内容を記載していきます。書いてあることが上から順次実行されます。</span>\n    steps<span class=\"token punctuation\">:</span></code></pre></div>\n<p>ここから<code>steps</code>項目以下に処理について説明していきます。</p>\n<h3 id=\"nodejsのセットアップ\" style=\"position:relative;\"><a href=\"#nodejs%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97\" aria-label=\"nodejsのセットアップ permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Node.jsのセットアップ</h3>\n<p>Gatsby.jsの動作にはNode.jsが必要です。下記のように記述します。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Use Node.js $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> matrix.node<span class=\"token punctuation\">-</span>version <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v1\n      <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> 10.x\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Cache dependencies\n      <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/cache@v1\n      <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> ~/.npm\n        <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> runner.os <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>node<span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> hashFiles('<span class=\"token important\">**/package-lock.json')</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">restore-keys</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          ${{ runner.os }}-node-</span></code></pre></div>\n<p>やっていることとしては、<code>10.x</code>のNode.jsを利用できるようにしています。\nまた、<code>package-lock.json</code>ファイルが同じ内容なら<code>~/.npm</code>ディレクトリをキャッシュすることで、パッケージのインストールを高速化しようとしています。</p>\n<h3 id=\"gatsbyjsでブログをビルドする\" style=\"position:relative;\"><a href=\"#gatsbyjs%E3%81%A7%E3%83%96%E3%83%AD%E3%82%B0%E3%82%92%E3%83%93%E3%83%AB%E3%83%89%E3%81%99%E3%82%8B\" aria-label=\"gatsbyjsでブログをビルドする permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gatsby.jsでブログをビルドする</h3>\n<p>配信するためのhtmlやcss、jsなどの成果物をGatsby.jsでビルドします。手順は下記のとおりです。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm install\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm run build <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>if<span class=\"token punctuation\">-</span>present</code></pre></div>\n<p>特に難しいことはしてないのですが<code>npm install</code>してパッケージをインストール後、<code>npm run build</code>でGatsby.jsによるビルドを実施しています。ここまで成功すると<code>./public</code>に成果物が生成されます。\nここをカスタマイズするとjs製の静的サイトジェネレーターでも応用が効くかもしれません。</p>\n<h3 id=\"rsyncでサーバーに成果物をデプロイする\" style=\"position:relative;\"><a href=\"#rsync%E3%81%A7%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%AB%E6%88%90%E6%9E%9C%E7%89%A9%E3%82%92%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%99%E3%82%8B\" aria-label=\"rsyncでサーバーに成果物をデプロイする permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>rsyncでサーバーに成果物をデプロイする</h3>\n<p>デプロイって言っても<code>rsync</code>コマンドでコピーしているだけなんですが。\n<a href=\"https://github.com/marketplace\">Marketplace</a>から探してきた<a href=\"https://github.com/marketplace/actions/deploy-with-rsync\">Deploy with rsync</a>経由でrsyncを叩いています。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> deploy to server\n      <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> AEnterprise/rsync<span class=\"token punctuation\">-</span>deploy@v1.0\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">DEPLOY_KEY</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.SERVER_SSH_KEY <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">ARGS</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"-avzr --delete\"</span>\n        <span class=\"token key atrule\">SERVER_PORT</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.SERVER_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">FOLDER</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"./public/\"</span>\n        <span class=\"token key atrule\">SERVER_IP</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.SERVER_IP <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">USERNAME</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.USERNAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">SERVER_DESTINATION</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.SERVER_DESTINATION <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>注意点として(ってほどでもなく当然やるべきなんですが)、秘密鍵情報などセキュリティの観点から秘密にするべき情報は<a href=\"https://help.github.com/en/actions/configuring-and-managing-workflows/creating-and-storing-encrypted-secrets\">Secrets</a>を用いてを隠しています。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/58c1825e424f6a1e50409d4773200311/00d43/secrets.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 63.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABo0lEQVQ4y41S23IsIQic///O7M5lL6Oi4gXslM6cPclDsqGKokBpm5aJfIAPEdYROCXsxsGRR4gMYwkUIp7Gjrzf7W7JHz3WYd9mmNuCUitKFUw2VKgqRASttQG6rCtSynhnrQENhx95wzTvBT7JKPdCSgnrusIYAyKCtfYV993AOYJzDuQ9YoxgjogxjL5uA7CIDrD+YoyM63XGtm7Ythuu84xlWTEvCz4uF6zbhnlecL/fB6ihhMgJ2vQ/IGcdDFUbqghcILhIMN6CmcGchhSReTDp+YgpwydFqQrhNGSbPh4ZN1tBLEPLztTXiHB6eyn0s6kI/G5RSsG0GIENAtFDww66s0Uocah91L54+x77uVSBf+wouWBanwQTKnLt7HQAuuxB2Z+6/u7/GMbdopaKyRDjpHKyUFAOg2GReqzGG9CunTfuGHm9W1BgcCqInCGiMMnhyRZc02u/fvSTYbg/UfvIlxvhZhJykbHtoopYeTCsKi8dfx9ZERwdI782/jzs8RENKB+fon/QcYz8PD9loOHLa9rgomL3Ai76fuT2vfcTPmD6KQIMlf4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Secrets\"\n        title=\"Secrets\"\n        src=\"/static/58c1825e424f6a1e50409d4773200311/5a190/secrets.png\"\n        srcset=\"/static/58c1825e424f6a1e50409d4773200311/772e8/secrets.png 200w,\n/static/58c1825e424f6a1e50409d4773200311/e17e5/secrets.png 400w,\n/static/58c1825e424f6a1e50409d4773200311/5a190/secrets.png 800w,\n/static/58c1825e424f6a1e50409d4773200311/00d43/secrets.png 1000w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\"><p>Secrets</p></figcaption>\n  </figure></p>\n<p>設定はレポジトリ単位で行え、「Settings > Secrets」でアクセスするか <code>https://github.com/{username}/{repository}/settings/secrets</code>でアクセスできます。設定したSecretは、<code>${{ secrets.設定した名前 }}</code>でアクセスできます。</p>\n<p><em>あと、rsyncの引数はちょっと自信がないです...</em></p>\n<h3 id=\"slack通知を送る\" style=\"position:relative;\"><a href=\"#slack%E9%80%9A%E7%9F%A5%E3%82%92%E9%80%81%E3%82%8B\" aria-label=\"slack通知を送る permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Slack通知を送る</h3>\n<p>最後に成功したら今どきっぽく(?)Slackで通知します。Marketplaceの<a href=\"https://github.com/marketplace/actions/slack-notify\">Slack Notify</a>を利用しています。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Slack Notification\n      <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> rtCamp/action<span class=\"token punctuation\">-</span>slack<span class=\"token punctuation\">-</span>notify@v2.0.0\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">SLACK_WEBHOOK</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.SLACK_WEBHOOK <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"動作確認\" style=\"position:relative;\"><a href=\"#%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D\" aria-label=\"動作確認 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>動作確認</h2>\n<p>メニューの「Actions」にアクセスすることで下記のようにGitHub Actionsの動作状況を確認できます。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/94dad1921f15eafd8b48d80621d053a2/0f529/check-actions.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABOUlEQVQoz32Qy07DMBBF8/OIHQv2/AUseAipG7bdINjTJCp1nFfj2DN+XGSnaakaGOlqZhLrzJ3JvNVAYAAOCBbOMlTfoJEC+0GBmEHE0IZgiGGIUs3WwjkP63zKs7K71TduXyrcPElcP+xwdb9DURNGNUAbg7MI4VcZsBTZ26fA87rE43qL13eJ1UeNem8SbFAaajQYxikbssmlNpNiTWzTd00Mtg7Z0pQQPLY7gU1eQlR1Wm8/EmRvwGzTmlER0HY91Kin9SPQhwDvJ7mDYlRSIi9KdF2femIH0Sow83Gw9x5N08IcThP7LN7iQgCElCiKEm3bpceaLKoDcH6XgG2XzjP3/wAr5HlxBBpyi8D431p7cnh5wCmJqsLXJj9zKP5weAa8cOd9yhG4yQtorSeHfHI4z11y+APHUbuFjonNuwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"check github actions\"\n        title=\"check github actions\"\n        src=\"/static/94dad1921f15eafd8b48d80621d053a2/5a190/check-actions.png\"\n        srcset=\"/static/94dad1921f15eafd8b48d80621d053a2/772e8/check-actions.png 200w,\n/static/94dad1921f15eafd8b48d80621d053a2/e17e5/check-actions.png 400w,\n/static/94dad1921f15eafd8b48d80621d053a2/5a190/check-actions.png 800w,\n/static/94dad1921f15eafd8b48d80621d053a2/c1b63/check-actions.png 1200w,\n/static/94dad1921f15eafd8b48d80621d053a2/0f529/check-actions.png 1259w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\"><p>check github actions</p></figcaption>\n  </figure></p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>Gatsby.jsで構築したブログの自動デプロイをGitHub Actionsで構築しました。</p>\n<p>軽い気持ちでGitHub Actionsを触ってみましたが、(当然ですが)GitHub単体で(CircleCIとか連携せずに)CI回せるのはとても楽だなっていうのと、<a href=\"https://help.github.com/en/actions/reference/events-that-trigger-workflows#webhook-events\">GitHubのイベントのハンドリングがとても簡単なため</a>、今まで外部のサーバーにWebHook飛ばしたりして処理してたものをGitHub上で完結できそうでとても楽そうです。</p>\n<p>あと<a href=\"https://help.github.com/en/actions/hosting-your-own-runners\">Self-hosted runners</a>に少し心が惹かれています。</p>\n<h2 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h2>\n<ul>\n<li><a href=\"https://nehalist.io/building-and-deploying-gatsby-sites-with-github-actions/\">Building and deploying Gatsby sites with GitHub actions</a></li>\n<li><a href=\"https://qiita.com/peaceiris/items/2f6d83802f2aefa66f9d\">Gatsby のサイトを GitHub Actions で GitHub Pages にデプロイ - Qiita</a></li>\n</ul>","excerpt":"Yucchiy's Noteは2019/02/13時点で、Gatsby.jsで作成していて、sakura VPSに立ち上げたサーバー上でホストしています。 このブログをGithub Actionsを用いてサーバーにデプロイしてみます。 ただし下記を前提とします。 サーバーに対して公開鍵認証でSSHができる サーバー上ではnginxが構築されている(nginxである必要はないが) レポジトリ直下にGatsby.jsコンテンツが配置されている(package.json…","fields":{"slug":"/articles/2020/02/deployment-to-self-hosted-server-for-gatsbyjs/"},"frontmatter":{"date":"February 13, 2020","type":null,"tags":["Gatsby.js","Github Actions","Server","JavaScript"],"title":"Gatsby.js製ブログをセルフホストしているサーバーにデプロイする","description":null,"eyecatch":null}}},"pageContext":{"id":"c1c534a8-504d-5cc6-9242-c5a7de3548df"}},"staticQueryHashes":["1480509143","3159585216"]}