{"componentChunkName":"component---src-templates-post-tsx","path":"/articles/2020/02/i-want-to-know-about-il/","result":{"data":{"markdownRemark":{"html":"<p>とあるコードレビューでこんなレビューをいただきました。</p>\n<blockquote>\n<p>public int Hoge { get => _hoge; } 的なラムダ呼び出しは、毎フレーム呼び出される前提なら\nGC.Allocが気になるのでpublic int Hoge { get => { return _hoge; } } で最適化したい</p>\n</blockquote>\n<p>だいたいこんな感じ。自分の認識では前者はGC.Alloc発生する余地がないだろうといいつつ、これがたしかにラムダ呼び出しだとGC.Alloc発生する可能性がある？ と思いつつ。\n自信がなかったのでこの構文がどういう処理をするのだろうと気になったので、ILでも吐いて見て調べてみるかーと思い、調査してみました。</p>\n<p>簡単のため、下記のコードをベースに進めます。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">UnityEngine</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Test</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">MonoBehaviour</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _hoge <span class=\"token operator\">=</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span>\n        _fuga <span class=\"token operator\">=</span> <span class=\"token number\">200</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> hoge <span class=\"token operator\">=</span> Hoge<span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> fuga <span class=\"token operator\">=</span> Fuga<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> Hoge <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span> <span class=\"token operator\">=></span> _hoge<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> Fuga <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> _fuga<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> _hoge<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> _fuga<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"まずプロファイラをみてるみる\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%9A%E3%83%97%E3%83%AD%E3%83%95%E3%82%A1%E3%82%A4%E3%83%A9%E3%82%92%E3%81%BF%E3%81%A6%E3%82%8B%E3%81%BF%E3%82%8B\" aria-label=\"まずプロファイラをみてるみる permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まずプロファイラをみてるみる</h2>\n<p>とはいってもGC.Allocだけを知りたければ計測すれば分かる話なので、まずはプロファイラで確認してみます。ちなみにUnity 2019.3.0.f3で確認しています。</p>\n<p>上記のコンポーネントだけをシーンに配置したシーンを用意し、Profiler WindowでDeep Profileにてアロケーションを確認してみます。</p>\n<p>結果が下記画像です。<code>Assembly-CSharp.dll!::Test.get_Hoge()</code>が今回調べたい箇所ですが、<code>GC Alloc</code>項は<code>0B</code>なのでアロケーション自体は発生してなさそうです。ちなみに指摘にあった方も同時に確認していますが、こちらもアロケーションは発生してなさそうです。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/563fad355580b641837aef70c4ba96d5/2130b/profiling.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABzklEQVQoz22NS07jQBBAfRnsuLq6u/pnJ/5AEicQZjREMyzmMqy5BlmyQF5yAFC2iOtEtlQjdyQWM7N4elVPpe6kXXaPxrrXNE1fELFXiD0A9EKISJZlkakRUa+U6vM879M0PZOl/cVF+qKtfK0DPibL5dVHXdfsnGMBwDCbsYCchYAzAHEHyJlIs9aaIc//AeO9+JgefF+tVlyW5WmGcswEjqDNCEqPICdUnHOpR2VsZGpC0ygURYOiEyjNWQ7vyWKxOBYhMBkzyus9i90vxu+/Gad5c8dye8dqarf3LJqOcXnDefeD8+0+GrZ7lrf3o7z5yXmzOSZFWR7n8zk770fnPWuiCBnLmky0dY6NtdOnsaFUDEJ8oYlGqTWjUsekCf6469a869bj5rLlhXdcBc9tWXBTBC5Ix1YHH/epT60wdDZpDqTHMN0ZOiaVwrd1teBvq+Xpum2GqzIMtTNDG9zQeDeUWg6VpaF2dmi8jT1IHAqJ0XFWeCoU8gLhLSmL8Nmt17zpOr5sW3bGcOE9B+/YO8daSraG2FnL3lkO3rNC/C8oxGdijHmo6vq5qqqnpm0PRVkeNNGBjIkWiAep1EFr/dVBiL95AiGeAcTDH1FlC4AuKDP4AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Testのプロファイル結果\"\n        title=\"Testのプロファイル結果\"\n        src=\"/static/563fad355580b641837aef70c4ba96d5/5a190/profiling.png\"\n        srcset=\"/static/563fad355580b641837aef70c4ba96d5/772e8/profiling.png 200w,\n/static/563fad355580b641837aef70c4ba96d5/e17e5/profiling.png 400w,\n/static/563fad355580b641837aef70c4ba96d5/5a190/profiling.png 800w,\n/static/563fad355580b641837aef70c4ba96d5/c1b63/profiling.png 1200w,\n/static/563fad355580b641837aef70c4ba96d5/2130b/profiling.png 1271w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\"><p>Testのプロファイル結果</p></figcaption>\n  </figure></p>\n<p>ちなみに前者は<a href=\"https://ufcpp.net/study/csharp/oo_property.html#expression-bodied\">expression-bodied なプロパティ</a>と呼ばれ、プロパティを本体が式形式でかける構文です（ので、これでアロケーションが都度発生することはないだろう、と自分の中の認識でした）。</p>\n<h2 id=\"ilで処理を調べてみる\" style=\"position:relative;\"><a href=\"#il%E3%81%A7%E5%87%A6%E7%90%86%E3%82%92%E8%AA%BF%E3%81%B9%E3%81%A6%E3%81%BF%E3%82%8B\" aria-label=\"ilで処理を調べてみる permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ILで処理を調べてみる</h2>\n<p>では、これらがそれぞれILレベルでどういう処理になってるか調べてみます。今回は<a href=\"https://sharplab.io/\">SharpLab</a>でILを吐いて調べてみました。下記の画像のように左側のテキストボックスにコードを貼ると、右側にILを吐いてくれます。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0b26ad84300594b9bf9d3011b188a2c1/7a4b2/sharplab.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB60lEQVQoz32SW2vVQBSF8/9/gihKQShin0SpaBUEqS/6oj5oLafHk+tMkpOZyUySyeWTpLdzLO0eFhtmr732ZSZ48bHi4K3k8FPJm28Nh5/dgtdfG46+OF6eusXPsaNTzfMPFY9e5Tw5Fjx9J3n2vuDxccbBieTke0cwOkdf1mghsbrkQRstttKIC0H45xfhxW+SzTmrsx+szn5S64JgmCZMXbNe/0XIHN95+s7j2+7SNx3e9/h+YKsrEpkTCclGRMQio1IapQ1KGbQ2BEM/0NgOU1uMrqkrjVMKby1D29LPE3jPzFNCk6cFSZQukGmOKxqm4XaIYO6ojErW0YrN6hxnGmSRM07TDWmazzShak0oQ1KTsnUVutGM47jErhE0TUNrHVUl2VbyttQVYfZz0myta8hTRZ45vO+WeNu2l7wlZSIYhmFv77vVdom976m2FbIoSFOJLCQilyit9vJuBPeFuCM48yqpyBJBmIRESUyaZdiyYeiGux3+39mu4PXIpjZs4hChcmpf0w4t4zTucYO+7x8UXDBe7tF1lqJUJHGFtgrnHcaa5dHu3eF9tows1PJtpMgpiy2l2GK3jsENTP1Vh3Vd45zDWrv4XSx31mGdxRiDLuZ/mBNvYpJNQrxOCC8isjgjSzKEEPwDBZiZTaUJozgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"SharpLabでILを解析している様子\"\n        title=\"SharpLabでILを解析している様子\"\n        src=\"/static/0b26ad84300594b9bf9d3011b188a2c1/5a190/sharplab.png\"\n        srcset=\"/static/0b26ad84300594b9bf9d3011b188a2c1/772e8/sharplab.png 200w,\n/static/0b26ad84300594b9bf9d3011b188a2c1/e17e5/sharplab.png 400w,\n/static/0b26ad84300594b9bf9d3011b188a2c1/5a190/sharplab.png 800w,\n/static/0b26ad84300594b9bf9d3011b188a2c1/c1b63/sharplab.png 1200w,\n/static/0b26ad84300594b9bf9d3011b188a2c1/7a4b2/sharplab.png 1240w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\"><p>SharpLabでILを解析している様子</p></figcaption>\n  </figure></p>\n<p>SharpLabでは<code>UnityEngine</code>がないので、かわりに下記のコードを解析します。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">System</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Program</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _hoge <span class=\"token operator\">=</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span>\n        _fuga <span class=\"token operator\">=</span> <span class=\"token number\">200</span><span class=\"token punctuation\">;</span>\n        \n        Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"Hoge = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">Hoge</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">, Fuga = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">Fuga</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> Hoge <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span> <span class=\"token operator\">=></span> _hoge<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> Fuga <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> _fuga<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> _hoge<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> _fuga<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ちなみにILは<code>Release</code>で吐き出します。結果は以下のとおり。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">.class private auto ansi '&lt;Module>'\n{\n} // end of class &lt;Module>\n\n.class public auto ansi beforefieldinit Program\n    extends [System.Private.CoreLib]System.Object\n{\n    // Fields\n    .field private int32 _hoge\n    .field private int32 _fuga\n\n    // Methods\n    .method public hidebysig \n        instance void Main () cil managed \n    {\n        // Method begins at RVA 0x2050\n        // Code size 57 (0x39)\n        .maxstack 8\n\n        IL_0000: ldarg.0\n        IL_0001: ldc.i4.s 100\n        IL_0003: stfld int32 Program::_hoge\n        IL_0008: ldarg.0\n        IL_0009: ldc.i4 200\n        IL_000e: stfld int32 Program::_fuga\n        IL_0013: ldstr \"Hoge = {0}, Fuga = {1}\"\n        IL_0018: ldarg.0\n        IL_0019: call instance int32 Program::get_Hoge()\n        IL_001e: box [System.Private.CoreLib]System.Int32\n        IL_0023: ldarg.0\n        IL_0024: call instance int32 Program::get_Fuga()\n        IL_0029: box [System.Private.CoreLib]System.Int32\n        IL_002e: call string [System.Private.CoreLib]System.String::Format(string, object, object)\n        IL_0033: call void [System.Console]System.Console::WriteLine(string)\n        IL_0038: ret\n    } // end of method Program::Main\n\n    .method public hidebysig specialname \n        instance int32 get_Hoge () cil managed \n    {\n        // Method begins at RVA 0x208a\n        // Code size 7 (0x7)\n        .maxstack 8\n\n        IL_0000: ldarg.0\n        IL_0001: ldfld int32 Program::_hoge\n        IL_0006: ret\n    } // end of method Program::get_Hoge\n\n    .method public hidebysig specialname \n        instance int32 get_Fuga () cil managed \n    {\n        // Method begins at RVA 0x2092\n        // Code size 7 (0x7)\n        .maxstack 8\n\n        IL_0000: ldarg.0\n        IL_0001: ldfld int32 Program::_fuga\n        IL_0006: ret\n    } // end of method Program::get_Fuga\n\n    .method public hidebysig specialname rtspecialname \n        instance void .ctor () cil managed \n    {\n        // Method begins at RVA 0x209a\n        // Code size 7 (0x7)\n        .maxstack 8\n\n        IL_0000: ldarg.0\n        IL_0001: call instance void [System.Private.CoreLib]System.Object::.ctor()\n        IL_0006: ret\n    } // end of method Program::.ctor\n\n    // Properties\n    .property instance int32 Hoge()\n    {\n        .get instance int32 Program::get_Hoge()\n    }\n    .property instance int32 Fuga()\n    {\n        .get instance int32 Program::get_Fuga()\n    }\n\n} // end of class Program</code></pre></div>\n<p>今回の興味の対象となる<code>Hoge</code>プロパティの処理は下記の通り（それぞれ抜粋）。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">    // Fields\n    .field private int32 _hoge\n\n    .method public hidebysig specialname \n        instance int32 get_Hoge () cil managed \n    {\n        // Method begins at RVA 0x208a\n        // Code size 7 (0x7)\n        .maxstack 8\n\n        IL_0000: ldarg.0\n        IL_0001: ldfld int32 Program::_hoge\n        IL_0006: ret\n    } // end of method Program::get_Hoge\n\n    // Properties\n    .property instance int32 Hoge()\n    {\n        .get instance int32 Program::get_Hoge()\n    }</code></pre></div>\n<p>ILについて素人なのですが、なんとなく <code>get_Hoge()</code> メソッドが定義されていて処理が下記なのかなとわかります。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">    IL_0000: ldarg.0                    // ??\n    IL_0001: ldfld int32 Program::_hoge  // [Program::_hoge]\n    IL_0006: ret                        // []</code></pre></div>\n<p>頭で<code>idarg.0</code>やっている理由がわからないのですが（引数なしなのにこれ必要？）、<code>ldfld int32 Program::_hoge</code>で<code>_hoge</code>を<code>int</code>でスタックに詰んで、<code>ret</code>でメソッド抜け出して、戻り値としてスタックに積んだ<code>Program::_hoge</code>を返却してるのかな、と。\n<code>Fuga</code>プロパティの方も同じ処理となっていて、２つはまったく同じ処理を行っていることがわかりました。</p>\n<h2 id=\"ilを直書きしてみる\" style=\"position:relative;\"><a href=\"#il%E3%82%92%E7%9B%B4%E6%9B%B8%E3%81%8D%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\" aria-label=\"ilを直書きしてみる permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ILを直書きしてみる</h2>\n<p>上記の件はこれにて解決したんですが、ILみてていろいろ興味が湧いたので帰りの電車で調べてたんですが、<a href=\"https://twitter.com/neuecc\">@neuecc</a>さんの<a href=\"http://neue.cc/2017/12/04_560.html\">Introduction to the pragmatic IL via C#</a>を見ててILをC#から直書きもできるんだってことを知って、なにこれ面白いなーと思って見ていました。あまりILに関わる機会がなかったので知らなかったんですが、このブログの</p>\n<blockquote>\n<p>IL生成をしない汎用的なコードだとリフレクションが必要なものですが、IL生成によってそれを避ける、つまり「リフレクションを高速にするもの」状態です。また、高速化のポイントとしてはルックアップを最小に抑える、というのが挙げられます。</p>\n</blockquote>\n<p>という箇所を読んで、なるほどそんなに黒魔術とかというより手段の１つとして知っておくと良さそうという印象を持ちました。</p>\n<p>ちなみにIL直書きもそこまで難しくなく、例えばILで書いたメソッドをC#で使う場合は<a href=\"https://docs.microsoft.com/en-us/dotnet/api/system.reflection.emit.dynamicmethod?view=netframework-4.8\"><code>System.Reflection.EmitDynamicMethod</code></a>を用いて、ILをツラツラとかく感じでいけます。例えば２引数を受け取って足し算をするメソッドは下記のようにかけます。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">System</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Reflection<span class=\"token punctuation\">.</span>Emit</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Program</span>\n<span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> dm <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">DynamicMethod</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MySum\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\"><span class=\"token keyword\">int</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\"><span class=\"token keyword\">int</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\"><span class=\"token keyword\">int</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> il <span class=\"token operator\">=</span> dm<span class=\"token punctuation\">.</span><span class=\"token function\">GetILGenerator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\n\t\til<span class=\"token punctuation\">.</span><span class=\"token function\">Emit</span><span class=\"token punctuation\">(</span>OpCodes<span class=\"token punctuation\">.</span>Ldarg_0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// [a]       第１引数をスタックに詰む</span>\n\t\til<span class=\"token punctuation\">.</span><span class=\"token function\">Emit</span><span class=\"token punctuation\">(</span>OpCodes<span class=\"token punctuation\">.</span>Ldarg_1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// [a, b]    第２引数をスタックに詰む</span>\n\t\til<span class=\"token punctuation\">.</span><span class=\"token function\">Emit</span><span class=\"token punctuation\">(</span>OpCodes<span class=\"token punctuation\">.</span>Add<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">// [(a + b)] スタックに詰んだ２つの値を足す</span>\n\t\til<span class=\"token punctuation\">.</span><span class=\"token function\">Emit</span><span class=\"token punctuation\">(</span>OpCodes<span class=\"token punctuation\">.</span>Ret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">// []        メソッド終了して戻り値を返す</span>\n\t\t\n\t\t<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> mySum <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>Func<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span>dm<span class=\"token punctuation\">.</span><span class=\"token function\">CreateDelegate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\">Func<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tConsole<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"MySum(2, 3) = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\"><span class=\"token function\">mySum</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>まぁこれだと単純すぎてよくわからんて感じですが、IL入門としては悪くないんじゃないかと。</p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>expression-bodied なプロパティとフィールドを返すだけのプロパティをILレベルで処理を比較してみました。実際どのような処理になっていてなにが問題なのか調べる手段として、または最適化の手段としてILを知っておけるといいなと感じました。</p>\n<p>ちなみにILの知識自体はないに等しいため、本文中でなにか不備等があれば <a href=\"https://twitter.com/yucchiy_\">@yucchiy_</a>にてご連絡いただけると幸いです。あと、ILでこういうの面白いよーとかもぜひ。</p>","excerpt":"とあるコードレビューでこんなレビューをいただきました。 public int Hoge { get => _hoge; } 的なラムダ呼び出しは、毎フレーム呼び出される前提なら\nGC.Allocが気になるのでpublic int Hoge { get => { return _hoge; } } で最適化したい だいたいこんな感じ。自分の認識では前者はGC.Alloc発生する余地がないだろうといいつつ、これがたしかにラムダ呼び出しだとGC.Alloc…","fields":{"slug":"/articles/2020/02/i-want-to-know-about-il/"},"frontmatter":{"date":"February 18, 2020","type":null,"tags":["C#","IL"],"title":"どういう処理をしてるかを知りたくて簡単にILに触れてみた件","description":null,"eyecatch":null}}},"pageContext":{"id":"ba065f93-4b49-55b6-aef9-5f40a64d4cf6"}},"staticQueryHashes":["1480509143","3159585216"]}