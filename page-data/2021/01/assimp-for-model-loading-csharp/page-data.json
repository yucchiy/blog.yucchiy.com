{"componentChunkName":"component---src-templates-post-tsx","path":"/2021/01/assimp-for-model-loading-csharp/","result":{"data":{"markdownRemark":{"html":"<p>この記事ではAssimpの概要と、C#でAssimpを利用することができるAssimpNetの紹介、そして実際にモデルをロードする方法を紹介します。</p>\n<p>AssimpNetを扱ったモデルロードについては、この後いくつかのトピックを連載したいと思います。この記事は「Vol1. Assimp概要とモデルロード編」という立ち位置となります。</p>\n<h2 id=\"assimpとは\" style=\"position:relative;\"><a href=\"#assimp%E3%81%A8%E3%81%AF\" aria-label=\"assimpとは permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assimpとは</h2>\n<p><a href=\"https://github.com/assimp/assimp\">assimp/assimp: The official Open-Asset-Importer-Library Repository. Loads 40+ 3D-file-formats into one unified and clean data structure.</a></p>\n<p>Assimpはオープンソースの3Dフォーマットファイルのインポートライブラリです。Assimp自体はOpen-Asset-Importer-Libraryの略称のようです。（たぶんOpen-<strong>Ass</strong>et-<strong>Imp</strong>orter-Libraryからとっている）</p>\n<p>3Dモデルを扱うファイルフォーマットは様々な種類があり（といっても自分はゲーム関係のことぐらいしかわからないですが...）、またその表現方法も多様です。</p>\n<p>Assimpは、複数のファイルフォーマットを読み込み、それらのデータをゲーム開発のシナリオにおいて扱いやすいような独自のデータ表現としてインポートする機能を提供します。\nまた、インポートしたデータに対して様々な後処理（座標系の変換やインデックス付きメッシュへの変換、法線や接線の計算など）が用意されています。</p>\n<p>これによりアプリケーションをAssimpがサポートするファイルフォーマットのロードを簡単に実装することができます。</p>\n<p>また、Assimpのデータを各種3Dモデルファイルにエクスポートすることも可能です。</p>\n<h2 id=\"assimpnetの導入\" style=\"position:relative;\"><a href=\"#assimpnet%E3%81%AE%E5%B0%8E%E5%85%A5\" aria-label=\"assimpnetの導入 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AssimpNetの導入</h2>\n<p>OpenTK（C#でOpenGLを扱うライブラリ）でAssimpを用いてモデルを描画することを考えます。</p>\n<p>C#では<a href=\"https://www.nuget.org/packages/AssimpNet/\">AssimpNet</a>を用いると簡単にAssimpを利用することができます。</p>\n<p><a href=\"https://www.nuget.org/packages/AssimpNet/\">NuGet Gallery | AssimpNet 4.1.0</a></p>\n<p>AssimpNetはAssimpのC#ラッパーライブラリです。P/Invoke経由でAssimpのC-APIをコールすることでその機能を利用します。</p>\n<p>AssimpNetはNuGetでインストールできます。プロジェクト下で下記のコマンドを実行することでインストールできます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ dotnet add package AssimpNet --version 4.1.0</code></pre></div>\n<p>ちなみにAssimpNetのバージョンは原則Assimpのバージョンと一致しているようです。このブログを執筆時(2021/01/27)に最新版は4.1.0で、ベータ版として5.0.0をサポートしています。</p>\n<h2 id=\"assimpnetを用いてモデルをロードする\" style=\"position:relative;\"><a href=\"#assimpnet%E3%82%92%E7%94%A8%E3%81%84%E3%81%A6%E3%83%A2%E3%83%87%E3%83%AB%E3%82%92%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B\" aria-label=\"assimpnetを用いてモデルをロードする permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AssimpNetを用いてモデルをロードする</h2>\n<p>それでは実際にモデルをロードしてみます。読み込み自体は下記のコードで実現できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token comment\">// このファイルパスは読み込みたいモデルのファイルパス</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> filepath <span class=\"token operator\">=</span> <span class=\"token string\">\"/path/to/teapot.obj\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> importer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">AssimpContext</span><span class=\"token punctuation\">(</span>filepath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> scene <span class=\"token operator\">=</span> importer<span class=\"token punctuation\">.</span><span class=\"token function\">ImportFile</span><span class=\"token punctuation\">(</span>filepath<span class=\"token punctuation\">,</span>\n    PostProcessSteps<span class=\"token punctuation\">.</span>CalculateTangentSpace <span class=\"token operator\">|</span>\n    PostProcessSteps<span class=\"token punctuation\">.</span>GenerateSmoothNormals <span class=\"token operator\">|</span>\n    PostProcessSteps<span class=\"token punctuation\">.</span>JoinIdenticalVertices <span class=\"token operator\">|</span>\n    PostProcessSteps<span class=\"token punctuation\">.</span>LimitBoneWeights <span class=\"token operator\">|</span>\n    PostProcessSteps<span class=\"token punctuation\">.</span>RemoveRedundantMaterials <span class=\"token operator\">|</span>\n    PostProcessSteps<span class=\"token punctuation\">.</span>SplitLargeMeshes <span class=\"token operator\">|</span>\n    PostProcessSteps<span class=\"token punctuation\">.</span>Triangulate <span class=\"token operator\">|</span>\n    PostProcessSteps<span class=\"token punctuation\">.</span>GenerateUVCoords <span class=\"token operator\">|</span>\n    PostProcessSteps<span class=\"token punctuation\">.</span>SortByPrimitiveType <span class=\"token operator\">|</span>\n    PostProcessSteps<span class=\"token punctuation\">.</span>FindDegenerates <span class=\"token operator\">|</span>\n    PostProcessSteps<span class=\"token punctuation\">.</span>FindInvalidData\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>モデルのロード自体ははとても簡単で、<code>AssimpContext</code>をインスタンス化し、<code>ImportFile</code>を呼び出すだけです。\nちなみに<a href=\"https://bitbucket.org/Starnick/assimpnet/src/6fb9a0d01123b2ddfb18feec502bcc3bdfa593d2/AssimpNet/AssimpContext.cs#lines-256\"><code>ImportFile</code></a>はファイルパスを渡しますが、ストリームから読み込む<a href=\"https://bitbucket.org/Starnick/assimpnet/src/6fb9a0d01123b2ddfb18feec502bcc3bdfa593d2/AssimpNet/AssimpContext.cs#lines-191\"><code>ImportFileFromStream</code></a>が存在します。</p>\n<p><code>ImportFile</code>の第2引数には後処理の一覧を渡します。後処理一覧は<a href=\"https://bitbucket.org/Starnick/assimpnet/src/6fb9a0d01123b2ddfb18feec502bcc3bdfa593d2/AssimpNet/Enums.cs#lines-74\"><code>PostProcessSteps</code>という列挙型で定義されます</a>。\nただし後処理の一覧を列挙するのは大変なので、<a href=\"https://bitbucket.org/Starnick/assimpnet/src/master/AssimpNet/PostProcessPreset.cs\"><code>PostProcessPreset</code>というプリセットクラス</a>が定義されています。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token comment\">// PostProcessPresetを用いて上記の処理をよりシンプルに記述する</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> scene <span class=\"token operator\">=</span> importer<span class=\"token punctuation\">.</span><span class=\"token function\">ImportFile</span><span class=\"token punctuation\">(</span>filepath<span class=\"token punctuation\">,</span> PostProcessPreset<span class=\"token punctuation\">.</span>TargetRealTimeQuality<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>後述しますが、多くのグラフィックスAPIでメッシュを描画するときは三角形で扱いたいが多いため、メッシュのFaceを三角形に変換する<code>PostProcessSteps.Trianglate</code>を指定したほうが良いです。</p>\n<h2 id=\"読み込んだモデルを描画する\" style=\"position:relative;\"><a href=\"#%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%93%E3%81%A0%E3%83%A2%E3%83%87%E3%83%AB%E3%82%92%E6%8F%8F%E7%94%BB%E3%81%99%E3%82%8B\" aria-label=\"読み込んだモデルを描画する permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>読み込んだモデルを描画する</h2>\n<p>今回は読み込んだモデルのうち、頂点と頂点インデックス、法線情報を用いてモデルを描画してみます。(正しい描画を行うにはマテリアル情報やテクスチャが必要になりますが、それは次の記事で。)</p>\n<h3 id=\"sceneクラスとmeshクラス\" style=\"position:relative;\"><a href=\"#scene%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%A8mesh%E3%82%AF%E3%83%A9%E3%82%B9\" aria-label=\"sceneクラスとmeshクラス permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SceneクラスとMeshクラス</h3>\n<p><code>ImportFile</code>によって返却される戻り値は<code>Scene</code>クラスのインスタンスです。</p>\n<p>「直接モデルクラスを返さないのか？」と疑問に思う方もおられるかもしれませんが、例えばBlenderやMayaで制作したアニメーションやカメラワーク、ライト情報をfbxとしてエクスポートして、それをゲーム内に取り込んで利用するといったケースもあります。\nつまり、いくつかの3Dフォーマットファイルは<strong>モデルだけでなく、そのモデルをどのように表示するのか</strong>、などの情報を含めることができるよう汎用的に作られてるものもあるので、シーンという1段抽象的なデータ表現をしているのではないかと考えられます。</p>\n<p><a href=\"https://bitbucket.org/Starnick/assimpnet/src/1eef562da794e681ad7cd4b9f6f1d47766ae0ffa/AssimpNet/Scene.cs?at=release%2F4.1.0\"><code>Scene</code>クラス</a>には、読み込んだデータが<code>Meshes</code>や<code>Materials</code>など用途ごとにプロパティに格納されています。また、そのデータがファイル上に存在したかどうかという<code>HasXXX</code>プロパティであわせて用意されています。</p>\n<p><code>Meshes</code>は<a href=\"https://bitbucket.org/Starnick/assimpnet/src/1eef562da794e681ad7cd4b9f6f1d47766ae0ffa/AssimpNet/Mesh.cs?at=release%2F4.1.0\"><code>Mesh</code></a>クラスのインスタンスがリスト形式で格納されています。</p>\n<p>それぞれのメッシュには面(<code>Faces</code>)や法線(<code>Normals</code>)、UV情報(<code>TextureCoordinateChannels</code>)、利用するマテリアルのインデックス(<code>MaterialIndex</code>)、頂点情報(<code>Vertices</code>)など様々な情報が格納されています。</p>\n<h3 id=\"assimpの3dのデータ表現について\" style=\"position:relative;\"><a href=\"#assimp%E3%81%AE3d%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E8%A1%A8%E7%8F%BE%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"assimpの3dのデータ表現について permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assimpの3Dのデータ表現について</h3>\n<p><a href=\"https://assimp-docs.readthedocs.io/en/latest/usage/use_the_lib.html#data-structures\">Importing Data — Asset-Importer-Lib December 2020 documentation</a></p>\n<p>頂点を扱う前に、Assimpの3Dのデータ表現について触れておきます。</p>\n<p>Assimpはモデルをロードする際に、デフォルトではOpenGLと同様に<strong>右手座標系</strong>で頂点情報を表現しています。つまり、+Xは右方向、+Yは上方向、+Zはスクリーンに対して手前方向になります。\nただしDirectXなどでも扱いやすいように、後処理で<code>PostProcessSteps.MakeLeftHanded</code>を指定することで左手座標系に変換して読み込むオプションもサポートしています。</p>\n<p>また、面の向きは下記の通りデフォルトでは**反時計回り(Counter ClockWise: CCW)**が表向きになります。これも時計回りにしたければ、<code>PostProcessSteps.FlipWindingOrder</code>で切り替えることができます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">x2\n\n            x1\n    x0</code></pre></div>\n<p>最後に(ここでは利用しませんが)テクスチャのUV座標系は<strong>左下が原点</strong>です。こちらも<code>PostProcessSteps.FlipUVs</code>で左上原点に切り替えることができます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">0x|1y ---------- 1x|1y\n |                |\n |                |\n |                |\n0x|0y ---------- 1x|0y</code></pre></div>\n<h3 id=\"メッシュの描画\" style=\"position:relative;\"><a href=\"#%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E6%8F%8F%E7%94%BB\" aria-label=\"メッシュの描画 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>メッシュの描画</h3>\n<p>シーンにはメッシュが複数個存在するので、下記の実装をメッシュ個分行うことで描画します。</p>\n<p>まずはMeshクラスから頂点と法線、頂点インデックスを取得し、GPUに転送まで行います。</p>\n<p>また、描画時のプリミティブは<code>PrimitiveType.Triangles</code>で行うものとします。<code>PrimitiveType.Triangles</code>で描画を行うためには、頂点インデックスの配列から3つずつ、それぞれ三角形を形成する必要があります。\nそのような頂点インデックスを作るには、<code>ImportFile</code>の後処理に<code>PostProcessSteps.Trianglate</code>を指定します。</p>\n<p>ちなみに頂点座標は<code>Mesh.Vertices</code>に、法線は<code>Mesh.Normals</code>プロパティに格納されています。頂点インデックスは<code>Mesh.GetUnsignedIndices()</code>メソッドで計算できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token comment\">// mesh: Assimp.Mesh</span>\n\n<span class=\"token comment\">// positionsに頂点座標を[x0, y0, z0, x1, x2, ...]という配置で格納する</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> positions <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\"><span class=\"token keyword\">float</span></span><span class=\"token punctuation\">[</span>mesh<span class=\"token punctuation\">.</span>Vertices<span class=\"token punctuation\">.</span>Count <span class=\"token operator\">*</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> vertexIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> vertexIndex <span class=\"token operator\">&lt;</span> mesh<span class=\"token punctuation\">.</span>Vertices<span class=\"token punctuation\">.</span>Count<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>vertexIndex<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> vertex <span class=\"token operator\">=</span> mesh<span class=\"token punctuation\">.</span>Vertices<span class=\"token punctuation\">[</span>vertexIndex<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    positions<span class=\"token punctuation\">[</span><span class=\"token number\">3</span> <span class=\"token operator\">*</span> vertexIndex <span class=\"token operator\">+</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> vertex<span class=\"token punctuation\">.</span>X<span class=\"token punctuation\">;</span>\n    positions<span class=\"token punctuation\">[</span><span class=\"token number\">3</span> <span class=\"token operator\">*</span> vertexIndex <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> vertex<span class=\"token punctuation\">.</span>Y<span class=\"token punctuation\">;</span>\n    positions<span class=\"token punctuation\">[</span><span class=\"token number\">3</span> <span class=\"token operator\">*</span> vertexIndex <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> vertex<span class=\"token punctuation\">.</span>Z<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// positionと同様に[x0, y0, z0, x1, x2, ...]という配置で格納する</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> normals <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\"><span class=\"token keyword\">float</span></span><span class=\"token punctuation\">[</span>mesh<span class=\"token punctuation\">.</span>Normals<span class=\"token punctuation\">.</span>Count <span class=\"token operator\">*</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> normalIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> normalIndex <span class=\"token operator\">&lt;</span> mesh<span class=\"token punctuation\">.</span>Normals<span class=\"token punctuation\">.</span>Count<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>normalIndex<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> normal <span class=\"token operator\">=</span> mesh<span class=\"token punctuation\">.</span>Normals<span class=\"token punctuation\">[</span>normalIndex<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    normals<span class=\"token punctuation\">[</span><span class=\"token number\">3</span> <span class=\"token operator\">*</span> normalIndex <span class=\"token operator\">+</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> normal<span class=\"token punctuation\">.</span>X<span class=\"token punctuation\">;</span>\n    normals<span class=\"token punctuation\">[</span><span class=\"token number\">3</span> <span class=\"token operator\">*</span> normalIndex <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> normal<span class=\"token punctuation\">.</span>Y<span class=\"token punctuation\">;</span>\n    normals<span class=\"token punctuation\">[</span><span class=\"token number\">3</span> <span class=\"token operator\">*</span> normalIndex <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> normal<span class=\"token punctuation\">.</span>Z<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 頂点インデックスの取得</span>\n<span class=\"token comment\">// PostProcessSteps.Trianglateを指定している場合、</span>\n<span class=\"token comment\">// この頂点インデックスは三角形となる</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> indicies <span class=\"token operator\">=</span> mesh<span class=\"token punctuation\">.</span><span class=\"token function\">GetUnsignedIndices</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 頂点を格納するバッファ</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> buffers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\"><span class=\"token keyword\">int</span></span><span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">GenBuffers</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> buffers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 頂点座標をGPUに転送</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">BindBuffer</span><span class=\"token punctuation\">(</span>BufferTarget<span class=\"token punctuation\">.</span>ArrayBuffer<span class=\"token punctuation\">,</span> buffers<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">BufferData</span><span class=\"token punctuation\">(</span>BufferTarget<span class=\"token punctuation\">.</span>ArrayBuffer<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span> <span class=\"token operator\">*</span> positions<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">,</span> positions<span class=\"token punctuation\">,</span> BufferUsageHint<span class=\"token punctuation\">.</span>StaticDraw<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 法線をGPUに転送</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">BindBuffer</span><span class=\"token punctuation\">(</span>BufferTarget<span class=\"token punctuation\">.</span>ArrayBuffer<span class=\"token punctuation\">,</span> buffers<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">BufferData</span><span class=\"token punctuation\">(</span>BufferTarget<span class=\"token punctuation\">.</span>ArrayBuffer<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span> <span class=\"token operator\">*</span> normals<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">,</span> normals<span class=\"token punctuation\">,</span> BufferUsageHint<span class=\"token punctuation\">.</span>StaticDraw<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// バッファを紐付け解除</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">BindBuffer</span><span class=\"token punctuation\">(</span>BufferTarget<span class=\"token punctuation\">.</span>ArrayBuffer<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 頂点インデックスをGPUに転送</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">BindBuffer</span><span class=\"token punctuation\">(</span>BufferTarget<span class=\"token punctuation\">.</span>ElementArrayBuffer<span class=\"token punctuation\">,</span> buffers<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">BufferData</span><span class=\"token punctuation\">(</span>BufferTarget<span class=\"token punctuation\">.</span>ElementArrayBuffer<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span> <span class=\"token operator\">*</span> indices<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">,</span> indices<span class=\"token punctuation\">,</span> BufferUsageHint<span class=\"token punctuation\">.</span>StaticDraw<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// バッファを紐付け解除</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">BindBuffer</span><span class=\"token punctuation\">(</span>BufferTarget<span class=\"token punctuation\">.</span>ElementArrayBuffer<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 頂点配列</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> vertexArrays <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\"><span class=\"token keyword\">int</span></span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">GenVertexArrays</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> vertexArrays<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">BindVertexArray</span><span class=\"token punctuation\">(</span>vertexArrays<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 頂点座標の頂点属性設定。シェーダでlayout(location = 0)を指定していると想定</span>\n<span class=\"token keyword\">const</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> VertexLocation <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">EnableVertexAttribArray</span><span class=\"token punctuation\">(</span>VertexLocation<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">VertexAttribPointer</span><span class=\"token punctuation\">(</span>\n    VertexLocation<span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> VertexAttribPointerType<span class=\"token punctuation\">.</span>Float<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 法線の頂点属性設定。シェーダでlayout(location = 1)を指定していると想定</span>\n<span class=\"token keyword\">const</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> NormalLocation <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">EnableVertexAttribArray</span><span class=\"token punctuation\">(</span>NormalLocation<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">VertexAttribPointer</span><span class=\"token punctuation\">(</span>\n    NormalLocation<span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> VertexAttribPointerType<span class=\"token punctuation\">.</span>Float<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">EnableVertexAttribArray</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">BindVertexArray</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>あとは、上記で生成したバッファと頂点配列を用いて描画を行います。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token comment\">// ...この手前で、gl.UserProgramを呼んで、該当のシェーダーを呼び出しておく。</span>\n\n<span class=\"token comment\">// 頂点配列をバインド</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">BindVertexArray</span><span class=\"token punctuation\">(</span>vertexArrays<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 頂点インデックスをバインド</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">BindBuffer</span><span class=\"token punctuation\">(</span>buffers<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 頂点インデックスを用いて描画</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">DrawElements</span><span class=\"token punctuation\">(</span>PrimitiveType<span class=\"token punctuation\">.</span>Triangles<span class=\"token punctuation\">,</span>\n    indices<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">,</span> DrawElementsType<span class=\"token punctuation\">.</span>UnsignedInt<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// バインド解除</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">EnableVertexAttribArray</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nGL<span class=\"token punctuation\">.</span><span class=\"token function\">BindVertexArray</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>試しにUtah teapotを、Phong Shading（Ambient + Diffuse + Specular）で描画した様子を示します。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9be89d76ef5fee4c1a79e8496810b8e1/e8814/teapot.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABjUlEQVQoz5WSQUsCQRTH3zuI7uy4S25UJy0QEfFiJuKpNIolacGbnvwAfgK9dMqrOdFmmR5KPfkJW3ZfzKahW4Yefgzz3n9+8GYGnu/vkm9v/cf32VRMppM1ZrOZGAwG4sl+EvazLV5eX8RU5iZrub5cPyYf4qH/cAxMUW4YY6Sq6hqyFolEfhHMBc5cAgBcAYAHAJ8LHAkiOpqmOZxzJ5fLOcVi0VEUxVn2V1iecQHgHBDxGgBoIf2Bc+6Vy2WvVCp5tVrNq9frnmmanmEYXjC7gBDx4i+hbMg9JRIJarVa1O12ybZt6vV6VCgU/F4mkyFd12knYSqVona7TcPhkObzOY1GI2o0GlSpVCifz/v3vJVwCeecms0mCSFoPB5Tp9OharVK8XicVnLbCyXhcJjS6TRls1n/JZf17ylwK+G/IOLGRwGANaG7CUT0CdYZ112mGW5YibpyklAo5H8bMzjmthwmz+jk1KSjZJ72YgbxqFaWwn1EtHYFACymH1h7B3FLix1ajKm3qhaLfQGFQRRs+6Ql5gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Utah teapotを描画した様子\"\n        title=\"Utah teapotを描画した様子\"\n        src=\"/static/9be89d76ef5fee4c1a79e8496810b8e1/5a190/teapot.png\"\n        srcset=\"/static/9be89d76ef5fee4c1a79e8496810b8e1/772e8/teapot.png 200w,\n/static/9be89d76ef5fee4c1a79e8496810b8e1/e17e5/teapot.png 400w,\n/static/9be89d76ef5fee4c1a79e8496810b8e1/5a190/teapot.png 800w,\n/static/9be89d76ef5fee4c1a79e8496810b8e1/c1b63/teapot.png 1200w,\n/static/9be89d76ef5fee4c1a79e8496810b8e1/e8814/teapot.png 1392w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\"><p>Utah teapotを描画した様子</p></figcaption>\n  </figure></p>\n<p>上記の実装は、モデルのロードと読み込んだ頂点やインデックスのバッファ転送、描画コマンドのみをピックアップしているので、そのままでは動きません。\n上記実装そのままではないですが(上記の実装をクラス化したりなどをしていますが)、上記画像を描画したシェーダー生成などを含めたプログラムは<a href=\"https://github.com/yucchiy/OpenTKTutorial/blob/88a461fb209621dc1b876bdec55b08089a9f23d8/OpenTKTutorial/Scene/ModelLoading/ModelLoadingScene.cs\">こちら</a>になります。</p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>Assimpの概要と、C#でAssimpを利用することができるAssimpNetの紹介、読み込んだモデルの頂点と法線を用いてモデルの描画までを行いました。\n次はマテリアルの読み込み、テクスチャをロードしてテクスチャマッピングを実装したいと思います。</p>","excerpt":"この記事ではAssimpの概要と、C#でAssimpを利用することができるAssimpNetの紹介、そして実際にモデルをロードする方法を紹介します。 AssimpNetを扱ったモデルロードについては、この後いくつかのトピックを連載したいと思います。この記事は「Vol1. Assimp概要とモデルロード編」という立ち位置となります。 Assimpとは assimp/assimp: The official Open-Asset-Importer-Library Repository. Loads…","fields":{"slug":"/2021/01/assimp-for-model-loading-csharp/"},"frontmatter":{"date":"January 28, 2021","type":null,"tags":["Assimp","OpenGL","OpenTK","C#"],"title":"AssimpNetを使ったC#でのモデルインポート - Vol1. Assimp概要とモデルロード編","description":null,"eyecatch":null}}},"pageContext":{"id":"08874459-2bce-5442-a56e-d849a5e4fa41"}},"staticQueryHashes":["1480509143","3159585216"]}