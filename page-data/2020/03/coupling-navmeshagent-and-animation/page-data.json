{"componentChunkName":"component---src-templates-post-tsx","path":"/2020/03/coupling-navmeshagent-and-animation/","result":{"data":{"markdownRemark":{"html":"<p>ナビメッシュおよび<a href=\"https://docs.unity3d.com/ScriptReference/AI.NavMeshAgent.html\">ナビメッシュエージェント</a>を用いるとUnityで簡単に3D上での経路探索及び移動が実装できますが、\nナビメッシュエージェントはアタッチされたゲームオブジェクトを自律的に動かすためにそのまま利用するとアニメーションの足滑りなどが発生していまします。</p>\n<p>この記事では、ナビメッシュエージェントを用いて足滑りの無いアニメーションを実現する方法について検討します。<a href=\"https://docs.unity3d.com/Manual/nav-CouplingAnimationAndNavigation.html\">Coupling Animation And Navigation</a>を参考にしています。</p>\n<h2 id=\"アニメーションと移動を同期するフロー\" style=\"position:relative;\"><a href=\"#%E3%82%A2%E3%83%8B%E3%83%A1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%A8%E7%A7%BB%E5%8B%95%E3%82%92%E5%90%8C%E6%9C%9F%E3%81%99%E3%82%8B%E3%83%95%E3%83%AD%E3%83%BC\" aria-label=\"アニメーションと移動を同期するフロー permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>アニメーションと移動を同期するフロー</h2>\n<p>基本的な方針として<a href=\"https://docs.unity3d.com/ScriptReference/AI.NavMeshAgent-updatePosition.html\"><code>NavMeshAgent.updatePosition</code></a>を<code>false</code>にして<strong>位置更新を手動で行うこと</strong>で、事前にエージェントの移動する速度を元にアニメーションを再生して足滑りを緩和します。\n<a href=\"https://docs.unity3d.com/Manual/nav-CouplingAnimationAndNavigation.html\">Coupling Animation And Navigation</a>では、下記のフローでアニメーションとエージェントの移動を同期させています。</p>\n<ol>\n<li>次のエージェントの行動を<a href=\"https://docs.unity3d.com/ScriptReference/AI.NavMeshAgent-nextPosition.html\"><code>NavMeshAgent.nextPosition</code></a>から算出する</li>\n<li>1.で計算した速度からアニメーションを再生するためのパラメータを生成して設定する</li>\n<li>キャラクターを移動させる</li>\n</ol>\n<p><code>NavMeshAgent.nextPosition</code>にはエージェントが次に移動する予定の座標をワールド座標で格納されています。現在の座標と合わせて次のフレームのエージェントの移動速度を算出することができます。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> agent <span class=\"token operator\">=</span> gameObject<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetComponent</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>AI<span class=\"token punctuation\">.</span>NavMeshAgent<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nagent<span class=\"token punctuation\">.</span>updatePosition <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// nextPositionからdeltaPositionを算出</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> worldDeltaPosition <span class=\"token operator\">=</span> agent<span class=\"token punctuation\">.</span>nextPosition <span class=\"token operator\">-</span> transform<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// キャラクターを基点にしたxz平面に射影したdeltaPosition</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> dx <span class=\"token operator\">=</span> Vector3<span class=\"token punctuation\">.</span>Dot <span class=\"token punctuation\">(</span>transform<span class=\"token punctuation\">.</span>right<span class=\"token punctuation\">,</span> worldDeltaPosition<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> dy <span class=\"token operator\">=</span> Vector3<span class=\"token punctuation\">.</span>Dot <span class=\"token punctuation\">(</span>transform<span class=\"token punctuation\">.</span>forward<span class=\"token punctuation\">,</span> worldDeltaPosition<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">Vector2</span> deltaPosition <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector2</span> <span class=\"token punctuation\">(</span>dx<span class=\"token punctuation\">,</span> dy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Time.deltaTimeから速度を算出</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> velocity <span class=\"token operator\">=</span> deltaPosition <span class=\"token operator\">/</span> Time<span class=\"token punctuation\">.</span>deltaTime<span class=\"token punctuation\">;</span></code></pre></div>\n<p>次に速度に対応するアニメーションを再生します。<a href=\"https://docs.unity3d.com/Manual/nav-CouplingAnimationAndNavigation.html\">Coupling Animation And Navigation</a>ではアニメーションコントローラの<code>velx</code>および<code>vely</code>というFloatパラメータを設定しておくと、そのパラメータに対応するアニメーションを生成するようにブレンドツリーを設定します。下記画像は<a href=\"https://docs.unity3d.com/Manual/nav-CouplingAnimationAndNavigation.html\">Coupling Animation And Navigation</a>でのアニメーションコントローラおよびブレンドツリーの設定になります。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/aa19a9d4bf8748288f6ba29490892921/faddd/NavAnimBlend2d.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIDBP/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAXtFjaTD/8QAGRABAAIDAAAAAAAAAAAAAAAAAwAyEBEx/9oACAEBAAEFAmsGGsPNz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABkQAAMAAwAAAAAAAAAAAAAAAAABEDFBgf/aAAgBAQAGPwLOhzg5/8QAGhAAAgMBAQAAAAAAAAAAAAAAAAERITFRQf/aAAgBAQABPyFdVjBj1ZDYqaikHSXT/9oADAMBAAIAAwAAABCTz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EAB0QAQACAgIDAAAAAAAAAAAAAAEAETFBIWEQUbH/2gAIAQEAAT8QtADDOl5YM7g31FllVFNNN9s9e4fPC//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"NavAnimBlend2d\"\n        title=\"NavAnimBlend2d\"\n        src=\"/static/aa19a9d4bf8748288f6ba29490892921/4b190/NavAnimBlend2d.jpg\"\n        srcset=\"/static/aa19a9d4bf8748288f6ba29490892921/e07e9/NavAnimBlend2d.jpg 200w,\n/static/aa19a9d4bf8748288f6ba29490892921/066f9/NavAnimBlend2d.jpg 400w,\n/static/aa19a9d4bf8748288f6ba29490892921/4b190/NavAnimBlend2d.jpg 800w,\n/static/aa19a9d4bf8748288f6ba29490892921/faddd/NavAnimBlend2d.jpg 850w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>速度からパラメータの設定する方法は下記のとおりです。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> animator <span class=\"token operator\">=</span> gameObject<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetComponent</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Animator<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nanimator<span class=\"token punctuation\">.</span>SetFloat <span class=\"token punctuation\">(</span><span class=\"token string\">\"velx\"</span><span class=\"token punctuation\">,</span> velocity<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nanimator<span class=\"token punctuation\">.</span>SetFloat <span class=\"token punctuation\">(</span><span class=\"token string\">\"vely\"</span><span class=\"token punctuation\">,</span> velocity<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>最後にキャラクターを移動させます。移動は<code>OnAnimatorMove</code>で行います。ただしキャラクターを移動させることは一般的に、<strong>アニメーションの品質をとるか、ナビメッシュ移動の品質をとるかトレードオフ</strong>となります。\nというのもエージェントが移動しようとした位置(<code>nextPosition</code>)には、他のキャラクターだったり障害物の妨げにより、<strong>次のフレームで実際にその位置に移動できる保証がない</strong>からです。\nそのような状況下ではアニメーションによる移動を正とすると、キャラクターが他キャラクターや障害物にめり込んでしまい、またナビメッシュエージェントの移動を正とすると足が滑ってしまいます。この辺はゲームごとに最もらしくなるように仕様を決める必要があります。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> OnAnimatorMove <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 案: アニメーションの移動を正とする</span>\n    <span class=\"token class-name\">Vector3</span> position <span class=\"token operator\">=</span> animator<span class=\"token punctuation\">.</span>rootPosition<span class=\"token punctuation\">;</span>\n    position<span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> agent<span class=\"token punctuation\">.</span>nextPosition<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">;</span>\n    transform<span class=\"token punctuation\">.</span>position <span class=\"token operator\">=</span> position<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 案: エージェントの移動を正とする</span>\n    transform<span class=\"token punctuation\">.</span>position <span class=\"token operator\">=</span> agent<span class=\"token punctuation\">.</span>nextPosition<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 案: エージェントに追従する方式</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>worldDeltaPosition<span class=\"token punctuation\">.</span>magnitude <span class=\"token operator\">></span> agent<span class=\"token punctuation\">.</span>radius<span class=\"token punctuation\">)</span> transform<span class=\"token punctuation\">.</span>position <span class=\"token operator\">=</span> agent<span class=\"token punctuation\">.</span>nextPosition <span class=\"token operator\">-</span> <span class=\"token number\">0.9f</span> <span class=\"token operator\">*</span> worldDeltaPosition<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 案: エージェントをドリフトさせる方式</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>worldDeltaPosition<span class=\"token punctuation\">.</span>magnitude <span class=\"token operator\">></span> agent<span class=\"token punctuation\">.</span>radius<span class=\"token punctuation\">)</span> agent<span class=\"token punctuation\">.</span>nextPosition <span class=\"token operator\">=</span> transform<span class=\"token punctuation\">.</span>position <span class=\"token operator\">+</span> <span class=\"token number\">0.9f</span> <span class=\"token operator\">*</span> worldDeltaPosition<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"charactercontrollerをnavmeshagentで動かすアイデア\" style=\"position:relative;\"><a href=\"#charactercontroller%E3%82%92navmeshagent%E3%81%A7%E5%8B%95%E3%81%8B%E3%81%99%E3%82%A2%E3%82%A4%E3%83%87%E3%82%A2\" aria-label=\"charactercontrollerをnavmeshagentで動かすアイデア permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CharacterControllerをNavMeshAgentで動かすアイデア</h2>\n<p>上記で説明した、エージェントの手動更新を応用すると<a href=\"https://docs.unity3d.com/ScriptReference/CharacterController.html\"><code>CharacterController</code></a>の移動をエージェントの思考をベースに行うことができます。<a href=\"https://forum.unity.com/threads/using-a-navmeshagent-with-a-charactercontroller.466902/\">Using a NavMeshAgent with a CharacterController - Unity Forum</a>を参考にしています。</p>\n<p>ポイントとしてはエージェントを手動更新としたうえで、<a href=\"https://docs.unity3d.com/ScriptReference/AI.NavMeshAgent-desiredVelocity.html\"><code>NavMeshAgent.desiredVelocity</code></a>により次に移動すべき速度を習得して、<a href=\"https://docs.unity3d.com/ScriptReference/CharacterController.Move.html\"><code>CharacterController.Move</code></a>にその速度を渡すことで操作します。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">NPC</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">MonoBehaviour</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">NavMeshAgent</span> _agent<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">CharacterController</span> _controller<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">SerializeField</span></span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">private</span> <span class=\"token class-name\">Vector3</span> _destination<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">SerializeField</span></span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">private</span> <span class=\"token class-name\"><span class=\"token keyword\">float</span></span> _speed<span class=\"token punctuation\">;</span>\n\n    <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _agent <span class=\"token operator\">=</span> gameObject<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetComponent</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>NavMeshAgent<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        _controller <span class=\"token operator\">=</span> gameObject<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetComponent</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>CharacterController<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        _agent<span class=\"token punctuation\">.</span>updatePosition <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        _agent<span class=\"token punctuation\">.</span>updateRotation <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _agent<span class=\"token punctuation\">.</span>speed <span class=\"token operator\">=</span> _speed<span class=\"token punctuation\">;</span>\n        _agent<span class=\"token punctuation\">.</span>destination <span class=\"token operator\">=</span> _destination<span class=\"token punctuation\">;</span>\n        _controller<span class=\"token punctuation\">.</span><span class=\"token function\">Move</span><span class=\"token punctuation\">(</span>_agent<span class=\"token punctuation\">.</span>desiredVelocity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>ナビメッシュエージェントを手動で更新することで、足滑りのないキャラクター移動を実現する方法と、そのアイデアを応用してCharacterControllerをエージェントベースで移動する方法についても紹介しました。</p>","excerpt":"ナビメッシュおよびナビメッシュエージェントを用いるとUnityで簡単に3D上での経路探索及び移動が実装できますが、\nナビメッシュエージェントはアタッチされたゲームオブジェクトを自律的に動かすためにそのまま利用するとアニメーションの足滑りなどが発生していまします。 この記事では、ナビメッシュエージェントを用いて足滑りの無いアニメーションを実現する方法について検討します。Coupling Animation And Navigation…","fields":{"slug":"/2020/03/coupling-navmeshagent-and-animation/"},"frontmatter":{"date":"March 31, 2020","type":null,"tags":["Unity","NavMesh","NavMeshAgent","Animation","C#","Tips"],"title":"ナビメッシュエージェントで足滑りのない移動を実装する","description":null,"eyecatch":null}}},"pageContext":{"id":"eda58424-4204-556a-9147-1701013cf818"}},"staticQueryHashes":["1480509143","3159585216"]}