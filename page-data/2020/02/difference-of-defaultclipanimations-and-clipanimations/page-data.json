{"componentChunkName":"component---src-templates-post-tsx","path":"/2020/02/difference-of-defaultclipanimations-and-clipanimations/","result":{"data":{"markdownRemark":{"html":"<p>モーションデータをアニメーションfbxで受け取る際、そのデータが大量に存在する場合するにはヒューマンエラーを防ぐ目的で、自動的にUnityのアニメーションのインポート設定を行いたいことがあります。\n例えば、読み込んだアニメーションクリップのループ設定をファイル名から自動で指定するなどです。</p>\n<p>その場合Unityでは、<a href=\"https://docs.unity3d.com/ScriptReference/AssetPostprocessor.OnPreprocessAnimation.html\"><code>AssetPostprocessor.OnPreprocessAnimation()</code></a>などのメソッドをフックして、アニメーションをインポートタイミング時に処理を差し込みます。</p>\n<p>インポート設定は<a href=\"https://docs.unity3d.com/ScriptReference/ModelImporter.html\"><code>ModelImporter</code></a>クラスを介して行います。\nこのプロパティ中に<a href=\"https://docs.unity3d.com/ScriptReference/ModelImporter-clipAnimations.html\"><code>clipAnimations</code></a>と<a href=\"https://docs.unity3d.com/ScriptReference/ModelImporter-defaultClipAnimations.html\"><code>defaultClipAnimations</code></a>が存在するのですが、この違いがぱっとドキュメントを読んだだけではわからなかったので、実験的に検証しつつまとめました。</p>\n<h2 id=\"tldr\" style=\"position:relative;\"><a href=\"#tldr\" aria-label=\"tldr permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TL;DR</h2>\n<p><code>defaultClipAnimations</code>は <strong>fbx</strong> のTakeInfoで、<code>clipAnimations</code>は <strong>Unity設定（メタデータ）</strong> のTakeInfo。</p>\n<h2 id=\"takeinfoとは\" style=\"position:relative;\"><a href=\"#takeinfo%E3%81%A8%E3%81%AF\" aria-label=\"takeinfoとは permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TakeInfoとは</h2>\n<p>まず前提として、fbxでは１つのアニメーションデータに対して複数の区切り情報をつけて出力することができます(実際には１fbxファイルです)。これをTakeInfoといいます。</p>\n<p>例えば、走るモーションがあったとして、データ上は走り開始、走りループ、走り終了が１つのモーションデータで作っている(こちらのケースのほうがアーティストさんがデータを確認しやすいためこういうデータづくりをするケースが有る)が、\nゲームで扱う場合は、走り中のループが行動によって不定なため、３つのモーションに分割したい場合などに、このTakeInfoをもとにモーションを分割することもできます。</p>\n<p>TakeInfoはMotionBuilderなどで編集してfbxにTakeInfoを合わせて出力することが可能で、Unityでは設定した情報をfbx上から読み込むことができます。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 488px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/211b98abd91cd4640a872f6665df00b8/bd48c/takeinfo-in-animation-tab.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 133%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAIAAADzvTiPAAAACXBIWXMAAAsTAAALEwEAmpwYAAADfklEQVQ4y42VW1PcNhTH/XU705mm/Qg8dCadTqZNKXsDNoSFjcHruyXbsi1ZsuX1jbJ0Wmhgt8DTUuCFT9DaKgkJJelvzmhk2X/r+OicY6m78XowHA1evXk9Gvd7vcFg0O/3xSgm648Q6ysrK9J3r5w9Lws9B0LotiCEIIQIIQBAEAR1XVcPqOuatWxsbEgbYx3GZZln2bQhz/OyLMVYFIWYVFUlLouiKMsyy7I8zzc3NyUcBlOeUCpex5IkYYyVZWlZ1lqLoiiMsTRNGWOEkDiOCSFZlvX7fclpfUMI+b6PEEqShHOe53kQBOMWAECWZZxzxhhtieN4Op02YlVVZVlWFGU0Gum6zhiL45hSmuc5b0mSRAjoPe/FAIAwDIMg8H0fYyxuC//je+iHvBcbhqFpmq7rpmkCAMTOjLG6rsX3Jy3xAwgh/4pN0xT6yWSi6zohhFIqng7DEGMchiGl9PDw8Oie2Wx2fHy8vr4u6bqutKiqijEWTjLGOOcnJyfz+fz09PTs7Oyi5fLy8uLi4vz8/Orqamtrq9lZ0zRVVSGEIqTiYGaz2XK5vL29vb6+vrm5+esBy+Xy7u5ue3tbsixrMpkYhiFiFrQghAghRVGIlCrLUuTZbDY7ODioqmo+nw+Hw0asKIphGLquT1r29/c1TXvnkdZimiZCCGMcRVEQBGVZDgYDybZtvcVsEcELw5BzHn+IOCSMMSGEc95E27Ksvb09AIDruiLJEEKe57mu6z0CQijLsmVZpmmurq42SSLcAwCkaZp9kjRNPc8LW7rdruQ4jizLu7u7lNKiKKZPk+c5Y8w0Tdd1IYS9Xk+CEFim7kIn40ldFlWRP2UHVZkw6lim70Lfg/1+TzJMZ7ijmB5xMYdR+glzcWbAaPRG3dk3ZM35udOV+jvGF8+VZz86X7+En7Gf3K9eGF8+l599P/nmB+PbF2sSDlCR8SRh6f8wnja1Qmk8zbJetyt19zUT05Pff5sv/pwvFp+1xWLx9u0fGJNOpytNoEeneV2VVdWk4UNE63q8WBTFr0dHTQ/zXYjalPZ9/6OiFR3rIzCJ/SCMMFnrdKQgCETdvmsgoqqiKPJ9X/Q9schYwnkKvFAFzKe/rHUHTZIAADDGor9F/4WoB4wxQsix7SiKptN8PB43DdC2bYRQFEVhGHqe5z+B+BnYtu37PmPsn5L8G1WLqKYPoE6PAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Unityのインスペクタ上でのTakeInfo - 画像は https://docs.unity3d.com/Manual/Splittinganimations.html より\"\n        title=\"Unityのインスペクタ上でのTakeInfo - 画像は https://docs.unity3d.com/Manual/Splittinganimations.html より\"\n        src=\"/static/211b98abd91cd4640a872f6665df00b8/bd48c/takeinfo-in-animation-tab.png\"\n        srcset=\"/static/211b98abd91cd4640a872f6665df00b8/772e8/takeinfo-in-animation-tab.png 200w,\n/static/211b98abd91cd4640a872f6665df00b8/e17e5/takeinfo-in-animation-tab.png 400w,\n/static/211b98abd91cd4640a872f6665df00b8/bd48c/takeinfo-in-animation-tab.png 488w\"\n        sizes=\"(max-width: 488px) 100vw, 488px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\"><p>Unityのインスペクタ上でのTakeInfo - 画像は <a href=\"https://docs.unity3d.com/Manual/Splittinganimations.html\">https://docs.unity3d.com/Manual/Splittinganimations.html</a> より</p></figcaption>\n  </figure></p>\n<p>UnityではTakeInfoを元に<strong>Take名と同名のアニメーションクリップを出力します</strong>。</p>\n<h2 id=\"defaultclipanimationsとclipanimations\" style=\"position:relative;\"><a href=\"#defaultclipanimations%E3%81%A8clipanimations\" aria-label=\"defaultclipanimationsとclipanimations permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>defaultClipAnimationsとclipAnimations</h2>\n<p>fbxに保存されているTakeInfoは前述した<code>ModelImporter</code>の<code>defaultClipAnimations</code>に格納されています。\n<code>defaultClipAnimations</code>はfbxのデータのため更新することができません(UnityはDCCツールなどで出力されたデータを基本は書き換えず、Unity独自の設定はメタデータで行う)。</p>\n<p>UnityではさらにTakeInfoを上書きすることができ、このデータはfbxファイルのメタデータ内に書き込まれます。その情報を<code>clipAnimations</code>で取得することができます。</p>\n<p>当然、<code>clipAnimations</code>は下記のようにスクリプトで編集することもできます。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">OnPreprocessAnimation</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ModelImporter</span> importer<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> importer <span class=\"token operator\">=</span> assetImporter <span class=\"token keyword\">as</span> <span class=\"token class-name\">ModelImporter</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> clips <span class=\"token operator\">=</span> importer<span class=\"token punctuation\">.</span>defaultClipAnimations<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> clip <span class=\"token keyword\">in</span> clips<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// defaultClipAnimationsに対して設定を上書きを行う</span>\n        <span class=\"token comment\">// 例えば Root Transform Position(Y)の設定を自動で行う</span>\n        <span class=\"token comment\">// reference by https://gist.github.com/keijiro/fde84ff347a6747bcf6b</span>\n        clip<span class=\"token punctuation\">.</span>lockRootHeightY <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        clip<span class=\"token punctuation\">.</span>keepOriginalPositionY <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        clip<span class=\"token punctuation\">.</span>heightFromFeet <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        clip<span class=\"token punctuation\">.</span>heightOffset <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">0.1f</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    importer<span class=\"token punctuation\">.</span>clipAnimations <span class=\"token operator\">=</span> clips<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ちなみに<code>clipAnimations</code>は自動で作成されるわけではなく、設定を変更したタイミングでデータが取得できます。デフォルトでは空配列となっています。\nなので、すでに上書き設定が行われている場合に、上書き設定に対して処理を行いたい場合は、下記のように<code>clipAnimations</code>が空でないかの判定を行います。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">OnPreprocessAnimation</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ModelImporter</span> importer<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> importer <span class=\"token operator\">=</span> assetImporter <span class=\"token keyword\">as</span> <span class=\"token class-name\">ModelImporter</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> clips <span class=\"token operator\">=</span> importer<span class=\"token punctuation\">.</span>clipAnimations<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 上書き設定が行われていなければ、fbxの設定を持ってくる</span>\n    <span class=\"token comment\">// 空でなければ上書き設定を更新する</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>clips<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> clips <span class=\"token operator\">=</span> importer<span class=\"token punctuation\">.</span>defaultClipAnimations<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// ここからは一緒</span>\n    <span class=\"token comment\">//...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>１つ注意点なのが、fbxのデータが更新されるケースです。\n例えばfbx側でモーションの尺を調整した場合、その設定自体<code>defaultClipAnimations</code>の<a href=\"https://docs.unity3d.com/ScriptReference/ModelImporterClipAnimation.html\">ModelImporterClipAnimation</a>の<code>firstFrame</code>および<code>lastFrame</code>で取得できるのですが、\n上記のスクリプトでは一度上書き設定をしてしまうと、<strong>以後<code>defaultClipAnimations</code>を参照していないため、fbx側の尺の変更を反映させることができません</strong>。</p>\n<p>モーションの尺変更を反映させたい場合は、<code>defaultClipAnimations</code>も参照しつつ、というスクリプトが必要です。</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">OnPreprocessAnimation</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ModelImporter</span> importer<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> importer <span class=\"token operator\">=</span> assetImporter <span class=\"token keyword\">as</span> <span class=\"token class-name\">ModelImporter</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> clips <span class=\"token operator\">=</span> importer<span class=\"token punctuation\">.</span>clipAnimations<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 上書き設定が行われていなければ、fbxの設定を持ってくる</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>clips<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> clips <span class=\"token operator\">=</span> importer<span class=\"token punctuation\">.</span>defaultClipAnimations<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> clips<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">>=</span> defaultClipAnimations<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// モーション尺の情報はfbxデータを正としておく</span>\n        clips<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>firstFrame <span class=\"token operator\">=</span> importer<span class=\"token punctuation\">.</span>defaultClipAnimations<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>firstFrame<span class=\"token punctuation\">;</span>\n        clips<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>lastFrame <span class=\"token operator\">=</span> importer<span class=\"token punctuation\">.</span>defaultClipAnimations<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>lastFrame<span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ただし、TakeInfoはその分割数さえもUnity側で上書きできるので、その場合はモーション尺の更新も必要ないでしょう(分割設定をUnityでやるということは分割をUnity側に委ねているはずなのでfbx側のTakeInfoを持ってくる必要はない)。</p>\n<p>つまり用途ごとにこの辺の実装は異なるかと思います。</p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p><code>defaultClipAnimations</code>と<code>clipAnimations</code>の違いについて説明しました。アニメーションのインポータはこの違いとデータの更新タイミングを理解し実装することが必要かと思います。</p>\n<p><em>ちなみに著者は最後に紹介したミスをやらかしました...</em></p>","excerpt":"モーションデータをアニメーションfbxで受け取る際、そのデータが大量に存在する場合するにはヒューマンエラーを防ぐ目的で、自動的にUnityのアニメーションのインポート設定を行いたいことがあります。\n例えば、読み込んだアニメーションクリップのループ設定をファイル名から自動で指定するなどです。 その場合Unityでは、AssetPostprocessor.OnPreprocessAnimation…","fields":{"slug":"/2020/02/difference-of-defaultclipanimations-and-clipanimations/"},"frontmatter":{"date":"February 09, 2020","type":null,"tags":["Tips","Unity","ModelImporter","Animation","C#"],"title":"ModelImporterのdefaultClipAnimationsとclipAnimationsについて","description":null,"eyecatch":null}}},"pageContext":{"id":"7b96ba77-edad-5331-8718-ced8c7b582b3"}},"staticQueryHashes":["1480509143","3159585216"]}