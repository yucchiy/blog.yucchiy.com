{"componentChunkName":"component---src-templates-post-tsx","path":"/2024/12/androidjni-method-call-optimization/","result":{"data":{"markdownRemark":{"html":"<p>この記事は<a href=\"https://qiita.com/advent-calendar/2024/applibot\">Applibot Advent Calendar 2024</a> の2日目の記事です。</p>\n<p>この記事ではAndroid向けにビルドしたUnityアプリのネイティブメソッド呼び出しの最適化について触れます。</p>\n<p>たとえば下記のようにAndroidのHapticFeedbackを呼び出すような実装の場合、</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// Viw.performHapticFeedback経由でHapticFeedbackを操作</span>\n<span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">PerformHapticFeedback</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">int</span></span> feedbackConstant<span class=\"token punctuation\">)</span>  \n<span class=\"token punctuation\">{</span>  \n    <span class=\"token comment\">// _viewにはUnityPlayerが内部的に所持するandroid.view.Viewの</span>\n    <span class=\"token comment\">// AndroidJavaObjectが代入されているものとします</span>\n    _view<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Call</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">bool</span><span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"performHapticFeedback\"</span><span class=\"token punctuation\">,</span> feedbackConstant<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>プロファイラーで計測すると下記のGC.Allocが発生していることが確認できます。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3e65c0eb0566aa92fe7c4c6ac45a684b/21482/call-normal.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA5klEQVQY0z2M207CQBRF+0co0M6tDNAy05aZXsD4hBDFqE+GRP4/y7QPPOycfdZKdtJ+/NFd71P6zzv7yw0zXJnVJ+b7C7PqjfXrD6uXb56aM/X5xiJcSOP75EfmT7+Y4xeiv5IUNqePDYcucGgDsfFUuy3blUZnc7L5jN1mRWENcvlMqB06W2DEcvIjq13BJldYLUhMntMPA13fMxyOtF1HbFucr9DGkGaCcucoyhIhJCFGlNJokyOVRkiFr6qp2/WGJMaI9x4hBEqpR7TWSClJ0xTnHOU0KAghPPx4R9Y0zfRba/kH/rePfanEZSoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"最適化前のメソッド呼び出しのプロファイリング結果\"\n        title=\"最適化前のメソッド呼び出しのプロファイリング結果\"\n        src=\"/static/3e65c0eb0566aa92fe7c4c6ac45a684b/5a190/call-normal.png\"\n        srcset=\"/static/3e65c0eb0566aa92fe7c4c6ac45a684b/772e8/call-normal.png 200w,\n/static/3e65c0eb0566aa92fe7c4c6ac45a684b/e17e5/call-normal.png 400w,\n/static/3e65c0eb0566aa92fe7c4c6ac45a684b/5a190/call-normal.png 800w,\n/static/3e65c0eb0566aa92fe7c4c6ac45a684b/c1b63/call-normal.png 1200w,\n/static/3e65c0eb0566aa92fe7c4c6ac45a684b/21482/call-normal.png 1350w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\"><p>最適化前のメソッド呼び出しのプロファイリング結果</p></figcaption>\n  </figure></p>\n<p>これには主に下記の原因があげられます。</p>\n<ul>\n<li><code>AndroidJavaObject.Call</code> 呼び出しごとにJNI上のメソッドIDやなどを取り直しているため</li>\n<li><code>AndroidJavaObject.Call</code> の引数の受け取りが <code>params object[] args</code> であるため</li>\n</ul>\n<p>とくにHapticFeedbackのように呼び出し頻度の高い可能性のあるメソッドでは、このGC.Allocが気になるところです。</p>\n<p>本記事ではメソッド呼び出しを工夫することで、Androidのメソッド呼び出しにおけるGC Allocを削減する方法について紹介します。</p>\n<h2 id=\"androidjavaobjectでのメソッド呼び出しの実装の確認\" style=\"position:relative;\"><a href=\"#androidjavaobject%E3%81%A7%E3%81%AE%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%81%AE%E5%AE%9F%E8%A3%85%E3%81%AE%E7%A2%BA%E8%AA%8D\" aria-label=\"androidjavaobjectでのメソッド呼び出しの実装の確認 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AndroidJavaObjectでのメソッド呼び出しの実装の確認</h2>\n<p>先述したHapticFeedback呼び出しを例に、<code>AndroidJavaObject</code> におけるメソッド呼び出しが具体的にどのように行われているかを確認します。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// こちらの例を題材に呼び出しを確認する</span>\n_view<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Call</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">bool</span><span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"performHapticFeedback\"</span><span class=\"token punctuation\">,</span> feedbackConstant<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </code></pre></div>\n<p>上記のメソッド呼び出しでは、具体的に下記のメソッドが呼び出されます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">ReturnType</span> <span class=\"token generic-method\"><span class=\"token function\">Call</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>ReturnType<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> methodName<span class=\"token punctuation\">,</span> <span class=\"token keyword\">params</span> <span class=\"token class-name\"><span class=\"token keyword\">object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> args<span class=\"token punctuation\">)</span>  \n<span class=\"token punctuation\">{</span>  \n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">_Call</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>ReturnType<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>methodName<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>このように、メソッドの引数は可変長引数で <code>object[] args</code> として渡されます。</p>\n<p>引数を渡す際にヒープに <code>object[]</code> が確保されるため、 <strong>メソッドを呼び出す都度 GC.Alloc が発生します</strong>。</p>\n<p>次に <code>this._Call&#x3C;ReturnType>(methodName, args)</code> を確認します。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">protected</span> <span class=\"token return-type class-name\">ReturnType</span> <span class=\"token generic-method\"><span class=\"token function\">_Call</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>ReturnType<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> methodName<span class=\"token punctuation\">,</span> <span class=\"token keyword\">params</span> <span class=\"token class-name\"><span class=\"token keyword\">object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> args<span class=\"token punctuation\">)</span>  \n<span class=\"token punctuation\">{</span>  \n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">_Call</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>ReturnType<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>\n        <span class=\"token comment\">// メソッドIDを検索している</span>\n        AndroidJNIHelper<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetMethodID</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>ReturnType<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>\n            <span class=\"token punctuation\">(</span>IntPtr<span class=\"token punctuation\">)</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>m_jclass<span class=\"token punctuation\">,</span>\n            methodName<span class=\"token punctuation\">,</span>\n            args<span class=\"token punctuation\">,</span>\n            <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        args\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code>AndroidJNIHelper.GetMethodID</code> を介して <code>methodName</code> および <code>args</code> からメソッドIDを<strong>都度取得しています</strong>。</p>\n<p>最後に <code>this._Call&#x3C;ReturnType>(methodID, args)</code> の処理は下記のとおりです。　</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">protected</span> <span class=\"token return-type class-name\">ReturnType</span> <span class=\"token generic-method\"><span class=\"token function\">_Call</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>ReturnType<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IntPtr</span> methodID<span class=\"token punctuation\">,</span> <span class=\"token keyword\">params</span> <span class=\"token class-name\"><span class=\"token keyword\">object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> args<span class=\"token punctuation\">)</span>  \n<span class=\"token punctuation\">{</span>  \n  <span class=\"token class-name\">Span<span class=\"token punctuation\">&lt;</span>jvalue<span class=\"token punctuation\">></span></span> span <span class=\"token operator\">=</span> args <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> args<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">?</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Span<span class=\"token punctuation\">&lt;</span>jvalue<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token keyword\">stackalloc</span> jvalue<span class=\"token punctuation\">[</span>args<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  \n  AndroidJNI<span class=\"token punctuation\">.</span><span class=\"token function\">PushLocalFrame</span><span class=\"token punctuation\">(</span>span<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  AndroidJNIHelper<span class=\"token punctuation\">.</span><span class=\"token function\">CreateJNIArgArray</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">,</span> span<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  <span class=\"token keyword\">try</span>  \n  <span class=\"token punctuation\">{</span>  \n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>AndroidReflection<span class=\"token punctuation\">.</span><span class=\"token function\">IsPrimitive</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> <span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\">ReturnType</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n    <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> <span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\">ReturnType</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token keyword\">typeof</span> <span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\"><span class=\"token keyword\">int</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>ReturnType<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>ValueType<span class=\"token punctuation\">)</span> AndroidJNISafe<span class=\"token punctuation\">.</span><span class=\"token function\">CallIntMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>IntPtr<span class=\"token punctuation\">)</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>m_jobject<span class=\"token punctuation\">,</span> methodID<span class=\"token punctuation\">,</span> span<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> <span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\">ReturnType</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token keyword\">typeof</span> <span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\"><span class=\"token keyword\">bool</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>ReturnType<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>ValueType<span class=\"token punctuation\">)</span> AndroidJNISafe<span class=\"token punctuation\">.</span><span class=\"token function\">CallBooleanMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>IntPtr<span class=\"token punctuation\">)</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>m_jobject<span class=\"token punctuation\">,</span> methodID<span class=\"token punctuation\">,</span> span<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n\n      <span class=\"token comment\">// ...</span>\n      <span class=\"token comment\">// 引数と戻り値に対応したメソッド呼び出しを行う</span>\n      <span class=\"token comment\">// ...</span>\n\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Exception</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"JNI: Unknown return type '\"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">typeof</span> <span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\">ReturnType</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">?.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"'\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n    AndroidJNI<span class=\"token punctuation\">.</span><span class=\"token function\">PopLocalFrame</span><span class=\"token punctuation\">(</span>IntPtr<span class=\"token punctuation\">.</span>Zero<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>引数の <code>methodID</code> と <code>args</code> に対応するメソッド呼び出しを行っています。</p>\n<h2 id=\"メソッド呼び出しの最適化\" style=\"position:relative;\"><a href=\"#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%81%AE%E6%9C%80%E9%81%A9%E5%8C%96\" aria-label=\"メソッド呼び出しの最適化 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>メソッド呼び出しの最適化</h2>\n<p>メソッド呼び出しの方法について確認できましたが、最適化のためには下記がポイントになります。</p>\n<ul>\n<li>メソッドIDなど、メソッド呼び出しに必要なIDをキャッシュする</li>\n<li>可変長引数による配列のヒープ確保をやめる</li>\n</ul>\n<p>上記のポイントを抑えて、下記の実装を最適化してみたいと思います。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// Viw.performHapticFeedback経由でHapticFeedbackを操作</span>\n<span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">PerformHapticFeedback</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">int</span></span> feedbackConstant<span class=\"token punctuation\">)</span>  \n<span class=\"token punctuation\">{</span>  \n    <span class=\"token comment\">// _viewにはUnityPlayerが内部的に所持するandroid.view.Viewの</span>\n    <span class=\"token comment\">// AndroidJavaObjectが代入されているものとします</span>\n    _view<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Call</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">bool</span><span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"performHapticFeedback\"</span><span class=\"token punctuation\">,</span> feedbackConstant<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"メソッドidのキャッシュ\" style=\"position:relative;\"><a href=\"#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89id%E3%81%AE%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5\" aria-label=\"メソッドidのキャッシュ permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>メソッドIDのキャッシュ</h3>\n<p>Androidのメソッド呼び出しは、 <code>AndroidJavaObject.Call</code> を用いる以外に <code>AndroidJNI.CallXXXMethod</code> というメソッドを介して呼び出す事ができます。</p>\n<p><code>View.performHapticFeedback</code> は 引数に <code>int</code> を取り、戻り値に <code>boolean</code> を返却するメソッドですが、下記を呼び出すためには、<code>AndroidJNI.CallBooleanMethod</code> が利用できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">AndroidJNI<span class=\"token punctuation\">.</span><span class=\"token function\">CallBooleanMethod</span><span class=\"token punctuation\">(</span>  \n    <span class=\"token comment\">// インスタンスメソッド呼び出しのための</span>\n    <span class=\"token comment\">// インスタンスそのもののアドレスを表すIntPtr</span>\n    _view<span class=\"token punctuation\">.</span><span class=\"token function\">GetRawObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>  \n    <span class=\"token comment\">// メソッドIDを表すIntPtr</span>\n    _performHapticFeedbackMethodId<span class=\"token punctuation\">,</span>  \n    <span class=\"token comment\">// このメソッド呼び出しのための配列（jvalue[]）</span>\n    args\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code>_view</code> は Unityが内部で所持するViewクラスのインスタンスです。 Unity 6の場合、<a href=\"https://docs.unity3d.com/ScriptReference/Android.AndroidApplication.html\">AndroidApplication</a> を介して下記のように取得できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">AndroidJavaObject</span> _view <span class=\"token operator\">=</span>  \n    AndroidApplication  \n        <span class=\"token comment\">// Unity 6から、AndroidApplication.unityPlayer経由で  </span>\n        <span class=\"token comment\">// UnityPlayerを取得できるようになった  </span>\n        <span class=\"token punctuation\">.</span>unityPlayer  \n        <span class=\"token comment\">// UnityPlayerが直接Viewを継承しなくなったなど  </span>\n        <span class=\"token comment\">// 変更点もいくつか存在する  </span>\n        <span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Call</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>AndroidJavaObject<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"getView\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>メソッドIDはUnityアプリを起動中は動的に変更されないため、事前に取得しておいて再利用します。</p>\n<p>今回は <code>HapticFeedbackPlayer</code> という HapticFeedback を扱うための専用クラスを作るとして、このメンバーとして保持しておくことにします。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">System</span><span class=\"token punctuation\">;</span>  \n<span class=\"token keyword\">using</span> <span class=\"token namespace\">UnityEngine</span><span class=\"token punctuation\">;</span>  \n<span class=\"token keyword\">using</span> <span class=\"token namespace\">UnityEngine<span class=\"token punctuation\">.</span>Android</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HapticFeedbackPlayer</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IDisposable</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">AndroidJavaObject</span> _view <span class=\"token operator\">=</span>\n        AndroidApplication<span class=\"token punctuation\">.</span>unityPlayer<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Call</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>AndroidJavaObject<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"getView\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">IntPtr</span> _performHapticFeedbackMethodId <span class=\"token operator\">=</span>\n        AndroidJNIHelper<span class=\"token punctuation\">.</span><span class=\"token function\">GetMethodID</span><span class=\"token punctuation\">(</span>\n            <span class=\"token comment\">// メソッドが所属するクラスID（これも使いまわしても良い）</span>\n            AndroidJNI<span class=\"token punctuation\">.</span><span class=\"token function\">FindClass</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"android/view/View\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token comment\">// メソッド名</span>\n            <span class=\"token string\">\"performHapticFeedback\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token comment\">// メソッドのシグネチャ</span>\n            <span class=\"token comment\">// intを引数にとり、戻り値にbooleanを返すメソッドのシグネチャを表す</span>\n            <span class=\"token string\">\"(I)Z\"</span><span class=\"token punctuation\">,</span>  \n            <span class=\"token comment\">// 静的メソッドかどうか。インスタンスメソッドなのでfalse</span>\n            <span class=\"token boolean\">false</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _view<span class=\"token punctuation\">.</span><span class=\"token function\">Dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>これで <code>HapticFeedbackPlayer</code> が生存する間は メソッドIDをキャッシュすることができました。</p>\n<h3 id=\"メソッド呼び出しの最適化-1\" style=\"position:relative;\"><a href=\"#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%81%AE%E6%9C%80%E9%81%A9%E5%8C%96-1\" aria-label=\"メソッド呼び出しの最適化 1 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>メソッド呼び出しの最適化</h3>\n<p><code>AndroidJavaObject</code> のメソッド呼び出しでは可変長引数で引数が渡ってしまうため、呼び出しごとに<code>object[]</code> のヒープ確保が行われていましたが、これを最適化します。</p>\n<p>具体的には、今回は <code>stackalloc</code> で引数を渡すときに必要な <code>jvalue[]</code> を<strong>スタック上確保することで</strong> ヒープ上への配列確保を回避します。</p>\n<p>メソッド呼び出しの全体を示します。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">PerformHapticFeedbackOptimized</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">int</span></span> feedbackConstant<span class=\"token punctuation\">)</span>  \n<span class=\"token punctuation\">{</span>  \n    <span class=\"token comment\">// 引数一覧をstackallocで渡す  </span>\n    <span class=\"token comment\">// 今回渡す引数の個数は1個なので、配列を長さ1で確保する</span>\n    <span class=\"token class-name\">Span<span class=\"token punctuation\">&lt;</span>jvalue<span class=\"token punctuation\">></span></span> args <span class=\"token operator\">=</span> <span class=\"token keyword\">stackalloc</span> jvalue<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  \n\n    <span class=\"token comment\">// 引数の型に合わせて値を設定。intの場合はiというプロパティに値を設定  </span>\n    args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>i <span class=\"token operator\">=</span> feedbackConstant<span class=\"token punctuation\">;</span>  \n\n    AndroidJNI<span class=\"token punctuation\">.</span><span class=\"token function\">CallBooleanMethod</span><span class=\"token punctuation\">(</span>  \n        _view<span class=\"token punctuation\">.</span><span class=\"token function\">GetRawObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>  \n        _performHapticFeedbackMethodId<span class=\"token punctuation\">,</span>  \n        args\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code>jvalue</code> は JNI上での値を表す構造体で、下記のように定義されています。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">namespace</span> <span class=\"token namespace\">UnityEngine</span>  \n<span class=\"token punctuation\">{</span>  \n  <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">NativeType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>CodegenOptions<span class=\"token punctuation\">.</span>Custom<span class=\"token punctuation\">,</span> <span class=\"token string\">\"ScriptingJvalue\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>  \n  <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">StructLayout</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>LayoutKind<span class=\"token punctuation\">.</span>Explicit<span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>  \n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">jvalue</span>  \n  <span class=\"token punctuation\">{</span>  \n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">FieldOffset</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> z<span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">FieldOffset</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\"><span class=\"token keyword\">sbyte</span></span> b<span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">FieldOffset</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\"><span class=\"token keyword\">char</span></span> c<span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">FieldOffset</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\"><span class=\"token keyword\">short</span></span> s<span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">FieldOffset</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> i<span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">FieldOffset</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\"><span class=\"token keyword\">long</span></span> j<span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">FieldOffset</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\"><span class=\"token keyword\">float</span></span> f<span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">FieldOffset</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\"><span class=\"token keyword\">double</span></span> d<span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">FieldOffset</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">IntPtr</span> l<span class=\"token punctuation\">;</span>  \n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>渡す引数の型に応じて <code>jvalue</code> 構造体の適切なフィールドに値を設定します。（たとえば <code>int</code> の場合は <code>i</code> というフィールドに値を設定します。）</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// 引数一覧をstackallocで渡す  </span>\n<span class=\"token comment\">// 今回渡す引数の個数は1個なので、配列を長さ1で確保する</span>\n<span class=\"token class-name\">Span<span class=\"token punctuation\">&lt;</span>jvalue<span class=\"token punctuation\">></span></span> args <span class=\"token operator\">=</span> <span class=\"token keyword\">stackalloc</span> jvalue<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  \n\n<span class=\"token comment\">// 引数の型に合わせて値を設定。intの場合はiというプロパティに値を設定  </span>\nargs<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>i <span class=\"token operator\">=</span> feedbackConstant<span class=\"token punctuation\">;</span>  </code></pre></div>\n<p>これらの実装を行うことで、プロファイラー上メソッド呼び出し時のGC.Allocを削減することが確認できました。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bda4cec2e90c63d447c8d735756bdd38/9685e/call-optimized.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 6.999999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAUElEQVQI1x3HSwqAIABAwc7UhxZBJhWipYlBZS2k7n+HFzi7KXodWI+EPRPuenHxxd8f03ZRD4ZKaHq9I+2Rr8JDIxfa0eZ3yiPMTik0s4/87SElVZhDf5QAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"最適化を行ったメソッド呼び出しのプロファイリング結果\"\n        title=\"最適化を行ったメソッド呼び出しのプロファイリング結果\"\n        src=\"/static/bda4cec2e90c63d447c8d735756bdd38/5a190/call-optimized.png\"\n        srcset=\"/static/bda4cec2e90c63d447c8d735756bdd38/772e8/call-optimized.png 200w,\n/static/bda4cec2e90c63d447c8d735756bdd38/e17e5/call-optimized.png 400w,\n/static/bda4cec2e90c63d447c8d735756bdd38/5a190/call-optimized.png 800w,\n/static/bda4cec2e90c63d447c8d735756bdd38/c1b63/call-optimized.png 1200w,\n/static/bda4cec2e90c63d447c8d735756bdd38/9685e/call-optimized.png 1336w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\"><p>最適化を行ったメソッド呼び出しのプロファイリング結果</p></figcaption>\n  </figure></p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>Androidのメソッド呼び出しを、AndroidJNIクラスとstackallocを用いてGC.Allocを削減する方法について紹介しました。</p>\n<p>すこしニッチな内容でしたが、これらのメソッドの利用方法はネット上に資料が少ないと思うので、この記事が少しでも役に立つと幸いです。</p>","excerpt":"この記事はApplibot Advent Calendar 2024 の2日目の記事です。 この記事ではAndroid向けにビルドしたUnityアプリのネイティブメソッド呼び出しの最適化について触れます。 たとえば下記のようにAndroidのHapticFeedbackを呼び出すような実装の場合、 プロファイラーで計測すると下記のGC.Allocが発生していることが確認できます。  これには主に下記の原因があげられます。 AndroidJavaObject.Call 呼び出しごとにJNI…","fields":{"slug":"/2024/12/androidjni-method-call-optimization/"},"frontmatter":{"date":"December 02, 2024","type":"tech","tags":["Unity","Android","Advent Calendar 2024"],"title":"AndroidJNIクラスとstackallocを用いたAndroidメソッド呼び出しのGC.Alloc削減について","description":"AndroidJNIクラスとstackallocを用いて、Androidネイティブメソッド呼び出し時のGC.Allocを削減する方法について紹介しています。","eyecatch":null}}},"pageContext":{"id":"26b19431-a0c9-5ffd-9588-cedff9aace26"}},"staticQueryHashes":["1480509143","3159585216"]}