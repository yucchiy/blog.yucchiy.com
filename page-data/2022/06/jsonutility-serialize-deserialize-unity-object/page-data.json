{"componentChunkName":"component---src-templates-post-tsx","path":"/2022/06/jsonutility-serialize-deserialize-unity-object/","result":{"data":{"markdownRemark":{"html":"<p><code>JsonUtility</code> を用いると、シリアライズ可能なオブジェクトをJSONとして文字列に変換（シリアライズ）し、またはJSON文字列から対応するオブジェクトを生成（デシリアライズ）できます。</p>\n<p>サーバーと通信するときのフォーマットとしてJSONがよく用いられるため、これらの用途だったり、シリアライズできるということはつまりクラスインスタンスを文字列として表現できるということなので、たとえばゲームの状態を表す型をJSONに変換してファイル保存することでセーブデータの保存が実装できます。</p>\n<p>よく知られたクラスで、たくさんブログが書かれているんですが、改めて便利に感じたことがあったので、個人の備忘録として残しておきたいと思います。</p>\n<h2 id=\"基本的な使い方\" style=\"position:relative;\"><a href=\"#%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E4%BD%BF%E3%81%84%E6%96%B9\" aria-label=\"基本的な使い方 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>基本的な使い方</h2>\n<p><code>JsonUtility</code> の基本的な使い方を抑えておきます。JSON文字列としてシリアライズしたいクラスは、シリアライズ可能な型として定義します。</p>\n<p>具体的にはクラスに <code>System.Serializable</code> 属性をつけることでシリアライズ可能な型として定義します。通常シリアライズできるフィールドは <code>public</code> なフィールドのみですが、フィールドに <code>UnityEngine.SerializeField</code> 属性をつけておくことで、 <code>private</code> なフィールドなどもシリアライズできます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Serializable</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TestClass1</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> PublicField<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> PrivateField<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">SerializeField</span></span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">private</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> PrivateSerializeField<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> PrivateFieldGetter <span class=\"token operator\">=></span> PrivateField<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> PrivateSerializeFieldGetter <span class=\"token operator\">=></span> PrivateSerializeField<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">TestClass1</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">int</span></span> publicField<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> privateField<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> privateSerializableField<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        PublicField <span class=\"token operator\">=</span> publicField<span class=\"token punctuation\">;</span>\n        PrivateField <span class=\"token operator\">=</span> privateField<span class=\"token punctuation\">;</span>\n        PrivateSerializeField <span class=\"token operator\">=</span> privateSerializableField<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>上記の型に対して、下記のような操作でJSONシリアライズとデシリアライズが行なえます。まずはじめにシリアライズとデシリアライズの一連の流れを示します。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">var</span> test１ <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">TestClass1</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// JSON文字列にシリアライズ</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> test1Json <span class=\"token operator\">=</span> JsonUtility<span class=\"token punctuation\">.</span><span class=\"token function\">ToJson</span><span class=\"token punctuation\">(</span>test1<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"test1: \\n</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">test1Json</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// test1: </span>\n<span class=\"token comment\">// {</span>\n<span class=\"token comment\">//     \"PublicField\": 10,</span>\n<span class=\"token comment\">//     \"PrivateIntSerializeField\": 30</span>\n<span class=\"token comment\">// }</span>\n\n<span class=\"token comment\">// JSON文字列からクラスとしてデシリアライズする</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> newTest1\n    <span class=\"token operator\">=</span> JsonUtility<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">FromJson</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>TestClass1<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>test1Json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"PublicField = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">newTest1<span class=\"token punctuation\">.</span>PublicField</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// PublicField = 10</span>\n\n<span class=\"token comment\">// Privateなのでシリアライズされずにデフォルト値が入る</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"PrivateField = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">newTest1<span class=\"token punctuation\">.</span>PrivateFieldGetter</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// PrivateField = 0</span>\n\n<span class=\"token comment\">// SerializeFieldをつけたのでこっちは大丈夫</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"PrivateSerializeField = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">newTest1<span class=\"token punctuation\">.</span>PrivateSerializeFieldGetter</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// PrivateSerializeField = 30</span></code></pre></div>\n<p>クラスインスタンスからJSON文字列へシリアライズを行うには <code>JsonUtility.ToJson</code> メソッドを用います。</p>\n<p>参考: <a href=\"https://docs.unity3d.com/ja/current/ScriptReference/JsonUtility.ToJson.html\">JsonUtility-ToJson - Unity スクリプトリファレンス</a></p>\n<p>下記コードのように、シリアライズしたいインスタンスを第１引数に渡すと、戻り値としてJSONが返却されます。先述の通りprivateなフィールドはシリアライズ対象外なので、JSON文字列に <code>PrivateField</code> はJSON文字列に現れません（シリアライズされていません）。ただし、 <code>PrivateSerializeField</code> は <code>SerializeField</code> 属性を付けているのでシリアライズ対象になっているのが確認できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">var</span> test１ <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">TestClass1</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// JSON文字列にシリアライズ</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> test1Json <span class=\"token operator\">=</span> JsonUtility<span class=\"token punctuation\">.</span><span class=\"token function\">ToJson</span><span class=\"token punctuation\">(</span>test1<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"test1: \\n</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">test1Json</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// test1: </span>\n<span class=\"token comment\">// {</span>\n<span class=\"token comment\">//     \"PublicField\": 10,</span>\n<span class=\"token comment\">//     \"PrivateSerializeField\": 30</span>\n<span class=\"token comment\">// }</span></code></pre></div>\n<p>第２引数に <code>true</code> を渡すと、インデントや改行が入った読みやすいJSONが返却されます。デバッグ用にはこちらを <code>true</code> にすると見やすいですが、実際に使うときは改行やインデントが無駄なので <code>false</code> にします。</p>\n<p>JSON文字列からクラスインスタンスの生成、つまりデシリアライズは <code>JsonUtility.FromJson</code> メソッドを用います。</p>\n<p><a href=\"https://docs.unity3d.com/ja/current/ScriptReference/JsonUtility.FromJson.html\">JsonUtility-FromJson - Unity スクリプトリファレンス</a></p>\n<p>引数にJSON文字列を渡し、かつ型パラメータに変換したい型を指定します。戻り値にデシリアライズしたインスタンスが返却されます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">\n<span class=\"token comment\">// JSON文字列からクラスとしてデシリアライズする</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> newTest1\n    <span class=\"token operator\">=</span> JsonUtility<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">FromJson</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>TestClass1<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>test1json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"PublicField = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">newTest1<span class=\"token punctuation\">.</span>PublicField</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// PublicField = 10</span>\n\n<span class=\"token comment\">// privateなのでシリアライズされてずデフォルト値が入る</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"PrivateField = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">newTest1<span class=\"token punctuation\">.</span>PrivateFieldGetter</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// PrivateField = 0</span>\n\n<span class=\"token comment\">// SerializeFieldをつけたのでこっちは大丈夫</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"PrivateIntSerializeField = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">newTest1<span class=\"token punctuation\">.</span>PrivateIntSerializeFieldGetter</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// PrivateIntSerializeField = 30</span></code></pre></div>\n<p>先述の通り、privateなフィールドはシリアライズ対象外なのでデフォルト値が入っています。</p>\n<p>このように <code>JsonUtility</code> を用いると、シリアライズは <code>ToJson</code> 、デシリアライズは <code>FromJson</code> を呼び出すだけと、かんたんにJSONシリアライズが実装できます。</p>\n<p>ちなみに、シリアライズできる型には制限がありますが（よく挙げられる型としては <code>Dictionary</code>  がサポート外）、基本的なプリミティブ型やクラス・構造体はサポートしています。 実際にシリアライズされる型は概ね、 <code>MonoBehaviour</code> や <code>ScriptableObject</code> にフィールドを定義したときに、そのままインスペクターに表示されるフィールドだと考えて大きく齟齬はないです（そのはず…）。つまり <code>SerializeObject</code> および <code>SerializeProperty</code> クラスで扱える型がそのままサポートされる、といった感じでしょうか。</p>\n<h2 id=\"シリアライズをサポートしない型のシリアライズ方法\" style=\"position:relative;\"><a href=\"#%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%BA%E3%82%92%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%AA%E3%81%84%E5%9E%8B%E3%81%AE%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%BA%E6%96%B9%E6%B3%95\" aria-label=\"シリアライズをサポートしない型のシリアライズ方法 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>シリアライズをサポートしない型のシリアライズ方法</h2>\n<p>サポートされていない型も <code>ISerializationCallbackReceiver</code> というインターフェイスをフックし、シリアライズ直前にシリアライズ可能な型のフィールドに格納するなどの工夫を行うことでサポートできます。</p>\n<p>参考: <a href=\"https://kan-kikuchi.hatenablog.com/entry/JsonUtility#%E5%A4%89%E6%8F%9B%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%BA%E3%83%87%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%BA%E6%99%82%E3%81%AE%E5%87%A6%E7%90%86\">UnityでJSONデータを操作(JSONとクラスを変換)するために使えるJsonUtilityとは【Unity】 - (:3[kanのメモ帳]</a></p>\n<p>例として、 <code>Dictionary</code> をシリアライズする例を示します。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">System</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Collections<span class=\"token punctuation\">.</span>Generic</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">UnityEngine</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Serializable</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TestClass6</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">ISerializationCallbackReceiver</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Dictはシリアライズできない</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Dictionary<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span> Dict <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">TestClass6</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Dict <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Dictionary<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// DictのKeyをシリアライズするためのフィールド</span>\n    <span class=\"token comment\">// インスペクターで見えなくてもいいので隠しておく</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">HideInInspector</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">SerializeField</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span> _keys<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// DictのValueをシリアライズするためのフィールド</span>\n    <span class=\"token comment\">// インスペクターで見えなくてもいいので隠しておく</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">HideInInspector</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">SerializeField</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span> _values<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">OnBeforeSerialize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Dictionaryはシリアライズできないため、</span>\n        <span class=\"token comment\">// 代わりにList&lt;T>でシリアライズする</span>\n        _keys <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>Dict<span class=\"token punctuation\">.</span>Count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        _values <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>Dict<span class=\"token punctuation\">.</span>Count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> pair <span class=\"token keyword\">in</span> Dict<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            _keys<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>pair<span class=\"token punctuation\">.</span>Key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            _values<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>pair<span class=\"token punctuation\">.</span>Value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">OnAfterDeserialize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// シリアライズしたデータからDictを復元</span>\n        Dict<span class=\"token punctuation\">.</span><span class=\"token function\">Clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> _keys<span class=\"token punctuation\">.</span>Count<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            Dict<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>_keys<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> _values<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>この例では、 <code>Dict</code> の キーとバリューを、それぞれシリアライズ可能な <code>_keys</code> と <code>_values</code> で保存してシリアライズし、またその値で <code>Dict</code> を復元しています。</p>\n<p>下記コードで、正しくシリアライズとデシリアライズが行えることが確認できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> test6 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">TestClass6</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ntest6<span class=\"token punctuation\">.</span>Dict<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"one\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ntest6<span class=\"token punctuation\">.</span>Dict<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"two\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ntest6<span class=\"token punctuation\">.</span>Dict<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"3\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"three\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> test6Json <span class=\"token operator\">=</span> JsonUtility<span class=\"token punctuation\">.</span><span class=\"token function\">ToJson</span><span class=\"token punctuation\">(</span>test6<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> newTest6 <span class=\"token operator\">=</span> JsonUtility<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">FromJson</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>TestClass6<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>test6Json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"test6.Dict[\\\"1\\\"] = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">newTest6<span class=\"token punctuation\">.</span>Dict<span class=\"token punctuation\">[</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">]</span></span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// test6.Dict[\"1\"] = one</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"test6.Dict[\\\"2\\\"] = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">newTest6<span class=\"token punctuation\">.</span>Dict<span class=\"token punctuation\">[</span><span class=\"token string\">\"2\"</span><span class=\"token punctuation\">]</span></span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// test6.Dict[\"2\"] = two</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"test6.Dict[\\\"3\\\"] = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">newTest6<span class=\"token punctuation\">.</span>Dict<span class=\"token punctuation\">[</span><span class=\"token string\">\"3\"</span><span class=\"token punctuation\">]</span></span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// test6.Dict[\"3\"] = three</span></code></pre></div>\n<h2 id=\"unity標準型のシリアライズ\" style=\"position:relative;\"><a href=\"#unity%E6%A8%99%E6%BA%96%E5%9E%8B%E3%81%AE%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%BA\" aria-label=\"unity標準型のシリアライズ permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Unity標準型のシリアライズ</h2>\n<p><code>JsonUtility</code> で地味に嬉しいのが、 <code>Vector3</code> や <code>AnimationCurve</code> などのUnity標準の型もシリアライズ可能という点です。</p>\n<p>例えば下記の型をシリアライズすると</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">UnityEngine</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TestClass3</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">MonoBehaviour</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">AnimationCurve</span> Curve<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Vector3</span> Vector<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>下記のようにJSONにシリアライズされます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">test3<span class=\"token punctuation\">:</span> \n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Curve\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"serializedVersion\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"m_Curve\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token string\">\"serializedVersion\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"time\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"value\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"inSlope\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"outSlope\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"tangentMode\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"weightedMode\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"inWeight\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"outWeight\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.0</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token string\">\"serializedVersion\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"time\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"value\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"inSlope\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"outSlope\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"tangentMode\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"weightedMode\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"inWeight\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"outWeight\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.0</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"m_PreInfinity\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"m_PostInfinity\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"m_RotationOrder\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"Vector\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"x\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"y\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2.0</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"z\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3.0</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>たとえばカーブ単体をテキストとして保存して管理したいなどのケースがあったときに、サクッとJSONにできるのは便利だと感じています。特に <code>AnimationCurve</code> のようなクラスは保持するデータも結構複雑なので、標準でシリアライズできるのは結構ありがたいと感じています（これは考えてみれば当たり前な話なんですが…）。</p>\n<p>ちなみに、たとえば <code>AnimationCurve</code> オブジェクトそのままをシリアライザすることはできないようで、その場合は下記のように <code>AnimationCurve</code> だけを持つクラスのインスタンスにカーブを渡して、そのインスタンスを <code>JsonUtility.ToJson</code> でシリアライズすればよいです。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Serializable</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">WrappedAnimationCurve</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">AnimationCurve</span> Curve<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token function\">WrappedAnimationCurve</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AnimationCurve</span> curve<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Curve <span class=\"token operator\">=</span> curve<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// カーブを（ほぼ）単体でJSON文字列化できる</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> curveJson <span class=\"token operator\">=</span> JsonUtility<span class=\"token punctuation\">.</span><span class=\"token function\">ToJson</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">WrappedAnimationCurve</span><span class=\"token punctuation\">(</span>test3<span class=\"token punctuation\">.</span>Curve<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"monobehaviourやscriptableobjectを継承する型のデシリアライズ\" style=\"position:relative;\"><a href=\"#monobehaviour%E3%82%84scriptableobject%E3%82%92%E7%B6%99%E6%89%BF%E3%81%99%E3%82%8B%E5%9E%8B%E3%81%AE%E3%83%87%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%BA\" aria-label=\"monobehaviourやscriptableobjectを継承する型のデシリアライズ permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MonoBehaviourやScriptableObjectを継承する型のデシリアライズ</h2>\n<p><code>JsonUtility</code> では <code>MonoBehaviour</code> や <code>ScriptableObject</code> を継承する型もJSONにシリアライズできますが、特にデシリアライズ（JSONからオブジェクトを生成）する際に少し注意が必要です。</p>\n<p>具体的には、 <code>MonoBehaviour</code> や <code>ScriptableObject</code> は <code>JsonUtility.FromJson</code> でデシリアライズできない点です。</p>\n<p>下記コードを実行すると、</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// Test5Classコンポーネントがアタッチされている</span>\n<span class=\"token comment\">// ゲームオブジェクト上でテストしている前提</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> test5 <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>gameObject<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetComponent</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>TestClass5<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// シリアライズは問題なくうごく</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> test5Json <span class=\"token operator\">=</span> JsonUtility<span class=\"token punctuation\">.</span><span class=\"token function\">ToJson</span><span class=\"token punctuation\">(</span>test5<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// ここでエラー</span>\n<span class=\"token comment\">// ArgumentException: Cannot deserialize JSON to new instances of type 'TestClass5.'</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> newTest5 <span class=\"token operator\">=</span> JsonUtility<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">FromJson</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>TestClass5<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>test5Json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>下記のようなエラーが出ます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">ArgumentException<span class=\"token punctuation\">:</span> Cannot deserialize JSON to <span class=\"token keyword\">new</span> instances of type 'TestClass5<span class=\"token punctuation\">.</span>'\nUnityEngine<span class=\"token punctuation\">.</span>JsonUtility<span class=\"token punctuation\">.</span>FromJson <span class=\"token punctuation\">(</span><span class=\"token class-name\">System<span class=\"token punctuation\">.</span>String</span> json<span class=\"token punctuation\">,</span> <span class=\"token class-name\">System<span class=\"token punctuation\">.</span>Type</span> type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>at <span class=\"token operator\">&lt;</span>e000c5ade9084c9c844e11c13b6c7613<span class=\"token operator\">></span><span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\nUnityEngine<span class=\"token punctuation\">.</span>JsonUtility<span class=\"token punctuation\">.</span>FromJson<span class=\"token punctuation\">[</span>T<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">System<span class=\"token punctuation\">.</span>String</span> json<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>at <span class=\"token operator\">&lt;</span>e000c5ade9084c9c844e11c13b6c7613<span class=\"token operator\">></span><span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>おそらく <code>MonoBehaviour</code> は <code>GameObject.AddComponent</code> で、 <code>ScriptableObject</code> は <code>ScriptableObject.CreateInstance</code> で生成する必要があるため上記のエラーがでるのだと思います。</p>\n<p>これを回避するには、インスタンス生成自体は自分で行って（具体的には <code>MonoBehaviour</code> の場合は <code>GameObject.AddComponent</code> で生成して）、そのインスタンスのフィールドを、シリアライズされたJSONで上書きするというアプローチを取ります。</p>\n<p>具体的には <code>JsonUtility.FromJsonOverride</code> というメソッドを利用します。下記コードに実例を示します。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> test5 <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>gameObject<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetComponent</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>TestClass5<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ntest5<span class=\"token punctuation\">.</span>Name <span class=\"token operator\">=</span> <span class=\"token string\">\"Test5\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> test5Json <span class=\"token operator\">=</span> JsonUtility<span class=\"token punctuation\">.</span><span class=\"token function\">ToJson</span><span class=\"token punctuation\">(</span>test5<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> newTest5 <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>gameObject<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddComponent</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>TestClass5<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// test5のプロパティでnewTest5を上書き</span>\nJsonUtility<span class=\"token punctuation\">.</span><span class=\"token function\">FromJsonOverwrite</span><span class=\"token punctuation\">(</span>test5Json<span class=\"token punctuation\">,</span> newTest5<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"newTest5.Name = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">newTest5<span class=\"token punctuation\">.</span>Name</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// newTest5.Name = Test5</span></code></pre></div>\n<p>ここで、JSONで設定したフィールド情報にインスタンスの初期化をしたくなると思いますが、<code>gameObject.AddComponent&#x3C;TestClass5>()</code> を呼び出したタイミングで <code>Awake</code> も呼び出される可能性があるため、 <code>Awake</code> では <code>FromJsonOverwrite</code> で上書きしたプロパティをもとに初期化は行えません。一方で <code>Start</code> メソッドは、そのコンポーネントを作成した後の一番初めの Update メソッド前に呼び出されるため、JsonUtility経由でプロパティを上書きすることが前提のクラスの場合、 <code>AddComponent</code> 直後に <code>FromJsonOverwrite</code> でプロパティを上書きし、 <code>Start</code> メソッドで初期化するのが良いでしょう。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">UnityEngine</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TestClass5</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">MonoBehaviour</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> Name<span class=\"token punctuation\">;</span>\n\n    <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Awake</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// ここでは Name はnullで来る可能性がある</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// AddComponent直後でFromJsonOverwriteで</span>\n        <span class=\"token comment\">// 上書きすれば、ここでは値が入っている</span>\n        Debug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"Name = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">Name</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"unityobjectの参照のシリアライズとeditorjsonutilityについて\" style=\"position:relative;\"><a href=\"#unityobject%E3%81%AE%E5%8F%82%E7%85%A7%E3%81%AE%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%BA%E3%81%A8editorjsonutility%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"unityobjectの参照のシリアライズとeditorjsonutilityについて permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Unity.Objectの参照のシリアライズとEditorJsonUtilityについて</h2>\n<p>最後に UnityEngine.Object の参照のシリアライズについて触れておきます。</p>\n<p>具体的には下記のような型のインスタンスをシリアライズするケースです。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">UnityEngine</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TestClass4</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">MonoBehaviour</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// シーン中のゲームオブジェクトの参照や</span>\n    <span class=\"token comment\">// プレハブの参照</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">GameObject</span> Obj<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>このようなクラスのインスタンスをシリアライズして生成されるJSONは下記のとおりです。</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Obj\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"instanceID\"</span><span class=\"token operator\">:</span> <span class=\"token number\">24370</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>このようにUnity.Object の参照は、参照先のオブジェクトのインスタンスIDをシリアライズします。</p>\n<p>試しに、下記のようなコードでシリアライズとデシアライズを行ってみます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> test4 <span class=\"token operator\">=</span> <span class=\"token generic-method\"><span class=\"token function\">GetComponent</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>TestClass4<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> test4Json <span class=\"token operator\">=</span> JsonUtility<span class=\"token punctuation\">.</span><span class=\"token function\">ToJson</span><span class=\"token punctuation\">(</span>test4<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"test4: \\n</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">test4Json</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> newTest4 <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>gameObject<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddComponent</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>TestClass4<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nJsonUtility<span class=\"token punctuation\">.</span><span class=\"token function\">FromJsonOverwrite</span><span class=\"token punctuation\">(</span>test4Json<span class=\"token punctuation\">,</span> newTest4<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>上記コードによるデシリアライズによる結果を下図に示します。上が元となるコンポーネント（ <code>test4</code> ）で、下が生成したコンポーネント（ <code>newTest4</code> ）です。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 451px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ecae60af87624f720138befb83a431ba/38070/0D959DBE873822315E13FC4602DF5074.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA6ElEQVQoz3WR26qDMBBF8yXeQPGaGO+KYsXoc+n//8s+7IDlUNuHxSRxsmYyiufria7rYIzBcRzY992uz/PEsixomgZt2/6E37dtw7quGIYBgrKyLKG1vlFVlY1SSkglkWUZkiS5wXPCPMEKvxLjOLZSJrJonufwfR+e573h3nEcuK4LpRTEY3tASWXbJX3fW7i+ZITJhNL/sBk2Vde1fY0wh4EuNaZpsozjaJnn2YovEaVFUbwLXPCMY6PUCmnmYZqmN9gBkxh5mWMIguDG9Xx6BP8UL3DzCaWcHTukmDGKIoRh+BXO8A/VH9juOQZr/QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"0D959DBE873822315E13FC4602DF5074\"\n        title=\"0D959DBE873822315E13FC4602DF5074\"\n        src=\"/static/ecae60af87624f720138befb83a431ba/38070/0D959DBE873822315E13FC4602DF5074.png\"\n        srcset=\"/static/ecae60af87624f720138befb83a431ba/772e8/0D959DBE873822315E13FC4602DF5074.png 200w,\n/static/ecae60af87624f720138befb83a431ba/e17e5/0D959DBE873822315E13FC4602DF5074.png 400w,\n/static/ecae60af87624f720138befb83a431ba/38070/0D959DBE873822315E13FC4602DF5074.png 451w\"\n        sizes=\"(max-width: 451px) 100vw, 451px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><code>Main Camera</code> はシーン中のゲームオブジェクトです。このように正しく参照を復元できています。</p>\n<p>しかしインスタンスIDはインスタンス生成時に生成されるため、特に参照にプレハブやテクスチャなどのアセットを参照する場合には問題になります。また、生成したJSONをファイルに書き出しておき、ゲームを再起動した状態で生成したJSONでインスタンスを復元したとしても、参照は正しく復元できません。</p>\n<p>そのため、参照をシリアライズする場合はこの挙動を理解した上での対応が必要になります。状況によっては、独自のシリアライズを検討したほうが良いでしょう。</p>\n<p>また、ここで似たようなクラスに <code>EditorJsonUtility</code> があり、こちらはアセットの参照を下記のようにGUIDを元に保持します。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"MonoBehaviour\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"m_Enabled\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"m_EditorHideFlags\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"m_Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"m_EditorClassIdentifier\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Obj\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"fileID\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2996958370322343278</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"guid\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"a8c4c077af349eb45ab8edbc6d1dcc29\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"type\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>そのため、アセットを参照する場合は <code>EditorJsonUtility.FromJsonOverwrite</code> を用いた方が良いでしょう。ただし、 <code>EditorJsonUtility</code> はエディタ限定機能で、また <code>EditorJsonUtility.ToJson</code> で生成したJSONは <code>JsonUtility.FromJson</code> で利用できない点も注意です。</p>\n<p>参考: <a href=\"https://light11.hatenadiary.com/entry/2021/02/17/213232\">【Unity】JsonUtilityとEditorJsonUtilityの違いをちゃんと理解する - LIGHT11</a></p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>JsonUtilityの基本的な使い方についてまとめました。</p>\n<h2 id=\"参考\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://kan-kikuchi.hatenablog.com/entry/JsonUtility#%E5%A4%89%E6%8F%9B%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%BA%E3%83%87%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%BA%E6%99%82%E3%81%AE%E5%87%A6%E7%90%86\">UnityでJSONデータを操作(JSONとクラスを変換)するために使えるJsonUtilityとは【Unity】 - (:3[kanのメモ帳]</a></li>\n<li><a href=\"https://nekosuko.jp/1893/\">【Unity】JsonUtilityを使ったJson化 - nekosuko.jp</a></li>\n<li><a href=\"https://docs.unity3d.com/ja/2018.4/Manual/JSONSerialization.html\">JSON 形式にシリアライズ - Unity マニュアル</a></li>\n<li><a href=\"https://logicalbeat.jp/blog/8195/\">【Unity】JsonUtilityを触ってみた – 株式会社ロジカルビート</a></li>\n<li><a href=\"https://qiita.com/keidroid/items/24e03f82d74560dc557a\">UnityのJsonUtilityの細かい10の疑問をいまさら検証した - Qiita</a></li>\n<li><a href=\"https://qiita.com/sea_mountain/items/6513b330983ffa003959\">JsonUtility をつかって Unity で JSON を取り扱う方法 - Qiita</a></li>\n<li><a href=\"https://light11.hatenadiary.com/entry/2021/02/17/213232\">【Unity】JsonUtilityとEditorJsonUtilityの違いをちゃんと理解する - LIGHT11</a></li>\n</ul>","excerpt":"JsonUtility を用いると、シリアライズ可能なオブジェクトをJSONとして文字列に変換（シリアライズ）し、またはJSON文字列から対応するオブジェクトを生成（デシリアライズ）できます。 サーバーと通信するときのフォーマットとしてJSONがよく用いられるため、これらの用途だったり、シリアライズできるということはつまりクラスインスタンスを文字列として表現できるということなので、たとえばゲームの状態を表す型をJSON…","fields":{"slug":"/2022/06/jsonutility-serialize-deserialize-unity-object/"},"frontmatter":{"date":"June 10, 2022","type":"tech","tags":["Unity","JsonUtility","Serialize","C#"],"title":"JsonUtilityでオブジェクトをシリアライズしたりデシリアライズしたりする","description":"JsonUtilityの基本的な使い方について紹介します。","eyecatch":null}}},"pageContext":{"id":"58fc92a4-c920-5529-b8a5-10838e502662"}},"staticQueryHashes":["1480509143","3159585216"]}