{"componentChunkName":"component---src-templates-post-tsx","path":"/2022/12/csharp-advent-calendar-system-text-json-unity/","result":{"data":{"markdownRemark":{"html":"<p>この記事は<a href=\"https://qiita.com/advent-calendar/2022/csharplang\">C# Advent Calendar 2022</a>の23日目の記事です。</p>\n<p>Unity 2021.2 から Source Generatorが利用できるようになりました。</p>\n<p>これによってUnityでも、Microsoftが提供するJsonシリアライザー <code>System.Text.Json</code> のソース生成を利用できるようになりました。</p>\n<p><code>System.Text.Json</code> のソース生成は、C#のSource Generatorを用いてシリアライズおよびデシリアライズのコードをビルド時に生成することで、シリアライザーのパフォーマンスを向上させるものです。</p>\n<p><a href=\"https://devblogs.microsoft.com/dotnet/try-the-new-system-text-json-source-generator/\">Try the new System.Text.Json source generator - .NET Blog</a></p>\n<p>この記事では、Unityで <code>System.Text.Json</code> のソース生成を利用するための環境構築と、実際にコード生成を用いたJSONシリアライズ・デシリアライズの動作確認、最後にUnityアプリとして実機で動かしてそのパフォーマンスを比較してみます。あわせてUnity公式が提供するJSONシリアライザーの <code>JsonUtility</code> ともパフォーマンスの比較を行ってみます。</p>\n<p>検証環境は以下の通りです。</p>\n<ul>\n<li>macOS Monterey 12.5</li>\n<li>MacBookPro（2018）、2.9GHz 6-Core Intel Core i9、32GB</li>\n<li>Unity 2021.3.14f1</li>\n<li>Rider 2022.2</li>\n<li>iPhone X</li>\n</ul>\n<p>ちなみに、Unity 2022.2.0b16では動作が確認できませんでした。\n（おそらく内部のSource Generatorのバージョンが変わった？）</p>\n<h2 id=\"systemtextjsonをunityに導入する\" style=\"position:relative;\"><a href=\"#systemtextjson%E3%82%92unity%E3%81%AB%E5%B0%8E%E5%85%A5%E3%81%99%E3%82%8B\" aria-label=\"systemtextjsonをunityに導入する permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>System.Text.JsonをUnityに導入する</h2>\n<p>前述の通り、Unity 2021.2からSource Generatorが利用できるようになりました。</p>\n<p><a href=\"https://docs.unity3d.com/2021.3/Documentation/Manual/roslyn-analyzers.html\">Unity - Manual: Roslyn analyzers and source generators</a></p>\n<p>Unityでは現状<code>System.Text.Json</code>の 6.0.0-previewが利用できます。下記はドキュメントからの抜粋です。</p>\n<p>このバージョンから、ソース生成によるシリアライズとデシリアライズがサポートされています。ちなみに6.0.0でのソース生成は、Unityがサポートしている<a href=\"https://www.nuget.org/packages/Microsoft.CodeAnalysis.CSharp/3.8.0\">Microsoft.CodeAnalysis 3.8</a>よりも後のバージョン（3.11）が利用されているため利用できないようです（おそらく）。</p>\n<p>Unityで<code>System.Text.Json</code>を利用するには、<code>System.Text.Json</code>本体とそれが依存するパッケージをすべてnugetから持ってくる必要があります。具体的には下記のパッケージをすべてインストールする必要があります。</p>\n<ul>\n<li><a href=\"https://www.nuget.org/packages/System.Text.Json/6.0.0-preview.7.21377.19\">System.Text.Json</a></li>\n<li><a href=\"https://www.nuget.org/packages/System.Text.Encodings.Web/6.0.0-preview.7.21377.19\">System.Text.Encodings.Web</a></li>\n<li><a href=\"https://www.nuget.org/packages/System.Runtime.CompilerServices.Unsafe/\">System.Runtime.CompilerServices.Unsafe</a></li>\n<li><a href=\"https://www.nuget.org/packages/Microsoft.Bcl.AsyncInterfaces/6.0.0\">Microsoft.Bcl.AsyncInterfaces</a></li>\n</ul>\n<p>それぞれ上記のページに飛んで「Download package」をクリックしてnupkgを落としてきます。</p>\n<p>次にnupkgをzipとして解凍します。Macであればファイル名末尾にzipを付けたあとにそのファイルをダブルクリックで解凍できます。解凍後のフォルダをひらくと、<code>lib/netstandard2.0</code>または <code>lib/netstandard2.1</code>フォルダ内にパッケージ名と同じ名前のdllがあるので、Unityプロジェクト配下に配置します（下図は<code>System.Text.Json</code>パッケージの例）。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 757px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f25ae9e4b5757e419b0ee0689034ab00/1fbe8/09ACD05FCE95B9E3B2D55CB764D9B6D7.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABfElEQVQoz12Py27UQBBF/f2DFEVKxCZrpGSIFFiwzBcgkWxgwTywJ35022177Ha/G92oa2AEWRxV162q21XZ2M9YZoO65Mj3LzjkFYpfJV6KGkVeUn7IS4h2RN8dMY0LWtaDN4K0RMrlpKmeaeMg+gFGG4QQ4ZwnvPOw1sH7QPk0zUTwATFEaG1Ij/E3FrnQbNKzblIoqgZSzpjmGcYk4wAfwjl67zGMA4ZhgFIKPnhCaUV50mcpYaxFdhAznn78xG67Qdt1UFrDWkvFxN83YxydEFiUOuvJTEoJxjnG4xFaa2TbUuD5+wacs9MZ3lOzdY5OPsVkyMB5Swak/UEuC+qmoS2dc8jaSePrpkTLGXyI583ekobShm91bQzVknH6IJuNxbd9jf1uA8YahOAQE/EfgkMvWkzT8H8tOOrvRQdrFGL0yD48dlitc1x93OJyvcPNF4aL+xqr2wrv7iqs7lKscbEucP1Q4uqhOem3FfW9/9zg8v6A60/pzfAKKA5XQ6hQGo0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"09ACD05FCE95B9E3B2D55CB764D9B6D7\"\n        title=\"09ACD05FCE95B9E3B2D55CB764D9B6D7\"\n        src=\"/static/f25ae9e4b5757e419b0ee0689034ab00/1fbe8/09ACD05FCE95B9E3B2D55CB764D9B6D7.png\"\n        srcset=\"/static/f25ae9e4b5757e419b0ee0689034ab00/772e8/09ACD05FCE95B9E3B2D55CB764D9B6D7.png 200w,\n/static/f25ae9e4b5757e419b0ee0689034ab00/e17e5/09ACD05FCE95B9E3B2D55CB764D9B6D7.png 400w,\n/static/f25ae9e4b5757e419b0ee0689034ab00/1fbe8/09ACD05FCE95B9E3B2D55CB764D9B6D7.png 757w\"\n        sizes=\"(max-width: 757px) 100vw, 757px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>上記のDLLをすべてUnityプロジェクトに配置すると、いままでのリフレクションベースな <code>System.Text.Json</code>が利用できます。下記コードのように<code>JsonSerializer</code>の<code>Serialize</code>と<code>Deserialize</code>を呼び出すことで、クラスとJSONの相互変換ができます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Person</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> Age <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Name <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> p <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Person</span>\n<span class=\"token punctuation\">{</span>\n    Age <span class=\"token operator\">=</span> <span class=\"token number\">40</span><span class=\"token punctuation\">,</span>\n    Name <span class=\"token operator\">=</span> <span class=\"token string\">\"John\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// シリアライズ</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> json <span class=\"token operator\">=</span> JsonSerializer<span class=\"token punctuation\">.</span><span class=\"token function\">Serialize</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// {\"Age\":40,\"Name\":\"John\"}</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">json</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// デシリアライズ</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> val <span class=\"token operator\">=</span> JsonSerializer<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Deserialize</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Person<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 40, John</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span>Age</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">, </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span>Name</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>次に、<code>System.Text.Json</code>のソース生成機能をUnityに持ってきます。さきほど解凍した<code>System.Text.Json</code>のnupkgの中に、下図のようにSystem.Text.Json.SourceGeneration.dllがあるので、これをUnityプロジェクトに配置します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 585px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5ceecd61553cd2cc6a19109208384718/78a22/62E0EC4E0F305E035E1C50CA79BE7EA6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABXklEQVQoz5XS3UobQRjG8blyD3oDhV5BoRILgtVCoUW7Ww8KBSExtiSiSbNfNibrzuxnZrOz2X+JRlEJRAd+88x7Ng8zQskYGSmW6boenus/4XsBruPdpuf5BP7d7IxckjglS3PSJCNN7whjalSSEIYhj1fTLLcVnp1Xc10vqOv6CSFzzeU4Io0VuiwpigKtNcYYKlNR3eZ6Zg0xTQpOzh3+/D5jOHLxgysm4Q0zPaeYaYpZ+SB/AUEz5+JG8tcbYbRa9aqBag2zkbDbCW9a17w9CNg9VuzYMR8OI7aPJC1LsmMrPtqK998i3u2HGwmrq9hqDflsDdj+0mfvR4B1mmOf5lidjKN2wvdOwteTmE8/FfsbiOU1PSnpXfQZ+wOmY4dKx5SFpDH5qsorKlflnK4z4Ve7S6/X53IwZDINCa7+EUnFrLx/nJcRMlScdc4ZT67JsuzZX2yoFwsWr/Af63nukqdzDnkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"62E0EC4E0F305E035E1C50CA79BE7EA6\"\n        title=\"62E0EC4E0F305E035E1C50CA79BE7EA6\"\n        src=\"/static/5ceecd61553cd2cc6a19109208384718/78a22/62E0EC4E0F305E035E1C50CA79BE7EA6.png\"\n        srcset=\"/static/5ceecd61553cd2cc6a19109208384718/772e8/62E0EC4E0F305E035E1C50CA79BE7EA6.png 200w,\n/static/5ceecd61553cd2cc6a19109208384718/e17e5/62E0EC4E0F305E035E1C50CA79BE7EA6.png 400w,\n/static/5ceecd61553cd2cc6a19109208384718/78a22/62E0EC4E0F305E035E1C50CA79BE7EA6.png 585w\"\n        sizes=\"(max-width: 585px) 100vw, 585px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>次にプロジェクトビューでSystem.Text.Json.SourceGenerator.dllを選択して、インスペクター上で下記の設定を行います。</p>\n<ol>\n<li>「Select platforms for plugin」ですべてのプラットフォームのチェックを外す</li>\n<li>「Asset Labels」に「RoslynAnalyzer」を設定する</li>\n</ol>\n<p>具体的には、下図のように設定します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 762px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5a9a066a8b653955be6a35e758a44805/a016c/B102B22AF45A7E5C6473C0DB73AD26C6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 91.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAACaElEQVQ4y5WUT2sTQRjG34r2C9hubcjBbDbzP5mdTXZTCYVQhKZSD+Kn8CIeeq9+CkEw4EUq+G0qRcEk5FIvRfBm2DQj7ySzJLXYuvDj3Xdn9tlnHmYWTp7uwYukXj04kIcPFd2XTPS4ED0hRI9z7uh2uw7fL48JIfaFEIeMMdLpdADevnoJu1q/6+ymVmhtKSGWUuoghDjq9brD937cz8EaRdHHo6MjAGstcKXeZ9mO1Vr/VkpNESnldPleCFH0CGNsSimdEkImaZpaKeUJAKzBr4sLiKKor7W2jLGcMTbjnBdc7ZefL8byJElwBZ+c4NnZGVQqlb4xxhpjciEE2nfUarUbiaIoxyqEmAsOh0MIw9A5jOM4x4p5Mcb+yus6CCE55xyXPBccDAZOsNls2jRNcxRDlyi2cHCTyxyFC4ej0cgJLnLADG21Wi2Elu99FFdYFRyPx06w0Wg4+2EYrjhDQS96K0GfYRzHzqFS6sbcbp1hlmU5CkspbwVmrZRyuReCp6enbtssvpj703D1VCz3mDNWXE2r1cpxYyul5oLn5z8grFadQ1zywr6bjHg3vkdX/iPeIW61QvD7ty8QhpV+MzFWSZkbY2btdnvWaDRmUsoVlFLulFBK3SnBihmiY87ZXBDPMqGi38w61rR2JpzzSynlJVZK6bUwxpb7CefCRjU6F/z60wLh+kOcda0yj6zWcfF3+Re4zeLY4A/F6jixop58Bn8Fmxt75dKD18Hm/eNyuXy8tbVVEATBCv4ZVpxbKpWOt7e33wTBxj4A3IHnzw7BWQW4CwDrAHDvP1lfvLv2pPcY/gBuj8wyt3MEXQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"B102B22AF45A7E5C6473C0DB73AD26C6\"\n        title=\"B102B22AF45A7E5C6473C0DB73AD26C6\"\n        src=\"/static/5a9a066a8b653955be6a35e758a44805/a016c/B102B22AF45A7E5C6473C0DB73AD26C6.png\"\n        srcset=\"/static/5a9a066a8b653955be6a35e758a44805/772e8/B102B22AF45A7E5C6473C0DB73AD26C6.png 200w,\n/static/5a9a066a8b653955be6a35e758a44805/e17e5/B102B22AF45A7E5C6473C0DB73AD26C6.png 400w,\n/static/5a9a066a8b653955be6a35e758a44805/a016c/B102B22AF45A7E5C6473C0DB73AD26C6.png 762w\"\n        sizes=\"(max-width: 762px) 100vw, 762px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>これでソース生成を含めた<code>System.Text.Json</code>の導入が完了しました。</p>\n<h2 id=\"ソース生成でのjson\" style=\"position:relative;\"><a href=\"#%E3%82%BD%E3%83%BC%E3%82%B9%E7%94%9F%E6%88%90%E3%81%A7%E3%81%AEjson\" aria-label=\"ソース生成でのjson permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ソース生成でのJSON</h2>\n<p>のシリアライズ・デシリアライズを試す</p>\n<p>それではSource Generatorでのソース生成とシリアライズ・デシリアライズを試してみます。ソース生成経由でのシリアライズは、下記ドキュメントに詳細が記載されています。</p>\n<p><a href=\"https://learn.microsoft.com/en-us/dotnet/standard/serialization/system-text-json/source-generation?pivots=dotnet-6-0\">How to use source generation in System.Text.Json | Microsoft Learn</a></p>\n<p>また、下記ブログでも利用方法が説明されています。</p>\n<p><a href=\"https://devblogs.microsoft.com/dotnet/try-the-new-system-text-json-source-generator/\">Try the new System.Text.Json source generator - .NET Blog</a></p>\n<p>実際に、先程の<code>Person</code>クラスをソース生成経由でシリアライズとデシリアライズしてみます。大まかには下記の手順です。</p>\n<ol>\n<li><code>JsonSerializeContext</code>を継承したpartialなクラスを作る</li>\n<li>1.で作ったクラスに<code>JsonSerializable</code>属性を指定する</li>\n<li>2.で作成したクラスにSource Generator経由で<code>JsonTypeInfo&#x3C;T></code>の実装などが生成されるので、それをシリアライズ・デシリアライズの引数に渡す</li>\n</ol>\n<p>具体的には、シリアライズしたいクラスをさきほどの<code>Person</code>として、下記のようなクラスを用意します。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">JsonSerializable</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\">Person</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">internal</span> <span class=\"token keyword\">partial</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PersonJsonContext</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">JsonSerializerContext</span></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>このクラスを用いて、ソース生成を用いたシリアライズは下記のように行います。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> p <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Person</span>\n<span class=\"token punctuation\">{</span>\n    Age <span class=\"token operator\">=</span> <span class=\"token number\">40</span><span class=\"token punctuation\">,</span>\n    Name <span class=\"token operator\">=</span> <span class=\"token string\">\"John\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// シリアライズ</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> json <span class=\"token operator\">=</span> JsonSerializer<span class=\"token punctuation\">.</span><span class=\"token function\">Serialize</span><span class=\"token punctuation\">(</span>\n    p<span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// 生成されたJsonTypeInfoを渡す</span>\n    PersonJsonContext<span class=\"token punctuation\">.</span>Default<span class=\"token punctuation\">.</span>Person\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// {\"Age\":40,\"Name\":\"John\"}</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">json</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// デシリアライズ</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> val <span class=\"token operator\">=</span> JsonSerializer<span class=\"token punctuation\">.</span><span class=\"token function\">Deserialize</span><span class=\"token punctuation\">(</span>\n    json<span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// こっちも同様</span>\n    PersonJsonContext<span class=\"token punctuation\">.</span>Default<span class=\"token punctuation\">.</span>Person\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 40, John</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span>Age</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">, </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span>Name</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>シリアライズおよびデシリアライズ時に生成された<code>JsonTypeInfo&#x3C;T></code>（上記だと<code>PersonJsonContext.Default.Person</code>）渡します。それ以外は特に変わりません。簡単ですね。</p>\n<h2 id=\"パフォーマンス比較\" style=\"position:relative;\"><a href=\"#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E6%AF%94%E8%BC%83\" aria-label=\"パフォーマンス比較 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>パフォーマンス比較</h2>\n<p>ここまででソース生成によるシリアライズとデシリアライズの方法を紹介したので、ソース生成の有無によるパフォーマンスを比較してみます。下記の３種類のクラスをそれぞれシリアライズ・デシリアライズしたときの速度を計測してみます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// サンプルで取り上げたシンプルなケース</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Person</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> Age <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Name <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 一通りの基本型を持ったクラス</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Primitives</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">short</span></span> Short <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> Int <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">long</span></span> Long <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">byte</span></span> Byte <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> Bool <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">char</span></span> Char <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">float</span></span> Float <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">double</span></span> Double <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> String <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// クラスがネストするケース</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">NestCase</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Inner</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> Int <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">double</span></span> Double <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> String <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Inner</span> A <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Inner</span> B <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Inner</span> C <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Inner</span> D <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Inner</span> E <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Inner</span> F <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Inner</span> G <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Inner</span> H <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Inner</span> I <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"実機上でのパフォーマンス計測について\" style=\"position:relative;\"><a href=\"#%E5%AE%9F%E6%A9%9F%E4%B8%8A%E3%81%A7%E3%81%AE%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E8%A8%88%E6%B8%AC%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"実機上でのパフォーマンス計測について permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>実機上でのパフォーマンス計測について</h3>\n<p>計測はiOSの実機上で行います。実機上でのパフォーマンス計測には<a href=\"https://docs.unity3d.com/Packages/com.unity.test-framework.performance@2.8/manual/index.html\">Performance Testing Extension</a>という、Unity Test Runner上でパフォーマンス計測を行ってくれるツールを用いました。</p>\n<p>たとえば下記のようなコードを記述して、</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Test</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Performance</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">SimplePerson_Serialize_SourceGenerator_Check</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    Measure<span class=\"token punctuation\">.</span><span class=\"token function\">Method</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">int</span></span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            JsonSerializer<span class=\"token punctuation\">.</span><span class=\"token function\">Serialize</span><span class=\"token punctuation\">(</span>\n                PersonTests<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> PersonJsonContext<span class=\"token punctuation\">.</span>Default<span class=\"token punctuation\">.</span>Person<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Test Runnerを実行することで、上記の<code>Measure.Method</code>に渡したメソッドの処理を、複数回実行して計測し、その平均や分散などを下図のように報告してくれます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2c50e216244e00b3bc868ea873740d69/96220/8C9B13DD254F5B30CAA532C92A7F95E6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACHUlEQVQoz5XOy3LSUBgH8DPj0LhxXDDDoG2gkcAhFHIOuZAQUjgJCbRWF+6ccRF9i/oktLDpY6hv4cpVdXyCXhKqSDifA23xsmPxm///XL6ZD7UfSQ9fhObrmlp7V3omRxWMo0rlDsYRxjgyzVZk2XaEcTWqKkpUrf5FUaJypfJWluU3kiQ9Rk9yeXnf7fBWywRD14ASFYjaWOdeTYFGfW9l2f9XUxRoUgKGoUOhULDR0+1tbLks7rAQuv3h3GVh6np/2K6XGu1uajq91HK91N73VyyXpe1ldtjc6QULq9OdFQsFB4mFIra854k7eAW2f7Qwewe8xQ75fbZ6B7zpDnjD9nnd8jlxgjXqBLxhewvaGQBte7+KxaKDdpYbmnpiWyb4fsA9z4d+P4QwHEIQDoAxD4IghOHwEHy/v7J8X/5jzIejo5fcYwy0Jp0riuKgXUnCtbqaDIYHcHF5xZPpDcTJFJLkNuN4CtfxFH78nMF1nKx6nNys+sXlFQAA//DxEzDPm5fLZQeJoogbDTXpuC6MRiM+Ho/h9PR07f48mUz+uV86ORnB2dkZf398DI7j3G6Yy+UqhJCYEAKyLKeyLC82USqVUoyrXNO0GSGkjfL5fJVSOm82m6Dr+sYMwwBN01adEOKibDa7q6rqZ0rpd0LIOSHk64bOKaXf6vX6F1EUCUIIPchkMtuCIEhbW1u7giBs5G5GQgjtIIQyvwE6GlL+aJ05AAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"8C9B13DD254F5B30CAA532C92A7F95E6\"\n        title=\"8C9B13DD254F5B30CAA532C92A7F95E6\"\n        src=\"/static/2c50e216244e00b3bc868ea873740d69/5a190/8C9B13DD254F5B30CAA532C92A7F95E6.png\"\n        srcset=\"/static/2c50e216244e00b3bc868ea873740d69/772e8/8C9B13DD254F5B30CAA532C92A7F95E6.png 200w,\n/static/2c50e216244e00b3bc868ea873740d69/e17e5/8C9B13DD254F5B30CAA532C92A7F95E6.png 400w,\n/static/2c50e216244e00b3bc868ea873740d69/5a190/8C9B13DD254F5B30CAA532C92A7F95E6.png 800w,\n/static/2c50e216244e00b3bc868ea873740d69/96220/8C9B13DD254F5B30CAA532C92A7F95E6.png 1165w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Performance Testing Extensionについては下記の記事にてインストール方法や利用方法を記載していますので、興味があればご確認ください。</p>\n<p><a href=\"https://blog.yucchiy.com/2021/09/unity-performance-testing/\">Performance Testing Extensionを用いてUnityで実機でパフォーマンス計測をおこなう | Yucchiy's Note</a></p>\n<h3 id=\"計測対象について\" style=\"position:relative;\"><a href=\"#%E8%A8%88%E6%B8%AC%E5%AF%BE%E8%B1%A1%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"計測対象について permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>計測対象について</h3>\n<p>今回は下記の４つでパフォーマンスを比較しました。</p>\n<ul>\n<li>ソースコード生成なしの<code>System.Text.Json</code>での文字列へのシリアライズとデシリアライズ</li>\n<li>ソースコード生成ありの<code>System.Text.Json</code>での文字列へのシリアライズとデシリアライズ</li>\n<li>ソースコード生成ありの<code>System.Text.Json</code>でのUTF-8 バイト配列へのシリアライズとデシリアライズ</li>\n<li><code>JsonUtility</code>での文字列へのシリアライズとデシリアライズ</li>\n</ul>\n<h3 id=\"jsonutilityについて\" style=\"position:relative;\"><a href=\"#jsonutility%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"jsonutilityについて permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>JsonUtilityについて</h3>\n<p><code>JsonUtility</code>はUnityが標準で用意するJSONシリアライザーです。<code>System.Text.Json</code>と比べると、たとえばシリアライズの対象がシリアライズ可能なフィールドのみなどと自由度が低いというデメリットはありますが、高速にシリアライズ・デシリアライズが行えるなどのメリットがあります。</p>\n<p><a href=\"https://docs.unity3d.com/ja/2020.3/Manual/JSONSerialization.html\">JSON 形式へのシリアル化 - Unity マニュアル</a></p>\n<p><code>JsonUtility</code>の使い方については下記の記事にて紹介していますので、こちらも興味があればご確認ください。</p>\n<p><a href=\"https://blog.yucchiy.com/2022/06/jsonutility-serialize-deserialize-unity-object/\">JsonUtilityでオブジェクトをシリアライズしたりデシリアライズしたりする | Yucchiy's Note</a></p>\n<h3 id=\"serializetoutf8bytesによるutf-8バイト配列のシリアライズ\" style=\"position:relative;\"><a href=\"#serializetoutf8bytes%E3%81%AB%E3%82%88%E3%82%8Butf-8%E3%83%90%E3%82%A4%E3%83%88%E9%85%8D%E5%88%97%E3%81%AE%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%BA\" aria-label=\"serializetoutf8bytesによるutf 8バイト配列のシリアライズ permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SerializeToUtf8BytesによるUTF-8バイト配列のシリアライズ</h3>\n<p><a href=\"https://learn.microsoft.com/ja-jp/dotnet/standard/serialization/system-text-json/how-to?pivots=dotnet-6-0#serialize-to-utf-8\">C# を使用して JSON をシリアル化および逆シリアル化する方法 - .NET | Microsoft Learn</a></p>\n<p>今回<code>System.Text.Json</code>が用意する <code>JsonSerializer</code>で、UTF-8 バイト配列へのシリアライズとUTF-8 バイト配列からのデシリアライズもパフォーマンス計測の対象に入れました。</p>\n<p>C#の文字列はその内部フォーマットがUTF-16なため、たとえば <code>JsonSerializer.Serialize</code>を呼び出して結果を<code>string</code>で受け取る場合は、一度UTF-8としてシリアライズした後に<code>string</code>に変換するため際にUTF-16へのエンコーディングが行われます。</p>\n<p>JSONは文字コードがUTF-8を想定しているため、たとえばJSONフォーマットなAPI通信をUnity標準のHTTPクライアント<a href=\"https://docs.unity3d.com/ScriptReference/Networking.UnityWebRequest.html\">UnityWebRequest</a>を用いると、下記のようなコードを書くことになります。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// requestはAPIのリクエストを表すインスタンスだとする</span>\n<span class=\"token comment\">// シリアライズしてUTF-8バイト配列から文字列（UTF-16）に変換</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> json <span class=\"token operator\">=</span> JsonSerializer<span class=\"token punctuation\">.</span><span class=\"token function\">Serialize</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 文字列（UTF-16）からUTF-8にバイト配列に再度変換</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> data <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span>Text<span class=\"token punctuation\">.</span>Encoding<span class=\"token punctuation\">.</span>UTF8<span class=\"token punctuation\">.</span><span class=\"token function\">GetBytes</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// ここからUnityWebRequest</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> uwr <span class=\"token operator\">=</span> UnityWebRequest<span class=\"token punctuation\">.</span><span class=\"token function\">Post</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nuwr<span class=\"token punctuation\">.</span>uploadHandler <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>UploadHandler<span class=\"token punctuation\">)</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">UploadHandlerRaw</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nuwr<span class=\"token punctuation\">.</span><span class=\"token function\">SetRequestHandler</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Content-Type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// リクエスト結果待ち</span>\nyeld <span class=\"token keyword\">return</span> uwr<span class=\"token punctuation\">.</span><span class=\"token function\">SendWebRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>シリアライズ時にUTF-8バイト配列からUTF-16に変換したのち、さらにUTF-8バイト配列にエンコードしなおしてリクエストする必要があります。つまり文字列を挟むと2度余計な変換をしていることになります。</p>\n<p>これを<code>SerializeToUtf8Bytes</code>を用いると下記のように記述できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// シリアライズ結果をそのままUTF-8バイト配列を受け取る</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> data <span class=\"token operator\">=</span> JsonSerializer<span class=\"token punctuation\">.</span><span class=\"token function\">SerializeToUtf8Bytes</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// UnityWebRequest</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> uwr <span class=\"token operator\">=</span> UnityWebRequest<span class=\"token punctuation\">.</span><span class=\"token function\">Post</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// そのままUTF-8バイト配列を渡せる</span>\nuwr<span class=\"token punctuation\">.</span>uploadHandler <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>UploadHandler<span class=\"token punctuation\">)</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">UploadHandlerRaw</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nuwr<span class=\"token punctuation\">.</span>downloadHandler <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>DownloadHandler<span class=\"token punctuation\">)</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">DownloadHandlerBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nuwr<span class=\"token punctuation\">.</span><span class=\"token function\">SetRequestHandler</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Content-Type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// リクエスト結果待ち</span>\nuwr<span class=\"token punctuation\">.</span><span class=\"token function\">SendWebRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>このように直接UTF-8バイト配列を受け取ることで無駄なエンコーディングを省くことができます。</p>\n<p>ちなみにこれはデシリアライズ時にも同じことが言えます。  <code>UnityWebRequest</code>の<code>DownloadHandler</code>は、レスポンスを<code>data</code>と<code>text</code>とというメソッド経由で取得でき、それぞれレスポンスのコピーとレスポンス文字列に変換したデータが受け取れます。それぞれ <code>JsonSerizlier</code> でデシリアライズでの下記のコードで行えます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// 文字列（UTF-16）をデシリアライズ</span>\nProfiler<span class=\"token punctuation\">.</span><span class=\"token function\">BeginSample</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"From Text\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> text <span class=\"token operator\">=</span> handler<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> p <span class=\"token operator\">=</span> JsonSerializer<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Deserialize</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Product<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>\n    text<span class=\"token punctuation\">,</span> ProductJsonContext<span class=\"token punctuation\">.</span>Default<span class=\"token punctuation\">.</span>Product<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nProfiler<span class=\"token punctuation\">.</span><span class=\"token function\">EndSample</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// UTF-8バイト配列をデシリアライズ</span>\n<span class=\"token comment\">// JSONの場合はUTF-8という前提で</span>\nProfiler<span class=\"token punctuation\">.</span><span class=\"token function\">BeginSample</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"From UTF-8 Bytes\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> utf8Bytes <span class=\"token operator\">=</span> handler<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span>\np <span class=\"token operator\">=</span> JsonSerializer<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Deserialize</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Product<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>\n    utf8Bytes<span class=\"token punctuation\">,</span>\n    ProductJsonContext<span class=\"token punctuation\">.</span>Default<span class=\"token punctuation\">.</span>Product<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nProfiler<span class=\"token punctuation\">.</span><span class=\"token function\">EndSample</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code>text</code>をデシリアライズすると、元データ（UTF-8バイト配列）→ 文字列（UTF-16）→ UTF-8バイト配列に変換 → デシリアライズとなりますが、<code>data</code>をデシリアライズすると、UTF-8バイト配列を直接デシリアライズできるため、無駄な処理を省くことができます。</p>\n<p>ちなみに <code>DownloadHandler</code>には<code>nativeData</code>という、元データを<code>NativeArray&#x3C;byte></code>をリードオンリーで参照できるプロパティが存在します。 <code>data</code>は呼び出しごとにこの<code>nativeData</code> をコピーしてしまうのですが、 <code>nativeData</code>を参照することでコピーを避ける事ができます。また<code>JsonSerializer</code>の <code>Deserialize</code>は<code>ReadOnlySpan&#x3C;byte></code>を直接みてデシリアライズできます。</p>\n<p>これを組み合わせると、Unsafeなコードにはなりますが<code>ReadOnlySpan&#x3C;byte></code>を介して、元データのコピーを行わずそのままデシリアライズが可能です。具体的には、下記のように<code>NativeArray&#x3C;T></code>から<code>ReadOnlySpan&#x3C;T></code>を引き抜いて、それを<code>Deserialize</code>に渡すことで実現できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// UTF-8バイト配列を、元のデータを直接参照してデシリアライズ</span>\n<span class=\"token comment\">// このとき元配列をコピーしないので、その分アロケーションコストが抑えられる</span>\nProfiler<span class=\"token punctuation\">.</span><span class=\"token function\">BeginSample</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"From UTF-8 Bytes With Native Array\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">unsafe</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> utf8BytesSpan <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ReadOnlySpan<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>\n        handler<span class=\"token punctuation\">.</span>nativeData<span class=\"token punctuation\">.</span><span class=\"token function\">GetUnsafeReadOnlyPtr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        handler<span class=\"token punctuation\">.</span>nativeData<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    p <span class=\"token operator\">=</span> JsonSerializer<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Deserialize</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Product<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>\n        utf8BytesSpan<span class=\"token punctuation\">,</span> ProductJsonContext<span class=\"token punctuation\">.</span>Default<span class=\"token punctuation\">.</span>Product<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\nProfiler<span class=\"token punctuation\">.</span><span class=\"token function\">EndSample</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>上の３つのデシリアライズのプロファイリングを取ると下図のようになりました。<code>nativeData</code>経由だと、特にGC Allocが小さくなっているのが確認できます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d6e86e797a3aa87538638513c21a79d6/66caf/ED3DEAB5B24E6396C6D5ECE01FB5237B.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 16%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAoklEQVQI1z2O2w6CMBBE+aLGXqhtuZQUFAiGiLHKk/7/V4zZTfBhs5OZ2ewpYozo+x4hBFRVhbqu4b1HWZY8pNu2hbWWc2MMtNbcI5+2c443ZYWMK4btg+HxRZh3nK8Z9vKEThtUusONGdX8hkl3hClDNDeIZmGvWXb4McOkDWF64RRXFFJKJkwpoeu6/0fyhRD8lcgOQqUUZ6Spd1DTHZH/ALjQZrZjsZjtAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ED3DEAB5B24E6396C6D5ECE01FB5237B\"\n        title=\"ED3DEAB5B24E6396C6D5ECE01FB5237B\"\n        src=\"/static/d6e86e797a3aa87538638513c21a79d6/5a190/ED3DEAB5B24E6396C6D5ECE01FB5237B.png\"\n        srcset=\"/static/d6e86e797a3aa87538638513c21a79d6/772e8/ED3DEAB5B24E6396C6D5ECE01FB5237B.png 200w,\n/static/d6e86e797a3aa87538638513c21a79d6/e17e5/ED3DEAB5B24E6396C6D5ECE01FB5237B.png 400w,\n/static/d6e86e797a3aa87538638513c21a79d6/5a190/ED3DEAB5B24E6396C6D5ECE01FB5237B.png 800w,\n/static/d6e86e797a3aa87538638513c21a79d6/66caf/ED3DEAB5B24E6396C6D5ECE01FB5237B.png 853w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>余談ですが、 Unity 2022.2では <code>NativeArray&#x3C;T></code>から<code>Span&#x3C;T></code>を生成するAPIが用意されました。</p>\n<p><a href=\"https://docs.unity3d.com/2022.2/Documentation/ScriptReference/Unity.Collections.NativeArray_1.AsSpan.html\">Unity - Scripting API: Unity.Collections.NativeArray_1.AsSpan</a></p>\n<p><a href=\"https://www.hanachiru-blog.com/entry/2022/12/19/120000\">【Unity】NativeArray<T>からSpan<T>へ変換する方法(2022.2以前はunsafe, 2022.2以降はAsSpan) - はなちるのマイノート</a></p>\n<p>こちらを用いることで、下記のようにUnsafeなしに、さらにシンプルにコードが記述できるようになります。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// UTF-8バイト配列を、元のデータを直接参照してデシリアライズ</span>\n<span class=\"token comment\">// このとき元配列をコピーしないので、その分アロケーションコストが抑えられる</span>\nProfiler<span class=\"token punctuation\">.</span><span class=\"token function\">BeginSample</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"From UTF-8 Bytes With Native Array2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// unsafeも外せるしシンプル</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> utf8BytesSpan <span class=\"token operator\">=</span> handler<span class=\"token punctuation\">.</span>nativeData<span class=\"token punctuation\">.</span><span class=\"token function\">AsSpan</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> p <span class=\"token operator\">=</span> JsonSerializer<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Deserialize</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Product<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>\n    utf8BytesSpan<span class=\"token punctuation\">,</span> ProductJsonContext<span class=\"token punctuation\">.</span>Default<span class=\"token punctuation\">.</span>Product<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nProfiler<span class=\"token punctuation\">.</span><span class=\"token function\">EndSample</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"パフォーマンス計測結果\" style=\"position:relative;\"><a href=\"#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E8%A8%88%E6%B8%AC%E7%B5%90%E6%9E%9C\" aria-label=\"パフォーマンス計測結果 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>パフォーマンス計測結果</h3>\n<p>改めて、下記４つのシリアライズ、デシリアライズのパフォーマンスについて、 <code>Person</code> ・ <code>Primitives</code> ・ <code>NestCase</code> の３つのクラスでのパフォーマンスの計測結果を比較します。</p>\n<ul>\n<li>ソースコード生成なしの<code>System.Text.Json</code>での文字列へのシリアライズとデシリアライズ\n<ul>\n<li><code>JsonSerializer</code>と表記</li>\n</ul>\n</li>\n<li>ソースコード生成ありの<code>System.Text.Json</code>での文字列へのシリアライズとデシリアライズ\n<ul>\n<li><code>JsonSerializerSrcGen</code>と表記</li>\n</ul>\n</li>\n<li>ソースコード生成ありの<code>System.Text.Json</code>でのUTF-8 バイト配列へのシリアライズとデシリアライズ\n<ul>\n<li><code>JsonSerializerSrcGenUtf8</code>と表記</li>\n</ul>\n</li>\n<li><code>JsonUtility</code>での文字列へのシリアライズとデシリアライズ\n<ul>\n<li><code>JsonUtility</code>と表記</li>\n</ul>\n</li>\n</ul>\n<p>上記のクラスのインスタンスをそれぞれ1000回シリアライズ・デシリアライズを1計測として、それを10回繰り返し、その平均を算出しました。例えば<code>Person</code>クラス<code>JsonSerializerSrcGen</code>の計測コードは下記の通りです。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Test</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Performance</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">SimplePerson_Serialize_SourceGenerator_Check</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    Measure<span class=\"token punctuation\">.</span><span class=\"token function\">Method</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">int</span></span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            JsonSerializer<span class=\"token punctuation\">.</span><span class=\"token function\">Serialize</span><span class=\"token punctuation\">(</span>\n                <span class=\"token comment\">// PersonTests[i]は事前に生成したものを利用</span>\n                <span class=\"token comment\">// すべてランダムな値を入れている。</span>\n                <span class=\"token comment\">// 文字列は1~9、a-zA-Zでランダムな文字列を利用</span>\n                <span class=\"token comment\">// （本当はユニコードも入れるべき...）</span>\n                PersonTests<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> PersonJsonContext<span class=\"token punctuation\">.</span>Default<span class=\"token punctuation\">.</span>Person<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// 計測は10回繰り返す</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">MeasurementCount</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>まずシリアライズについてです。単位はミリ秒です。それぞれのクラスで最も速かったシリアライズに対して<strong>太字</strong>を付けました。</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\"></th>\n<th align=\"right\">Person</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"left\">JsonSerializer</td>\n<td align=\"right\">3.93</td>\n</tr>\n<tr>\n<td align=\"left\">JsonSerializerSrcGen</td>\n<td align=\"right\">1.84</td>\n</tr>\n<tr>\n<td align=\"left\">JsonSerializerSrcGenUtf8</td>\n<td align=\"right\"><strong>1.80</strong></td>\n</tr>\n<tr>\n<td align=\"left\">JsonUtility</td>\n<td align=\"right\">2.86</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th align=\"left\"></th>\n<th align=\"right\">Primitives</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"left\">JsonSerializer</td>\n<td align=\"right\">18.66</td>\n</tr>\n<tr>\n<td align=\"left\">JsonSerializerSrcGen</td>\n<td align=\"right\">7.93</td>\n</tr>\n<tr>\n<td align=\"left\">JsonSerializerSrcGenUtf8</td>\n<td align=\"right\">7.45</td>\n</tr>\n<tr>\n<td align=\"left\">JsonUtility</td>\n<td align=\"right\"><strong>5.67</strong></td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th align=\"left\"></th>\n<th align=\"right\">NestCase</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"left\">JsonSerializer</td>\n<td align=\"right\">66.15</td>\n</tr>\n<tr>\n<td align=\"left\">JsonSerializerSrcGen</td>\n<td align=\"right\">30.76</td>\n</tr>\n<tr>\n<td align=\"left\">JsonSerializerSrcGenUtf8</td>\n<td align=\"right\"><strong>28.92</strong></td>\n</tr>\n<tr>\n<td align=\"left\">JsonUtility</td>\n<td align=\"right\">29.94</td>\n</tr>\n</tbody>\n</table>\n<p>次にデシリアライズです。</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\"></th>\n<th align=\"right\">Person</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"left\">JsonSerializer</td>\n<td align=\"right\">3.63</td>\n</tr>\n<tr>\n<td align=\"left\">JsonSerializerSrcGen</td>\n<td align=\"right\">1.44</td>\n</tr>\n<tr>\n<td align=\"left\">JsonSerializerSrcGenUtf8</td>\n<td align=\"right\"><strong>1.29</strong></td>\n</tr>\n<tr>\n<td align=\"left\">JsonUtility</td>\n<td align=\"right\">2.91</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th align=\"left\"></th>\n<th align=\"right\">Primitives</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"left\">JsonSerializer</td>\n<td align=\"right\">7.93</td>\n</tr>\n<tr>\n<td align=\"left\">JsonSerializerSrcGen</td>\n<td align=\"right\">7.27</td>\n</tr>\n<tr>\n<td align=\"left\">JsonSerializerSrcGenUtf8</td>\n<td align=\"right\">6.89</td>\n</tr>\n<tr>\n<td align=\"left\">JsonUtility</td>\n<td align=\"right\"><strong>4.86</strong></td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th align=\"left\"></th>\n<th align=\"right\">NestCase</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"left\">JsonSerializer</td>\n<td align=\"right\">47.20</td>\n</tr>\n<tr>\n<td align=\"left\">JsonSerializerSrcGen</td>\n<td align=\"right\">45.24</td>\n</tr>\n<tr>\n<td align=\"left\">JsonSerializerSrcGenUtf8</td>\n<td align=\"right\">44.08</td>\n</tr>\n<tr>\n<td align=\"left\">JsonUtility</td>\n<td align=\"right\"><strong>28.48</strong></td>\n</tr>\n</tbody>\n</table>\n<p>上記の結果から、下記のことが言えそうです。</p>\n<ul>\n<li><code>System.Text.Json</code>ではソース生成を行うことで、速度改善が見られた。\n<ul>\n<li>シリアライズ処理に対しては概ね2〜2.5倍程度の速度向上が見られた。</li>\n<li>デシリアライズは〜2倍程度。シリアライズ処理よりは大きな速度改善は見られなかった。</li>\n</ul>\n</li>\n<li>UTF-8バイト配列にシリアライズ、またはUTF-8バイト配列をデシリアライズすることで若干の速度改善は見られた。\n<ul>\n<li>こちらはGC Allocも合わせて改善した。</li>\n</ul>\n</li>\n<li><code>System.Text.Json</code>のソース生成&#x26;UTF-8バイト配列による処理と<code>JsonUtility</code>による処理については、ケースによって結果が前後したが、特にデシリアライズは<code>JsonUtility</code>が高速な傾向あった。</li>\n</ul>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>Unity2021.2でSource Generatorが利用できるようになったので、Source Generatorによる最適化が入った<code>System.Text.Json</code>の紹介とその導入方法、シリアライズとデシリアライズ方法、パフォーマンスについて比較しました。</p>\n<p>また、<code>System.Text.Json</code>でUTF-8バイト配列を直接シリアライザーに渡す・受け取ることで、UTF-16へのエンコーディング処理を省く最適化と、UnityWebRequestの<code>NativeArray&#x3C;T></code>と<code>Span&#x3C;T></code>を用いたアロケーション削減についても触れました。</p>\n<p>テストケースが少ないのであまりはっきりとしたことは言いづらいですが、Unityで利用できるJsonUtilityは、高速な反面カスタマイズや、UTF-8バイト配列を直接受け取る方法がないなどのデメリットがあるため、とくに通信APIなどでのJSONシリアライザーとして<code>System.Text.Json</code>の利用は、カスタマイズ製やGC削減などの最適化の観点で、ありなのかなという感じがしました。</p>\n<p>書いてみて（C# Advent Calendarの記事なのに）C#成分が少なくて、どっちかというとUnity Advent Calendarネタ感があり申し訳ない感じもしますが、Unityへの<code>System.Text.Json</code>のSource Generator導入について扱っているブログが少なかった（調べた感じではなかった）ので、記事にさせていただきました。</p>\n<p><code>System.Text.Json</code>をUnityで導入することを検討しておられる方の参考になれば幸いです。</p>","excerpt":"この記事はC# Advent Calendar 2022の23日目の記事です。 Unity 2021.2 から Source Generatorが利用できるようになりました。 これによってUnityでも、Microsoftが提供するJsonシリアライザー System.Text.Json のソース生成を利用できるようになりました。 System.Text.Json のソース生成は、C#のSource Generator…","fields":{"slug":"/2022/12/csharp-advent-calendar-system-text-json-unity/"},"frontmatter":{"date":"December 22, 2022","type":"tech","tags":["Unity","C#"],"title":"System.Text.Jsonのソース生成をUnityで試す","description":"UnityでSource Generator対応したSystem.Text.Jsonについて、その紹介と導入方法、シリアライズとデシリアライズ方法、パフォーマンスに比較、いくつかの最適化手法について紹介します。","eyecatch":null}}},"pageContext":{"id":"debc57f3-b35c-5265-beb6-9cea1abac525"}},"staticQueryHashes":["1480509143","3159585216"]}