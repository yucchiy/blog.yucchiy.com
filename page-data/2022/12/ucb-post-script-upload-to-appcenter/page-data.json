{"componentChunkName":"component---src-templates-post-tsx","path":"/2022/12/ucb-post-script-upload-to-appcenter/","result":{"data":{"markdownRemark":{"html":"<p>「<a href=\"https://qiita.com/advent-calendar/2022/applibot\">Applibot Advent Calendar 2022</a>」 12日目の記事です。</p>\n<p>Unityで制作したアプリを自動でビルドするための環境構築として、Jenkinsを構築したりGitHub Actionsを用いたりする方法などたくさんありますが、サクッとビルド環境を整えたい場合、Unity公式が提供するUnity Cloud Build（以後UCBと呼びます）を利用するのがお手軽です。</p>\n<p>また、UCBにはPre-Build ScriptとPost-Build Scriptという仕組みがあり、シェルスクリプトによる追加の処理をUnityのビルド前後に差し込めます。これによってビルド成果物に対してなにかの処理を施したり各種ベータ配信サービスへのアップロードなどを自動化できます。</p>\n<p>本記事ではUCBでビルドした成果物を、Microsoftが提供する<a href=\"https://appcenter.ms/\">AppCenter</a>にアップロードする操作を、Post-Build Scriptによって自動化してみます。</p>\n<h2 id=\"ucbのpost-build-scriptについて\" style=\"position:relative;\"><a href=\"#ucb%E3%81%AEpost-build-script%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"ucbのpost build scriptについて permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>UCBのPost-Build Scriptについて</h2>\n<p>冒頭で軽く触れましたが、UCBにはPost-Build Scriptという仕組みがあります。</p>\n<p>ビルド設定の「Advanced settings > Script hooks」に「Post-build script」という項目があるので、ここにビルド後に実行したいスクリプトのパスを指定することで、そのスクリプトがUnityビルド後に実行されます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b84d41c8002acb91c7837add13e6cdde/37048/382A2FAE13E16129540780FE0526F6CA.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.999999999999996%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAyElEQVQY03WQ207DMBBE8/8/CWpJCYUGmpu9Xq8P8kZtoxJWOrL9MLPjaS5fn0iMmBk5Z6fezTIigqpSilFKgRvg7z2acz9wuc5ESS5OKa3mpbBEIUglkXJGzdB6qpJ96V+aVEDtvvg++t0znd6Yu5Zw7pz48Y4MV19exXvTQHVa8djrf7BqdHwhHl+R9kDuWux0IP/0nv5RzVPC7f9v3dTJqizj4MR5IowjYZqIMRJCcMO9Lptt3K1xFSwhOJISkhTbCO2fDn8BdwjXofVhgfYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"382A2FAE13E16129540780FE0526F6CA\"\n        title=\"382A2FAE13E16129540780FE0526F6CA\"\n        src=\"/static/b84d41c8002acb91c7837add13e6cdde/5a190/382A2FAE13E16129540780FE0526F6CA.png\"\n        srcset=\"/static/b84d41c8002acb91c7837add13e6cdde/772e8/382A2FAE13E16129540780FE0526F6CA.png 200w,\n/static/b84d41c8002acb91c7837add13e6cdde/e17e5/382A2FAE13E16129540780FE0526F6CA.png 400w,\n/static/b84d41c8002acb91c7837add13e6cdde/5a190/382A2FAE13E16129540780FE0526F6CA.png 800w,\n/static/b84d41c8002acb91c7837add13e6cdde/c1b63/382A2FAE13E16129540780FE0526F6CA.png 1200w,\n/static/b84d41c8002acb91c7837add13e6cdde/37048/382A2FAE13E16129540780FE0526F6CA.png 1352w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>ちなみに「Post-build script」下にある「Mark build as failed if the post-build script has a non-zero exit code」は項目名どおり、指定したスクリプトを実行した結果、その戻り値が0以外の場合にビルドを失敗にします。指定するスクリプトの処理次第ですが、追加した処理がすべて正常に終わったことを含めてビルドの成功としたい場合はこの設定にチェックを入れて、かつスクリプトの冒頭に下記の設定を入れると良いでしょう。（参考: <a href=\"https://vaneyckt.io/posts/safer_bash_scripts_with_set_euxo_pipefail/\">Safer bash scripts with 'set -euxo pipefail' · vaneyckt.io</a>）</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">set</span> -euxo pipefail</code></pre></div>\n<h2 id=\"ビルドスクリプトの管理\" style=\"position:relative;\"><a href=\"#%E3%83%93%E3%83%AB%E3%83%89%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%AE%E7%AE%A1%E7%90%86\" aria-label=\"ビルドスクリプトの管理 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ビルドスクリプトの管理</h2>\n<p>Post-Build Scriptで利用するスクリプトは、下記のように管理することにします。</p>\n<div class=\"gatsby-highlight\" data-language=\"plaintext\"><pre class=\"language-plaintext\"><code class=\"language-plaintext\">repository-root\n├── unity-project-root\n└── .ci</code></pre></div>\n<p><code>repository-root</code> がチェックアウトされるレポジトリのルートディレクトリ、 <code>unity-project-root</code> がUnityプロジェクトのルートディレクトリです。</p>\n<p>Unityプロジェクトが格納されているディレクトリと同じ階層に<code>.ci</code>というディレクトリを配置し、その中に必要なスクリプトなどを配置します。</p>\n<p>もちろん、レポジトリのルート直下にUnityプロジェクトルートを展開する場合、その配下に<code>.ci</code>を配置するなどのカスタマイズは問題ありません。</p>\n<h2 id=\"ucbが設定済みの環境変数の一覧\" style=\"position:relative;\"><a href=\"#ucb%E3%81%8C%E8%A8%AD%E5%AE%9A%E6%B8%88%E3%81%BF%E3%81%AE%E7%92%B0%E5%A2%83%E5%A4%89%E6%95%B0%E3%81%AE%E4%B8%80%E8%A6%A7\" aria-label=\"ucbが設定済みの環境変数の一覧 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>UCBが設定済みの環境変数の一覧</h2>\n<p>スクリプトから成果物を扱うには、ビルドに関する情報をスクリプトから扱う必要があります。これらの情報は、UCBが設定する環境変数を介してアクセスできます。</p>\n<p>UCBが設定する環境変数はこちらの「<a href=\"https://unity-technologies.github.io/cloud-build-docs-public/environment-variables\">Environment Variables for UCB</a>」より確認できます。</p>\n<p>今回必要な成果物の出力されるパスは <code>UNITY_PLAYER_PATH</code> に格納されています。</p>\n<h2 id=\"ucbのビルドマシンで利用できるツールの確認\" style=\"position:relative;\"><a href=\"#ucb%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%A7%E5%88%A9%E7%94%A8%E3%81%A7%E3%81%8D%E3%82%8B%E3%83%84%E3%83%BC%E3%83%AB%E3%81%AE%E7%A2%BA%E8%AA%8D\" aria-label=\"ucbのビルドマシンで利用できるツールの確認 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>UCBのビルドマシンで利用できるツールの確認</h2>\n<p>AppCenterへ成果物をアップロードするために、UCB上でどのようなツールが利用できるか確認します。</p>\n<p>Microsoftからは下記のツールを提供しているので、下記のツールを使ってAppCenterへのアップロードを行う前提で、FastlaneとNode.jsがそれぞれ利用できるか確認します。</p>\n<ul>\n<li><a href=\"https://github.com/microsoft/appcenter-cli\">microsoft/appcenter-cli: Command-line Interface (CLI) for Visual Studio App Center</a></li>\n<li><a href=\"https://github.com/microsoft/fastlane-plugin-appcenter\">microsoft/fastlane-plugin-appcenter: App Center fastlane integration.</a></li>\n</ul>\n<p>ちなみに、UCB上にインストール済みのツールはドキュメントに明記されていないため、ビルドログやビルドスクリプト経由で必要な情報を出力しながらの確認になります。</p>\n<p>まずFastlaneについては、<a href=\"https://unity-technologies.github.io/cloud-build-docs-public/environment-variables\">定義済みの環境変数にFastlaneの記述があったり</a>、<a href=\"https://docs.unity3d.com/Manual/UnityCloudBuildGymfile.html\">iOSのXcodeビルドにGymfileが利用できる</a>ことから、UCBはビルドパイプラインの構築にFastlaneを利用していることが推測できます。そのためFastlaneは、メジャーアップデートなどでシステムが刷新されない限りは安定して利用できるでしょう。</p>\n<p>また、ビルドマシン上で printenv コマンドを実行すると <code>NVM_DIR</code> などの環境変数が利用できることから、一応Node.jsも利用できます。が、こちらは確実にビルドシステムが依存している、ドキュメントなどでも記載がないので、もしかするとシステムのアップデートで利用できなくなる可能性はあるかも知れません。</p>\n<p>ビルドマシン上で確認する限り、下記のツールは利用できそうです。</p>\n<ul>\n<li>Fastlane\n<ul>\n<li>これにともないRubyも</li>\n</ul>\n</li>\n<li>Python\n<ul>\n<li><code>pyenv</code> 経由でのインストール</li>\n</ul>\n</li>\n<li>Node.js\n<ul>\n<li><code>nvm</code> 経由でのインストール</li>\n</ul>\n</li>\n</ul>\n<p>本記事では、Node.jsと <a href=\"https://github.com/microsoft/appcenter-cli\">microsoft/appcenter-cli</a> を用いてAppCenterへのアップロードを行います。</p>\n<h2 id=\"microsoftappcenter-cliのインストールと利用方法\" style=\"position:relative;\"><a href=\"#microsoftappcenter-cli%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%A8%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95\" aria-label=\"microsoftappcenter cliのインストールと利用方法 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>microsoft/appcenter-cliのインストールと利用方法</h2>\n<p><a href=\"https://github.com/microsoft/appcenter-cli\">microsoft/appcenter-cli</a> のインストールは <code>npm</code> 経由で行います。</p>\n<p><code>.ci</code> 以下にツールをインストールしたいので、今回は <code>package.json</code> を配置してその中に <code>appcenter-cli</code> の依存を記述し、 <code>npm install</code> を行うことでインストールしました。</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"test-ci\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"appcenter:distribute:release\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"$(npm bin)/appcenter distribute release\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"dependencies\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"appcenter-cli\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^2.1.1\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code>.ci</code> 以下で下記コマンドを実行することで、appcenter-cli経由で成果物をアップロードできるようになります。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">npm</span> run appcenter:distribute:release --\n    --disable-telemetry --silent\n    --file <span class=\"token string\">\"<span class=\"token variable\">${UNITY_PLAYER_PATH}</span>\"</span> \n    --app <span class=\"token string\">\"<span class=\"token variable\">${APPCENTER_APPLICATION}</span>\"</span>\n    --group <span class=\"token string\">\"<span class=\"token variable\">${APPCENTER_DISTRIBUTION_GROUP}</span>\"</span></code></pre></div>\n<p>上記コマンドで指定している <code>APPCENTER_APPLICATION</code> はAppCenterのアップロード先、 <code>APPCENTER_DISTRIBUTION_GROUP</code> は配布先のグループになるため、事前に作成したものを指定します。</p>\n<p>また、環境変数に<code>APPCENTER_ACCESS_TOKEN</code>を指定しておくことで、appcenter-cliがAPI認証にこのトークンを利用するようになります。こちらも事前に取得しておきます。</p>\n<p>これらの値はビルドごとにアップロード先などを切り替えたいことが多いので、「Advanced settings > Environment variables」に下記のように外から設定することにします。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/940f354eacee68d0874f50101be2052f/8da59/435DC7173A89A4D8D42A55AE7C38D5CE.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA4ElEQVQY022QvUoDURBG9wXsFcU8gHVQfAlrCSltE30bX0CwiY1CbIJ22tpYpEi7yYJwYcne/z0yE7JEycBhYLhz+OYWxhjKslTqusY5p+ScSSkpbdtuyJkMym61wDqC9ZkihIC1ViXe+66LYCuXN8l7XbazF35urjB3Q8ztADMeYEbX+O8vElDI4r6SuYgFSZlD0Pn64Z7V2QHV5SnVxQnV+TGr/iHu812TF3Jad9I/dhNG5zrhUoW9jVDoH2E/3v4m3Ne3CWOMBPkGIC7mNM+PNK9PNFNhgp1OiNVSE/4C99NsJMhp588AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"435DC7173A89A4D8D42A55AE7C38D5CE\"\n        title=\"435DC7173A89A4D8D42A55AE7C38D5CE\"\n        src=\"/static/940f354eacee68d0874f50101be2052f/5a190/435DC7173A89A4D8D42A55AE7C38D5CE.png\"\n        srcset=\"/static/940f354eacee68d0874f50101be2052f/772e8/435DC7173A89A4D8D42A55AE7C38D5CE.png 200w,\n/static/940f354eacee68d0874f50101be2052f/e17e5/435DC7173A89A4D8D42A55AE7C38D5CE.png 400w,\n/static/940f354eacee68d0874f50101be2052f/5a190/435DC7173A89A4D8D42A55AE7C38D5CE.png 800w,\n/static/940f354eacee68d0874f50101be2052f/c1b63/435DC7173A89A4D8D42A55AE7C38D5CE.png 1200w,\n/static/940f354eacee68d0874f50101be2052f/29007/435DC7173A89A4D8D42A55AE7C38D5CE.png 1600w,\n/static/940f354eacee68d0874f50101be2052f/8da59/435DC7173A89A4D8D42A55AE7C38D5CE.png 2742w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>ただし<code>APPCENTER_ACCESS_TOKEN</code> は本来であればGitHubであればSecrets、JenkinsであればCredentialsのように<strong>機密情報として扱いたいのですが、UCBではユーザーが設定する環境変数はそのような扱いができないので</strong>今回はこのように設定しています。</p>\n<p>そのため、実運用には管理者（この設定を行えるユーザー）を絞るなどの工夫が必要になります。</p>\n<h2 id=\"post-build-scriptの実装\" style=\"position:relative;\"><a href=\"#post-build-script%E3%81%AE%E5%AE%9F%E8%A3%85\" aria-label=\"post build scriptの実装 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Post-Build Scriptの実装</h2>\n<p>スクリプトを実装するための材料が揃ったので、Post-Build Scriptの実装の全文を示します。</p>\n<p>Post-Build Scriptで実行するスクリプトを <code>.ci</code> 以下に <code>post-build-script.sh</code> というファイル名で配置し、 <code>package.json</code> も同ディレクトリ下に配置します。ディレクトリ構成は下記のとおりです。</p>\n<div class=\"gatsby-highlight\" data-language=\"plaintext\"><pre class=\"language-plaintext\"><code class=\"language-plaintext\">repository-root\n├── unity-project-root\n└── .ci\n    ├── post-build-script.sh\n    └── package.json</code></pre></div>\n<p><code>package.json</code> の全文は下記のとおりです。</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"test-ci\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"appcenter:distribute:release\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"$(npm bin)/appcenter distribute release\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"dependencies\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"appcenter-cli\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^2.1.1\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code>post-build-script.sh</code> の全文を示します。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token shebang important\">#!/usr/bin/env sh</span>\n\n<span class=\"token builtin class-name\">set</span> -euxo pipefail\n\n<span class=\"token comment\"># post-build-script.sh が入っている</span>\n<span class=\"token comment\"># ディレクトリに移動</span>\n<span class=\"token assign-left variable\">dir</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">dirname</span> $0<span class=\"token variable\">`</span></span>\n<span class=\"token builtin class-name\">cd</span> <span class=\"token string\">\"<span class=\"token variable\">${dir}</span>\"</span>\n\n<span class=\"token comment\"># APPCENTERで使うパラメータを環境変数に設定</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">APPCENTER_UPLOAD_FILE</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${UNITY_PLAYER_PATH}</span>\"</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">APPCENTER_RELEASE_NOTES</span><span class=\"token operator\">=</span><span class=\"token string\">\"**Project** : <span class=\"token variable\">${PROJECT_ID}</span>, **Build Target** : <span class=\"token variable\">${BUILD_TARGET}</span>, **Build Number** : <span class=\"token variable\">${UCB_BUILD_NUMBER}</span>, **Git Revision** : <span class=\"token variable\">${BUILD_REVISION}</span>\"</span>\n\n<span class=\"token comment\"># appcenter-cliを利用するためのセットアップ</span>\n<span class=\"token function\">npm</span> <span class=\"token function\">install</span>\n\n<span class=\"token comment\"># appcenter-cli経由で成果物アップロード</span>\n<span class=\"token function\">npm</span> run appcenter:distribute:release --<span class=\"token punctuation\">\\</span>\n    --disable-telemetry --silent<span class=\"token punctuation\">\\</span>\n    --file <span class=\"token string\">\"<span class=\"token variable\">${APPCENTER_UPLOAD_FILE}</span>\"</span><span class=\"token punctuation\">\\</span>\n    --app <span class=\"token string\">\"<span class=\"token variable\">${APPCENTER_APPLICATION}</span>\"</span><span class=\"token punctuation\">\\</span>\n    --release-notes <span class=\"token string\">\"<span class=\"token variable\">${APPCENTER_RELEASE_NOTES}</span>\"</span><span class=\"token punctuation\">\\</span>\n    --group <span class=\"token string\">\"<span class=\"token variable\">${APPCENTER_DISTRIBUTION_GROUP}</span>\"</span></code></pre></div>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>UCBのPost-Build Scriptの紹介と、この機能の実例としてAppCenterへの成果物のアップロードの方法について紹介しました。</p>\n<p>いくつかの設定でサクッとアプリビルド環境を構築できるのと、Pre/Post-Build Scriptの活用である程度柔軟なビルドパイプラインが組めるので、本格的なビルド環境を構築するまでにサクッとアプリビルド環境を用意したいなどの用途などではかなりありな選択肢なのかな、と個人的には思っています。</p>\n<p>この情報がUCBでのビルド環境構築の参考になれば幸いです。</p>","excerpt":"「Applibot Advent Calendar 2022」 12日目の記事です。 Unityで制作したアプリを自動でビルドするための環境構築として、Jenkinsを構築したりGitHub Actionsを用いたりする方法などたくさんありますが、サクッとビルド環境を整えたい場合、Unity公式が提供するUnity Cloud Build（以後UCBと呼びます）を利用するのがお手軽です。 また、UCBにはPre-Build ScriptとPost-Build Script…","fields":{"slug":"/2022/12/ucb-post-script-upload-to-appcenter/"},"frontmatter":{"date":"December 11, 2022","type":"tech","tags":["Unity"],"title":"Unity Cloud Buildでビルド後に独自のスクリプトを差し込む、成果物(ipa/apkなど)をAppCenterにアップロードする","description":"Unity Cloud BuildのPost-Build Scriptの紹介と、これを用いてipaやapkなどの成果物をAppCenterにアップロードする方法について解説します。","eyecatch":null}}},"pageContext":{"id":"4ed2de8a-0120-547d-bb7e-d148700cbcaf"}},"staticQueryHashes":["1480509143","3159585216"]}