{"componentChunkName":"component---src-templates-post-tsx","path":"/2022/12/advent-calendar-unity-memory-pack/","result":{"data":{"markdownRemark":{"html":"<p>本記事は <a href=\"https://qiita.com/advent-calendar/2022/unity\">Unity Advent Calendar 2022</a> の19日目の記事です。</p>\n<p>この記事では <a href=\"https://github.com/Cysharp/MemoryPack\">Cysharp/MemoryPack</a>とUnityでの利用方法について紹介します。</p>\n<h2 id=\"memorypackとは\" style=\"position:relative;\"><a href=\"#memorypack%E3%81%A8%E3%81%AF\" aria-label=\"memorypackとは permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MemoryPackとは</h2>\n<p><a href=\"https://github.com/Cysharp/MemoryPack\">MemoryPack</a>は、Cysharp社が提供するC#に特化したシリアライザーです。</p>\n<p>MemoryPackでは、C#インスタンスを独自のバイナリフォーマットに変換します。類似するライブラリとしてJSONシリアライザであれば<a href=\"https://learn.microsoft.com/en-us/dotnet/api/system.text.json?view=net-7.0\">System.Text.Json</a>や<a href=\"https://docs.unity3d.com/ScriptReference/JsonUtility.html\">JsonUtility</a>、MessagePackシリアライザであれば <a href=\"https://github.com/neuecc/MessagePack-CSharp\">MessagePack for C#</a>となります。</p>\n<p>MemoryPackの特徴として、他シリアライザーと比べて処理が速いという点が挙げられます。</p>\n<h2 id=\"memorypackがなぜ速いのか\" style=\"position:relative;\"><a href=\"#memorypack%E3%81%8C%E3%81%AA%E3%81%9C%E9%80%9F%E3%81%84%E3%81%AE%E3%81%8B\" aria-label=\"memorypackがなぜ速いのか permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MemoryPackがなぜ速いのか</h2>\n<p>なぜMemoryPackが他のシリアライザーと比べて高速なのか簡単に説明します。詳細はライブラリの著者であるneneccさんの下記の記事が参考になります。</p>\n<ul>\n<li><a href=\"https://neue.cc/2022/11/04_memorypack.html\">neue cc - MemoryPackにみる .NET 7/C# 11世代のシリアライザー最適化技法</a></li>\n<li><a href=\"https://neue.cc/2022/12/08_MemoryPackSessionInDotNetConfRecapTokyo.html\">neue cc - C# 11 による世界最速バイナリシリアライザー「MemoryPack」の作り方</a></li>\n<li><a href=\"https://speakerdeck.com/neuecc/c-number-11-niyorushi-jie-zui-su-bainarisiriaraiza-memorypack-nozuo-rifang\">C#11 による世界最速バイナリシリアライザー「MemoryPack」の作り方 - Speaker Deck</a></li>\n</ul>\n<p>MemoryPackは「Zero encoding extreme performance binary serializer for C# and Unity.」ということで、つまりシリアライズのために他シリアライザーで一般的に行われるようなエンコーディングをC#に特化したバイナリフォーマットを選定によって避け、その高速化を実現しています。</p>\n<p>通常シリアライザーは、シリアライズしたいインスタンスの各メンバーを何かしらのテキストまたはバイナリ表現に変換します（エンコーディング）。たとえば<code>int</code>のシリアライズでは、JSONでは数値を1〜11バイトの文字列として、MessagepackやProtocol Buffersなどのシリアライザーでは、サイズ節約のために1〜5バイトの可変長なバイナリとしてエンコーディングします（著者の<a href=\"https://neue.cc/2022/11/04_memorypack.html\">ブログから引用</a>させていただいています）。</p>\n<p>一方MemoryPackでは、インスタンスのメモリ上のデータを直接引っ張ってきます。そのため、たとえば<code>int</code>は、C#のメモリ表現をそのままコピーしてくるので4バイト固定のシリアライズになります。</p>\n<p>さらにMemoryPackではC#のメモリ表現を前提として、可能な限り少ないコピーでデータをシリアライズできるようにしています。</p>\n<p>これによって端的に差が出るケースが、ドキュメントにもある<code>Vector3</code>配列のシリアライズおよびデシリアライズです。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f93edb3634877978dc9c681d2f52a8f8/0f246/B5CFC18D7719057E77F2897F68B35E3E.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABnklEQVQoz0WS624aMRBGef+nadWqUdpQgpRtK1oERZALsJSqYZuEy6699npZX07lTUnmz0ie42/mG7vjQ8DahqrYUuWPVIe/mPyBpiqpjYbgCCHgvW8zzoBVHOUefXgA33CKWO8YYyiFYNbvMjw/Y3TZZ9zr8WO24WcqWNzLFqyqCq016SBhevGB6945k4/vuBnNmKwVaaaiIp3aGERRMPx0QbZcUAfYaPgjLFI1lJUl+FfBYT+h/+Y9l2/PmF99Zvt7wXzfUOjmWdCFgJCS8VWC1RLROB6laq2eIq6lcY7KGMbJV750E751E4bDCdujxzn7wnWqLCNfrbgbTBFlzeppz3q1Qin1fy8QvEdtd+jtlmnyncFowzyHm/snfqVLDofD6w7r+ZxisSQbX9NkGSH4VsV5j7UW6z2uLDG3t5g0pU7X6LsF4mjB21bEOodzruU7Ms+RRUG+2yGLnKIQCCEoy5Iinse6lGgpiWyZH9BStHeEkK2TExP5TpzEP/vCaIXSBqXjA6iXrxJzy/lAAIwu0bqiVFXbOE4XuWj5H+/vXbOsOv+FAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"B5CFC18D7719057E77F2897F68B35E3E\"\n        title=\"B5CFC18D7719057E77F2897F68B35E3E\"\n        src=\"/static/f93edb3634877978dc9c681d2f52a8f8/5a190/B5CFC18D7719057E77F2897F68B35E3E.png\"\n        srcset=\"/static/f93edb3634877978dc9c681d2f52a8f8/772e8/B5CFC18D7719057E77F2897F68B35E3E.png 200w,\n/static/f93edb3634877978dc9c681d2f52a8f8/e17e5/B5CFC18D7719057E77F2897F68B35E3E.png 400w,\n/static/f93edb3634877978dc9c681d2f52a8f8/5a190/B5CFC18D7719057E77F2897F68B35E3E.png 800w,\n/static/f93edb3634877978dc9c681d2f52a8f8/0f246/B5CFC18D7719057E77F2897F68B35E3E.png 1118w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>MessagePackを例に取ると、<code>Vector3</code>配列は下記のようなシリアライズ処理が必要になります。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">SerializeMessagePack</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Vector3<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 配列の長さ x フィールドの数だけ繰り返す</span>\n    <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> item <span class=\"token keyword\">in</span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// X</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// 書き出すバッファのリサイズ</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">-</span> offset<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// 実際にはResizeではなくてbufferWriter.Advance()です</span>\n                Array<span class=\"token punctuation\">.</span><span class=\"token function\">Resize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> buffer<span class=\"token punctuation\">,</span> buffer<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token comment\">// 1つのfloatのエンコーディング</span>\n            <span class=\"token comment\">// 先頭に識別子1byte+実際のfloatの値がはいる</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> p <span class=\"token operator\">=</span> MemoryMarshal<span class=\"token punctuation\">.</span><span class=\"token function\">GetArrayDataReference</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            Unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">WriteUnaligned</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> Unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> p<span class=\"token punctuation\">,</span> offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">)</span><span class=\"token number\">0xca</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            Unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">WriteUnaligned</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> Unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> p<span class=\"token punctuation\">,</span> offset <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">.</span>X<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            offset <span class=\"token operator\">+=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// これが３要素つづく</span>\n        <span class=\"token comment\">// Y</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">-</span> offset<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                Array<span class=\"token punctuation\">.</span><span class=\"token function\">Resize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> buffer<span class=\"token punctuation\">,</span> buffer<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> p <span class=\"token operator\">=</span> MemoryMarshal<span class=\"token punctuation\">.</span><span class=\"token function\">GetArrayDataReference</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            Unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">WriteUnaligned</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> Unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> p<span class=\"token punctuation\">,</span> offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">)</span><span class=\"token number\">0xca</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            Unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">WriteUnaligned</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> Unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> p<span class=\"token punctuation\">,</span> offset <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">.</span>Y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            offset <span class=\"token operator\">+=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// Z</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// 書き出すバッファのリサイズ</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">-</span> offset<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                Array<span class=\"token punctuation\">.</span><span class=\"token function\">Resize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> buffer<span class=\"token punctuation\">,</span> buffer<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> p <span class=\"token operator\">=</span> MemoryMarshal<span class=\"token punctuation\">.</span><span class=\"token function\">GetArrayDataReference</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            Unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">WriteUnaligned</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> Unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> p<span class=\"token punctuation\">,</span> offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">)</span><span class=\"token number\">0xca</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            Unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">WriteUnaligned</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> Unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> p<span class=\"token punctuation\">,</span> offset <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">.</span>Z<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            offset <span class=\"token operator\">+=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>このように、それぞれの要素を愚直に書き出す必要があります。一方でMemoryPackでは下記のようにシリアライズを行います。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">SerializeMemoryPack</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Vector3<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 配列長と型サイズからコピー領域が簡単に計算できる</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> size <span class=\"token operator\">=</span> Unsafe<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">SizeOf</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Vector3<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 書き出すバッファのリサイズ</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">-</span> offset<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> size<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Array<span class=\"token punctuation\">.</span><span class=\"token function\">Resize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> buffer<span class=\"token punctuation\">,</span> buffer<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// どれだけ複雑だろうとコピー一発で済ませられる</span>\n    MemoryMarshal<span class=\"token punctuation\">.</span><span class=\"token function\">AsBytes</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">value</span><span class=\"token punctuation\">.</span><span class=\"token function\">AsSpan</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">CopyTo</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">.</span><span class=\"token function\">AsSpan</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>これがどういう原理なのか簡単に説明します。</p>\n<p>C#ではstructの配列は必ずデータが直列に並びます。さらに<code>Vector3</code>もxyzの<code>float</code>のフィールドが3要素のみで、<code>Vector3</code>そのものもメモリ上にデータが並びます（厳密にはstructが参照型を持たない場合にデータが完全にメモリ上に並びます）。これらの条件により、<code>Vector3</code>の配列はメモリ上に x0y0z0x1y1z1... という形で完全にデータが並びます。そのため <code>Vector3</code> 配列のメモリ上でのサイズは <code>Vector3</code> 型のサイズ×配列長となり、配列の先頭からその長さのデータを引き抜けば、シリアライズしたい配列のデータそのものになります。</p>\n<p>またC#の構造体は定義したメンバー順に必ずデータが並ぶので、配列長がわかっていれば下記のように、バッファから1度のコピーでデシリアライズが行えます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token return-type class-name\">Vector3<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> <span class=\"token function\">DeserializeMemoryPack</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ReadOnlySpan<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">></span></span> buffer<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> size<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> dest <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector3</span><span class=\"token punctuation\">[</span>size<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 配列長がわかれば、型サイズとあわせて1度でコピー&amp;</span>\n    <span class=\"token comment\">// そのbyte配列はそのままVector3の配列を表現しているので</span>\n    <span class=\"token comment\">// キャストするだけでそのまま使える！</span>\n    MemoryMarshal<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Cast</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">,</span> Vector3<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">CopyTo</span><span class=\"token punctuation\">(</span>dest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> dest<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>このように、C#のメモリをそのままコピーすることでエンコーディングを避け、C#のメモリ表現前提で一度にまとめてコピーできる箇所はまとめて行ってトータルのコピー回数を減らすことで最適化を行っています。</p>\n<p>MemoryPackのバイナリフォーマットはC#に特化、つまりC#のメモリ表現にとって都合の良いバイナリフォーマットを定義することで、シリアライズのパフォーマンスを最大化できるようにしています。</p>\n<h2 id=\"memorypackをunityでつかう\" style=\"position:relative;\"><a href=\"#memorypack%E3%82%92unity%E3%81%A7%E3%81%A4%E3%81%8B%E3%81%86\" aria-label=\"memorypackをunityでつかう permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MemoryPackをUnityでつかう</h2>\n<p>MemoryPackは、具体的なシリアライズの実装をC#の<a href=\"https://learn.microsoft.com/ja-jp/dotnet/csharp/roslyn-sdk/source-generators-overview\">Source Generator</a>という仕組みでコンパイル時に生成します。UnityでSource Generatorを利用できる最小バージョンが2021.2なので、MemoryPackがサポートする最小のUnityバージョンは 2021 LTSとなります。</p>\n<h3 id=\"memorypackのインストール\" style=\"position:relative;\"><a href=\"#memorypack%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB\" aria-label=\"memorypackのインストール permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MemoryPackのインストール</h3>\n<p>MemoryPackのUnityへのインストールは、UPM（Unity Package Manager）経由か、アセットパッケージ（.unitypackage）経由で行うことができます。この記事では UPM 経由でのインストール方法について簡単に紹介します。</p>\n<p>メニューの「Window > Package Manager」でパッケージマネージャのウインドウを開き、下図のようにウインドウ左上の「＋」ボタンをクリックして出てくるプルダウンメニューから「Add package from git URL…」を選択します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 406px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/eab38d8e58a01e0f9f59125e314f302f/e33ef/14126200E7C83013910D9E0446C4D08B.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABEUlEQVQoz5XRy06DQBTGcV6mTQpIC6KCrUxnaAeBQpXeNNEY493XceE76MKY+H5/0zFx56WLX77z7c7JsU7jXeoqxNYhrtvD8b64W10cx9mYVTULhNJoXTDKcvRhSapzvJ5Pq9Wi3W5vxMq0JjkYkKbKEEnCcCiQUhLHsZEkienrXPcwDPF9nyAITBpBYLqVZZrJpKQocsqyYDRKzdzv79P1PGzbptPpfOdfrElVM1+c0MyXNLMleTGhPmqopscE2ztEUYQQwmz3KyEQqcQanj0zfvhgdPtmDC5ekFevqJt33OqJuC9IlURKZc7+kZIopbCy+pzp6pFqeUe9umdcX1LOronkjO5ehu24OLb97y9/ApPJ7GHJ8ybaAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"14126200E7C83013910D9E0446C4D08B\"\n        title=\"14126200E7C83013910D9E0446C4D08B\"\n        src=\"/static/eab38d8e58a01e0f9f59125e314f302f/e33ef/14126200E7C83013910D9E0446C4D08B.png\"\n        srcset=\"/static/eab38d8e58a01e0f9f59125e314f302f/772e8/14126200E7C83013910D9E0446C4D08B.png 200w,\n/static/eab38d8e58a01e0f9f59125e314f302f/e17e5/14126200E7C83013910D9E0446C4D08B.png 400w,\n/static/eab38d8e58a01e0f9f59125e314f302f/e33ef/14126200E7C83013910D9E0446C4D08B.png 406w\"\n        sizes=\"(max-width: 406px) 100vw, 406px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>選択後に出てくるテキストボックスに下図のように<code>https://github.com/Cysharp/MemoryPack.git?path=src/MemoryPack.Unity/Assets/Plugins/MemoryPack#1.9.6</code>というURLを入力します。ちなみに末尾の <code>#</code> 以降はバージョンになり、ここに<a href=\"https://github.com/Cysharp/MemoryPack/releases\">リリース済みのタグ</a>を入力すると任意のバージョンをインストールできます。 この記事を書いた 2022/12/17 時点での最新バージョンは<code>1.9.6</code>なので、そのバージョンを入力しました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 512px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8bf40e36b199a96b6b2d436d11bc0199/01e7c/C6E0DAFAA1836BCDBA7984DB02284CC8.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABB0lEQVQoz52Qy26DMBBF/TUQAcYzGL8pBKKE//+iW43TpFUXXXRxdEe2fDS+apomGGPQdV2l73sMw/Bv1L7veHEcB2KMaC8XtG2Ltn3lN03T/InyziGlVBFZ8B6yNRFhYq4zE2Ecx/oDSbl7Y0w9Y2IwM9R6PbDtN+y3O9btwLJecbufCKlg0AajYeiRMBqCtbZKpSKRSYok5QRtCb01UD4tiHlFLCtC/qiZlg0hLXCxQO6tz4h5wXk+qijn/KQUzG6G9x5mYhjLUHae4ZwHsaw8wRCh76VgjUHrHznU7WoVUgNznSVFLlI3z1AxBpSSEUJ4dhjC+zu/oa8uZRapc67WIG9kFuknAcTdBEmDKdUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"C6E0DAFAA1836BCDBA7984DB02284CC8\"\n        title=\"C6E0DAFAA1836BCDBA7984DB02284CC8\"\n        src=\"/static/8bf40e36b199a96b6b2d436d11bc0199/01e7c/C6E0DAFAA1836BCDBA7984DB02284CC8.png\"\n        srcset=\"/static/8bf40e36b199a96b6b2d436d11bc0199/772e8/C6E0DAFAA1836BCDBA7984DB02284CC8.png 200w,\n/static/8bf40e36b199a96b6b2d436d11bc0199/e17e5/C6E0DAFAA1836BCDBA7984DB02284CC8.png 400w,\n/static/8bf40e36b199a96b6b2d436d11bc0199/01e7c/C6E0DAFAA1836BCDBA7984DB02284CC8.png 512w\"\n        sizes=\"(max-width: 512px) 100vw, 512px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>その後、下図のようにMemoryPackが表示されていればパッケージのインストールは完了です。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e0429af651eb0527b0aebe7e870f981e/acf8f/FD6CAEAF01D53AF744C2EF12BF379BF8.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABfElEQVQoz3XOO2/bMBAHcI3ZXMtwjNiDtEl8iUeKDz1ruzAaIB8gU1qgX62oOvTTterUKiYDCnUne/jh/rw7AhedjNTHY/NDKP2NUTZQygZMyIAxHhBCAyFksNYOSqm5F94XlNLL3neE0Nc0TR8iXrAvfd95VUrPGZ1RjDzwwhtjvJTSE0KuopR6hJDPsmy22+1klHPzUn948qp//FNUx4mo9xMxh0k1h6nr2slaO+V5PkMIXYUxfg11u91ClFH5qT89+Wr/8UzL1tGycdz0rj2cnNL1DIR2PIDSEUKu8RjjcCFEKM9emtp6KfgrFOwMBXMSuOv7zu33e9c0javr+j9jjLPWzkKWUp6FEA4AXJIkECGEPjdt67UxHoTwAODLsvRt185Z/Otd8i1hniSJiLIse66q6m9VVb8AYGSMjaEqrceiKEbO+U1hLoQYjTG/lVI/0zSlURzH7zabjV6v13q1Wuk4jue6ub+f8y1hZ7lc6vA3SRITrlssFndvKHfQTJxC88QAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"FD6CAEAF01D53AF744C2EF12BF379BF8\"\n        title=\"FD6CAEAF01D53AF744C2EF12BF379BF8\"\n        src=\"/static/e0429af651eb0527b0aebe7e870f981e/5a190/FD6CAEAF01D53AF744C2EF12BF379BF8.png\"\n        srcset=\"/static/e0429af651eb0527b0aebe7e870f981e/772e8/FD6CAEAF01D53AF744C2EF12BF379BF8.png 200w,\n/static/e0429af651eb0527b0aebe7e870f981e/e17e5/FD6CAEAF01D53AF744C2EF12BF379BF8.png 400w,\n/static/e0429af651eb0527b0aebe7e870f981e/5a190/FD6CAEAF01D53AF744C2EF12BF379BF8.png 800w,\n/static/e0429af651eb0527b0aebe7e870f981e/c1b63/FD6CAEAF01D53AF744C2EF12BF379BF8.png 1200w,\n/static/e0429af651eb0527b0aebe7e870f981e/acf8f/FD6CAEAF01D53AF744C2EF12BF379BF8.png 1340w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>ただし、MemoryPackが <code>System.Runtime.CompilerServices.Unsafe/6.0.0</code> に依存しているため、追加でこのDLLを配置する必要があります。このDLLはNuGetから引っ張ってきます。</p>\n<p><a href=\"https://www.nuget.org/packages/System.Runtime.CompilerServices.Unsafe/6.0.0\">NuGetのSystem.Runtime.CompilerServices.Unsafe 6.0.0 のページ</a>を開き、画面右の「Download package」からnupkgをダウンロードします。</p>\n<p>次に、nupkgをzipとして解凍して、その中にあるDLLを引っ張ってきます。macOS標準では、ファイル名の末尾に「.zip」を追記後、そのファイルを開くとzipとして解凍されます。その中の<code>lib/netstandard2.0</code>内にある<code>System.Runtime.CompilerServices.Unsafe.dll</code>（下図）をUnityプロジェクト内に配置します。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 485px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8c3e5c172a7bc487c4755658557e7200/44c61/C6C1515EE27067D04533FB23EA7058F0.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 93%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAAClklEQVQ4y5WUyW/TQBSH/VcjIXHhwiJx48giBAVRTiCBKEiVyg1RygVax3a8xLvjOGlix2uSD80kraKGSmWkT/N+43mzvfeszCbnCMq8YJyO8JwBwygmcD2JsP2BK4mCgMgPSMKIwPPld9915Zjwy4Ypyux8iqAq5gzjBMeyiYMQX0weuIR+gGs7kotNBK4zkHPEwmKO1TdJ4wQFVpT5DNu2WXQdoi2XS1arFaxW637TVhu9/nZFb/yUUdFgjgqKfMbVtu1wU5R0mnNq+2haD8/3cV0X1/NIkoSqrinLkrKqbowSTQpO+gF9XaOnaRiGQZZlcqG2bf8bJYgyfvw8w3UdgjCkmM+p61ryPye7PGE4KTjqBaSjEXmeUzfNjWiuQaFrODRGHKsWpqHRtC1d19Fu6DZsa3G16zZSmrrGH8/wogRd0wjDEM/zZIDEE4ggCVuMhxstAnbxJNUVlLrtaJuWNE1RNR1N73Om9lB7mrT/nJ5d2rohtIrtuJRVTVW3OyjQ8CcZo9oW4UDD6p+SDT2ghmW5ZlWt2dY0/0Q5PJly563H60OHlx8Nnr7X2DuwOTjOOfhZ8PVXwZeTgs/Ha4T+9CNn/2jCu2+7KI8/ZNx+FvPqS8SjfZ9H+wEP3zjc37O4t2fzYM+S9v3XjtQP31jcfeFw60nI7eex9N1GXnnZTLHtPnrvN46lMcliyfk4IUtDJuO1PZ0IHVHMRusnod29spflfNcDNPUMy3aYlxVdt5C0W317mToLmrbbBKHZQcmrGjuIUVUVXdcxTRPTsuibJpquY1kWzmCw7h0H3TBIhkOZc/9Mm7KckySxdNY3iEWFo7DjJKFbLHZq9tpKEX+UUZbJU1xg2bZMamFf1Hd1pbara/gLr3iPxwSPeTYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"C6C1515EE27067D04533FB23EA7058F0\"\n        title=\"C6C1515EE27067D04533FB23EA7058F0\"\n        src=\"/static/8c3e5c172a7bc487c4755658557e7200/44c61/C6C1515EE27067D04533FB23EA7058F0.png\"\n        srcset=\"/static/8c3e5c172a7bc487c4755658557e7200/772e8/C6C1515EE27067D04533FB23EA7058F0.png 200w,\n/static/8c3e5c172a7bc487c4755658557e7200/e17e5/C6C1515EE27067D04533FB23EA7058F0.png 400w,\n/static/8c3e5c172a7bc487c4755658557e7200/44c61/C6C1515EE27067D04533FB23EA7058F0.png 485w\"\n        sizes=\"(max-width: 485px) 100vw, 485px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>これでインストールは完了です。ちなみに .unitypackage の方は下図のようにDLLもセットでインストールされるため、この対応は不要です。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 672px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/191a8891a0ccc380280b39112ade6c16/30d16/3E33E10FB25FAE4A84C04FD584A45AE0.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 16.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAX0lEQVQI142NXQrAIAyDvZJWa/3t2P3vlLGC4Hzaw0dKkhJ3i4AGgzkhpS8xRpRSMOc0VBW9d/NXfuKGKq6p9lBrBRFZsGsIwXR55/COe0utNVvOORsiYqybmeG9/8UDXythkva0PT0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"3E33E10FB25FAE4A84C04FD584A45AE0\"\n        title=\"3E33E10FB25FAE4A84C04FD584A45AE0\"\n        src=\"/static/191a8891a0ccc380280b39112ade6c16/30d16/3E33E10FB25FAE4A84C04FD584A45AE0.png\"\n        srcset=\"/static/191a8891a0ccc380280b39112ade6c16/772e8/3E33E10FB25FAE4A84C04FD584A45AE0.png 200w,\n/static/191a8891a0ccc380280b39112ade6c16/e17e5/3E33E10FB25FAE4A84C04FD584A45AE0.png 400w,\n/static/191a8891a0ccc380280b39112ade6c16/30d16/3E33E10FB25FAE4A84C04FD584A45AE0.png 672w\"\n        sizes=\"(max-width: 672px) 100vw, 672px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2 id=\"基本的なmemorypackの使い方\" style=\"position:relative;\"><a href=\"#%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AAmemorypack%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9\" aria-label=\"基本的なmemorypackの使い方 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>基本的なMemoryPackの使い方</h2>\n<p>基本的な使い方はとても簡単で、シリアライズしたいC#の型に対して<code>[MemoryPackable]</code>属性を指定します。このときC#の型は<code>partial</code>キーワードをあわせて指定します。<code>partial</code>が必要な理由は、シリアライズ時に必要な処理を、このクラス上に自動生成するためです。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">MemoryPack</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackable</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">partial</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Person</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> Age <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Name <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>上記の指定によってSource Generatorが<code>Person</code>型のシリアライズとデシリアライズのためのコードを自動生成します。コードは <code>{TypeName}.MemoryPackFormatter.g.cs</code> という名前で作成されます。このコードを確認したい場合、Riderであれば下図のように型にカーソルをあてて「Go to > Go to Declaration or Usages」を選択すると、</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 732px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bab836f1be23fe6a10b767c2e7e5bf49/d0cc0/CE57CA22499C12544A6D33F2E8310576.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACHElEQVQ4y52UWW/TUBBG8/9/CBLPIFEEL1SopA3QxkvS2PF27Xh30sRbVh/kCxVLmhdG+jRero++uXfGgzzLSNOEOAopipzT6chzdF3Hpbj0ZpDlOVlekBVLlqslaZYjvAjHcRHCQQiXxcInjhesVjlZFrNt15yOFcfDuQZlWVHVLZuyoaoa6rpluVyh61NUVWc+tzDNOa7rEYahvC7LjfTYdcczDfoS15sdT+WWctVQlw3FZo3wBIqioesTxmOV2cwgjmMJrqrq15a8UPJ+vydbNmRFRZJXLKMNeVrgCcFkMmU8VqRLIQRBEDCfz/8AdmcaNE3D4dhxOJzYH04c9yfapkUIn4cHRTo0DJMoiqRD3/f/Ar7o8Pe5/Vyw2+/kh6qq4XkeSZJIYK9/gWcOn4HPDyRwt0M3Nemw18wwiZOEYLHAkIfyH0AhbHRVwZ4bBMIlS0KSaIHvOfTbdCleBG57h1bMcGwzVBy+TQOmXsHYjBnpgjTLqMsnqs2ati7ZNhVtvaGp1heA2x3Dacq7oc0nNeHWXHMzWzE011yrCW9ubF69V3j9QeVq5HN15/HxIeHt0LtcchL6mI8TAuFQpBFFGkpFgce9OuPzncL1l3vuNRNLxBhuxMQUl4Ge8NG0iZTtuPJ+EYbYjoNtWTi2JbNwXfkfSJNY5ovA6aMhx6zvwX5K+tw3tmXZaJrO7d1XRqPvsl/7/uzHsp//H6G0IcFEZaQ9AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"CE57CA22499C12544A6D33F2E8310576\"\n        title=\"CE57CA22499C12544A6D33F2E8310576\"\n        src=\"/static/bab836f1be23fe6a10b767c2e7e5bf49/d0cc0/CE57CA22499C12544A6D33F2E8310576.png\"\n        srcset=\"/static/bab836f1be23fe6a10b767c2e7e5bf49/772e8/CE57CA22499C12544A6D33F2E8310576.png 200w,\n/static/bab836f1be23fe6a10b767c2e7e5bf49/e17e5/CE57CA22499C12544A6D33F2E8310576.png 400w,\n/static/bab836f1be23fe6a10b767c2e7e5bf49/d0cc0/CE57CA22499C12544A6D33F2E8310576.png 732w\"\n        sizes=\"(max-width: 732px) 100vw, 732px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>下図のように <code>Person.MemoryPackFormatter.g.cs</code> がでてくるので、これを選択することで自動生成されたコードにジャンプできます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5448c404a8904d61ad8069cb1983c737/5bf79/A24101AC8FC3AFC7375701BBE7F9A92C.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAw0lEQVQY033Gy0rDQBiA0bz/MwlaacWFtGLQjdLMNLdmcpnmn4yT1MgnShC7cXHgROXRYExNZzusFaQXxiCcJ8/8Ef71OX8bL0Ru8LyHQAiBvne8vu3RB0WaHcjzjLZr6Oyiu1TXFcYs6oryWBCN04xpPbYZsPbE3cueqwfNzVaz2qXcPmas44pNXLJ+yhcZm7hgtTv8ut5q7p8LojCeETchbmQ4eRpryYuSJFGoRKGVRqkUpRRt2+CcINLjRH7+l/cDXxvJKyst7tnRAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"A24101AC8FC3AFC7375701BBE7F9A92C\"\n        title=\"A24101AC8FC3AFC7375701BBE7F9A92C\"\n        src=\"/static/5448c404a8904d61ad8069cb1983c737/5a190/A24101AC8FC3AFC7375701BBE7F9A92C.png\"\n        srcset=\"/static/5448c404a8904d61ad8069cb1983c737/772e8/A24101AC8FC3AFC7375701BBE7F9A92C.png 200w,\n/static/5448c404a8904d61ad8069cb1983c737/e17e5/A24101AC8FC3AFC7375701BBE7F9A92C.png 400w,\n/static/5448c404a8904d61ad8069cb1983c737/5a190/A24101AC8FC3AFC7375701BBE7F9A92C.png 800w,\n/static/5448c404a8904d61ad8069cb1983c737/5bf79/A24101AC8FC3AFC7375701BBE7F9A92C.png 966w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>MemoryPackを用いて<code>Person</code>型のインスタンスをシリアライズおよびデシリアライズしてみます。シリアライズには <code>MemoryPackSerializer.Serialize&#x3C;T></code> を、デシリアライズには <code>MemoryPackDeserializer.Deserialize&#x3C;T></code> を呼び出します。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> v <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Person</span> <span class=\"token punctuation\">{</span>Age <span class=\"token operator\">=</span> <span class=\"token number\">40</span><span class=\"token punctuation\">,</span> Name <span class=\"token operator\">=</span> <span class=\"token string\">\"John\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// シリアライズ</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> bin <span class=\"token operator\">=</span> MemoryPackSerializer<span class=\"token punctuation\">.</span><span class=\"token function\">Serialize</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// デシリアライズ</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> val <span class=\"token operator\">=</span> MemoryPackSerializer<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Deserialize</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Person<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>bin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 40, John</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span>Age</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">, </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span>Name</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>内部的には上記で生成されたフォーマッタを呼び出すかたちでシリアライズおよびデシリアライズが行われています。</p>\n<h3 id=\"ビルトインでサポートする型\" style=\"position:relative;\"><a href=\"#%E3%83%93%E3%83%AB%E3%83%88%E3%82%A4%E3%83%B3%E3%81%A7%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B%E5%9E%8B\" aria-label=\"ビルトインでサポートする型 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ビルトインでサポートする型</h3>\n<p><a href=\"https://github.com/Cysharp/MemoryPack#built-in-supported-types\">Built-in supported types</a></p>\n<p>ドキュメントから抜粋になりますが、下記の型をビルトインでサポートしています。</p>\n<ul>\n<li>.NET primitives (<code>byte</code>, <code>int</code>, <code>bool</code>, <code>char</code>, <code>double</code>, etc.)</li>\n<li>Unmanaged types (Any <code>enum</code>, Any user-defined <code>struct</code> which doesn't contain reference types)</li>\n<li><code>string</code>, <code>decimal</code>, <code>Half</code>, <code>Int128</code>, <code>UInt128</code>, <code>Guid</code>, <code>Rune</code>, <code>BigInteger</code></li>\n<li><code>TimeSpan</code>, <code>DateTime</code>, <code>DateTimeOffset</code>, <code>TimeOnly</code>, <code>DateOnly</code>, <code>TimeZoneInfo</code></li>\n<li><code>Complex</code>, <code>Plane</code>, <code>Quaternion</code> <code>Matrix3x2</code>, <code>Matrix4x4</code>, <code>Vector2</code>, <code>Vector3</code>, <code>Vector4</code></li>\n<li><code>Uri</code>, <code>Version</code>, <code>StringBuilder</code>, <code>Type</code>, <code>BitArray</code></li>\n<li><code>T[]</code>, <code>T[,]</code>, <code>T[,,]</code>, <code>T[,,,]</code>, <code>Memory&#x3C;></code>, <code>ReadOnlyMemory&#x3C;></code>, <code>ArraySegment&#x3C;></code>, <code>ReadOnlySequence&#x3C;></code></li>\n<li><code>Nullable&#x3C;></code>, <code>Lazy&#x3C;></code>, <code>KeyValuePair&#x3C;,></code>, <code>Tuple&#x3C;,...></code>, <code>ValueTuple&#x3C;,...></code></li>\n<li><code>List&#x3C;></code>, <code>LinkedList&#x3C;></code>, <code>Queue&#x3C;></code>, <code>Stack&#x3C;></code>, <code>HashSet&#x3C;></code>, <code>SortedSet&#x3C;></code>, <code>PriorityQueue&#x3C;,></code></li>\n<li><code>Dictionary&#x3C;,></code>, <code>SortedList&#x3C;,></code>, <code>SortedDictionary&#x3C;,></code>, <code>ReadOnlyDictionary&#x3C;,></code></li>\n<li><code>Collection&#x3C;></code>, <code>ReadOnlyCollection&#x3C;></code>, <code>ObservableCollection&#x3C;></code>, <code>ReadOnlyObservableCollection&#x3C;></code></li>\n<li><code>IEnumerable&#x3C;></code>, <code>ICollection&#x3C;></code>, <code>IList&#x3C;></code>, <code>IReadOnlyCollection&#x3C;></code>, <code>IReadOnlyList&#x3C;></code>, <code>ISet&#x3C;></code></li>\n<li><code>IDictionary&#x3C;,></code>, <code>IReadOnlyDictionary&#x3C;,></code>, <code>ILookup&#x3C;,></code>, <code>IGrouping&#x3C;,></code>,</li>\n<li><code>ConcurrentBag&#x3C;></code>, <code>ConcurrentQueue&#x3C;></code>, <code>ConcurrentStack&#x3C;></code>, <code>ConcurrentDictionary&#x3C;,></code>, <code>BlockingCollection&#x3C;></code></li>\n<li>Immutable collections (<code>ImmutableList&#x3C;></code>, etc.) and interfaces (<code>IImmutableList&#x3C;></code>, etc.)</li>\n</ul>\n<p>プリミティブおよびUnmanged types（enumやユーザー定義の参照型を持たない構造体）、基本的なコレクションのシリアライズはサポートしています。Unityのクラスをシリアライズしたい場合は、後述する「ラップ型とカスタムフォーマッター」によってシリアライズできます。</p>\n<h3 id=\"memorypackincludeとmemorypackignore\" style=\"position:relative;\"><a href=\"#memorypackinclude%E3%81%A8memorypackignore\" aria-label=\"memorypackincludeとmemorypackignore permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MemoryPackIncludeとMemoryPackIgnore</h3>\n<p><a href=\"https://github.com/Cysharp/MemoryPack#define-memorypackable-class--struct--record--record-struct\">Define [MemoryPackable] class / struct / record / record struct</a></p>\n<p>MemoryPackでは<code>[MemoryPackable]</code>属性のついた型のpublicなフィールドとプロパティをシリアライズします。なので、下記のようなクラスでは<code>_name</code>がシリアライズされないのが確認できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">MemoryPack</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackable</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">partial</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Person2</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> Age <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> _name<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">SetName</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> name<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> _name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">GetName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> _name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> v <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Person2</span> <span class=\"token punctuation\">{</span>Age <span class=\"token operator\">=</span> <span class=\"token number\">40</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\nv<span class=\"token punctuation\">.</span><span class=\"token function\">SetName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"John\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// シリアライズ</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> bin <span class=\"token operator\">=</span> MemoryPackSerializer<span class=\"token punctuation\">.</span><span class=\"token function\">Serialize</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// デシリアライズ</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> val <span class=\"token operator\">=</span> MemoryPackSerializer<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Deserialize</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Person2<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>bin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// _nameがシリアライズされないので、GetName()は空文字になる</span>\n<span class=\"token comment\">// 40,</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span>Age</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">, </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span><span class=\"token function\">GetName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>もしprivateなフィールドおよびプロパティをシリアライズ対象に含めたい場合は<code>[MemoryPackInclude]</code>属性を指定します。逆にpublicだがシリアライズ対象に含めたくない場合は<code>[MemoryPackIgnore]</code>属性を指定します。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">MemoryPack</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackable</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">partial</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Person3</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// シリアライズ対象から外す</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackIgnore</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> Age <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// シリアライズ対象に含める</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackInclude</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> _name<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">SetName</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> name<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> _name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">GetName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> _name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> v <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Person3</span> <span class=\"token punctuation\">{</span>Age <span class=\"token operator\">=</span> <span class=\"token number\">40</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\nv<span class=\"token punctuation\">.</span><span class=\"token function\">SetName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"John\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// シリアライズ</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> bin <span class=\"token operator\">=</span> MemoryPackSerializer<span class=\"token punctuation\">.</span><span class=\"token function\">Serialize</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// デシリアライズ</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> val <span class=\"token operator\">=</span> MemoryPackSerializer<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Deserialize</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Person3<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>bin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// _nameはシリアライズされるが、Ageはシリアライズされないので下記が出力される</span>\n<span class=\"token comment\">// 0, John</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span>Age</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">, </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span><span class=\"token function\">GetName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"コンストラクタの指定\" style=\"position:relative;\"><a href=\"#%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF%E3%81%AE%E6%8C%87%E5%AE%9A\" aria-label=\"コンストラクタの指定 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>コンストラクタの指定</h3>\n<p><a href=\"https://github.com/Cysharp/MemoryPack#constructor-selection\">Constructor selection</a></p>\n<p>MemoryPackは、パラメータなしコンストラクターとパラメータ化されたコンストラクタのどちらもサポートしています。いくつか注意点があります。</p>\n<ol>\n<li>コンストラクタが複数個ある場合は、MemoryPackが利用するコンストラクタを<code>[MemoryPackConstructor]</code>で１つ指定する必要がある</li>\n<li>パラメータ化されたコンストラクターを使用する場合は、コンストラクタの引数とメンバー名を一致させる必要がある（case-sensitive、大文字小文字は区別しない）</li>\n</ol>\n<p>ちなみにこれらのルールに違反している場合、MemoryPackはRoslyn Analyzer経由で、下記のように独自のエラーを報告します。（それぞれMEMPACK004とMEMPACK006）</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8dd8a7de4280ff9033e5ba984c5ffbb4/8cae4/8E8D6F751FC5055A7FF93501E0425133.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAVklEQVQI12NwdvP8b25p89/I2OS/nr4hHBsYGv83MIJiQyRshMZGVmNk/J/BLLjgv1lIwX/T4IL/JkH5/0F806B8MNsUio0D88DYBIShciA+TB0EQ+QAJM5G5fo3I2sAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"8E8D6F751FC5055A7FF93501E0425133\"\n        title=\"8E8D6F751FC5055A7FF93501E0425133\"\n        src=\"/static/8dd8a7de4280ff9033e5ba984c5ffbb4/5a190/8E8D6F751FC5055A7FF93501E0425133.png\"\n        srcset=\"/static/8dd8a7de4280ff9033e5ba984c5ffbb4/772e8/8E8D6F751FC5055A7FF93501E0425133.png 200w,\n/static/8dd8a7de4280ff9033e5ba984c5ffbb4/e17e5/8E8D6F751FC5055A7FF93501E0425133.png 400w,\n/static/8dd8a7de4280ff9033e5ba984c5ffbb4/5a190/8E8D6F751FC5055A7FF93501E0425133.png 800w,\n/static/8dd8a7de4280ff9033e5ba984c5ffbb4/8cae4/8E8D6F751FC5055A7FF93501E0425133.png 1109w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>ちなみに2.は具体的に、下記のような実装においてエラーを報告します。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">MemoryPack</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackable</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">partial</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Person4</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackInclude</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> _name<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">GetName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> _name<span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackConstructor</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token comment\">// 引数のnameと初期化対象の_nameの名前が不一致</span>\n    <span class=\"token keyword\">public</span> <span class=\"token function\">Person4</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> name<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>少し分かりづらいのですが、コンストラクタのパラメータ名<code>name</code>と、<code>Person4</code>クラスで MemoryPackのシリアライズ対象に含まれるフィールド<code>_name</code>の名前が不一致しているために発生しています。これを愚直にコンストラクタを修正すると下記のようになります。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackConstructor</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token function\">Person4</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> _name<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_name <span class=\"token operator\">=</span> _name<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>このように、パラメーターとシリアライズ対象のフィールド名またはプロパティ名を一致させれば良いです。ただしこれだと若干気持ち悪さはあるので、下記のどれかで対応したほうが良いかもしれません。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">MemoryPack</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 1. 自動プロパティにしちゃう案</span>\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackable</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">partial</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Person5</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 自動プロパティにしちゃう</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Name <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">Person5</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> name<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 2. やっぱり諦められない案</span>\n<span class=\"token comment\">//    private setterを定義してコンストラクタでそっち経由で初期化</span>\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackable</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">partial</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Person6</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// シリアライズ対象はこっちにする案</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Name\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">get</span> <span class=\"token operator\">=></span> _name<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">set</span> <span class=\"token operator\">=></span> _name <span class=\"token operator\">=</span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// こっちはシリアライズ対象に含めない</span>\n    <span class=\"token comment\">// が、そうするとreadonlyがつけられない...</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> _name<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">Person6</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> name<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// プロパティ側で初期化する</span>\n        Name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 3. やっぱり諦められない案</span>\n<span class=\"token comment\">//    2.案 + init-only setterを使う</span>\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackable</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">partial</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Person7</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Name\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">get</span> <span class=\"token operator\">=></span> _name<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// init-only setterで _name を初期化</span>\n        <span class=\"token keyword\">private</span> init <span class=\"token operator\">=></span> _name <span class=\"token operator\">=</span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token comment\">// そうすると _name を readonlyにできる!</span>\n    <span class=\"token comment\">// ただしUnityではinit-only setterがそのまま使えないので</span>\n    <span class=\"token comment\">// IsExternalInitを定義するワークアラウンドが必要</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> _name<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">Person7</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> name<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>自動プロパティを許容できるなら、1.がシンプルで良いかもです。3.については、現状のUnityでは下記の定義を追加するというワークアラウンドが必要です。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">namespace</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Runtime<span class=\"token punctuation\">.</span>CompilerServices</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">internal</span> <span class=\"token keyword\">sealed</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">IsExternalInit</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"シリアライズ時のコールバック\" style=\"position:relative;\"><a href=\"#%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%BA%E6%99%82%E3%81%AE%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF\" aria-label=\"シリアライズ時のコールバック permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>シリアライズ時のコールバック</h2>\n<p><a href=\"https://github.com/Cysharp/MemoryPack#serialization-callbacks\">Serialization callbacks</a></p>\n<p>MemoryPackでは、シリアライズおよびデシリアライズ前後にコールバックを仕込めます。たとえば特定のプロパティへの値、は後から代入したいなどといった用途に利用できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">System</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">MemoryPack</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackable</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">partial</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">EmitIdData</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// デシリアライズ時に発行するものとする</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Guid</span> Id <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// デシリアライズ後の処理</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackOnDeserialized</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">EmitId</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token class-name\">MemoryPackReader</span> reader<span class=\"token punctuation\">,</span> <span class=\"token keyword\">ref</span> <span class=\"token class-name\">EmitIdData<span class=\"token punctuation\">?</span></span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// デシリアライズした後にあとからプロパティを追記もできる</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> guid <span class=\"token operator\">=</span> Guid<span class=\"token punctuation\">.</span><span class=\"token function\">NewGuid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">value</span><span class=\"token punctuation\">.</span>Id <span class=\"token operator\">=</span> guid<span class=\"token punctuation\">;</span>\n        Debug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">guid<span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> on MemoryPackOnDeserialized\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> emitId <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">EmitIdData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> bin <span class=\"token operator\">=</span> MemoryPackSerializer<span class=\"token punctuation\">.</span><span class=\"token function\">Serialize</span><span class=\"token punctuation\">(</span>emitId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> val <span class=\"token operator\">=</span> MemoryPackSerializer<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Deserialize</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>EmitIdData<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>bin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 下記ログが出力されて、EmitIdが呼び出されていることが確認できる</span>\n<span class=\"token comment\">// 56f2239e-c5b6-4d1b-b7f8-f1c227f0e6de on MemoryPackOnDeserialized</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"EmitId = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span>Id</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// EmitIdメソッドで発行したGuidと同じ値が出力されていることが確認できる</span>\n<span class=\"token comment\">// EmitId = 56f2239e-c5b6-4d1b-b7f8-f1c227f0e6de</span></code></pre></div>\n<p>処理順は下記のとおりです。</p>\n<ol>\n<li><code>MemoryPackSerializing</code> / <code>MemoryPackDeserializing</code></li>\n<li>MemoryPackの シリアライズ  / デシリアライズ</li>\n<li><code>MemoryPackSerialized</code> / <code>MemoryPackDeserialized</code></li>\n</ol>\n<p>また、シリアライズおよびデシリアライズ時に<code>IServiceProvider</code>を経由して外からデータを渡すこともできます。たとえばIDだけシリアライズしておいて、IDに対応するインスタンスはデシリアライズ時にデータベースから引っ張りたいなどの場合、下記のようにデシリアライズ時に外からデータベースを登録してもらった <code>IServiceProvider</code> を渡してもらって（下記では <code>PlayerDatabase</code> がそのデータベースとする）、デシリアライズ時にデータベースを引いて初期化するといったことが可能です。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Collections<span class=\"token punctuation\">.</span>Generic</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">MemoryPack</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackable</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">partial</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ServiceProviderSample</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Playerインスタンスは、マスタデータのデータベースから値を引っ張ってくるとする</span>\n    <span class=\"token comment\">// そのためここではシリアライズ対象から外しておく</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackIgnore</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Player</span> Player <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// IDだけシリアライズしておいて、データベースで引けるようにする</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> Id <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token function\">ServiceProviderSample</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">int</span></span> id<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Id <span class=\"token operator\">=</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackOnDeserialized</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">OnDeserialized</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token class-name\">MemoryPackReader</span> reader<span class=\"token punctuation\">,</span> <span class=\"token keyword\">ref</span> <span class=\"token class-name\">ServiceProviderSample<span class=\"token punctuation\">?</span></span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 外からデータベースをしてもらって、そこからPlayerインスタンスをひく</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> db <span class=\"token operator\">=</span> reader<span class=\"token punctuation\">.</span>Options<span class=\"token punctuation\">.</span>ServiceProvider<span class=\"token operator\">!</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\">PlayerDatabase</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token class-name\">PlayerDatabase</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">value</span><span class=\"token punctuation\">.</span>Player <span class=\"token operator\">=</span> db<span class=\"token punctuation\">.</span><span class=\"token function\">GetById</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">value</span><span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Player</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Name <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token function\">Player</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> name<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PlayerDatabase</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// これが、IDに対応するマスターデータを取得するメソッドだとする</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Player</span> <span class=\"token function\">GetById</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">int</span></span> id<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> id <span class=\"token keyword\">switch</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token number\">1</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Player</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"John\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            _ <span class=\"token operator\">=></span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">KeyNotFoundException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>上記クラスのデシリアライズは下記のように行います。</p>\n<p>ポイントとして、<code>MemoryPackSerializer.Deserialize&#x3C;T></code>の引数にオプションを渡せるので、その中の<code>ServiceProvider</code>にデータベースを登録済みの、<code>IServiceProvider</code>を実装するクラスを渡してやります。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> v <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ServiceProviderSample</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> bin <span class=\"token operator\">=</span> MemoryPackSerializer<span class=\"token punctuation\">.</span><span class=\"token function\">Serialize</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> options <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">MemoryPackSerializerOptions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// providerはIServiceProviderを実装していて、</span>\n    <span class=\"token comment\">// 下記のようにサービスが登録されているものとする</span>\n　　 <span class=\"token comment\">// provider.AddService(typeof(PlayerDatabase), new PlayerDatabase());</span>\n    ServiceProvider <span class=\"token operator\">=</span> provider<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// デシリアライズ</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> val <span class=\"token operator\">=</span> MemoryPackSerializer<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Deserialize</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>ServiceProviderSample<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>bin<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 1, John</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span>Id</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">, </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span>Player<span class=\"token punctuation\">.</span>Name</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"外部型のシリアライズとカスタムフォーマッター\" style=\"position:relative;\"><a href=\"#%E5%A4%96%E9%83%A8%E5%9E%8B%E3%81%AE%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%BA%E3%81%A8%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%82%BF%E3%83%BC\" aria-label=\"外部型のシリアライズとカスタムフォーマッター permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>外部型のシリアライズとカスタムフォーマッター</h2>\n<p><a href=\"https://github.com/Cysharp/MemoryPack#serialize-external-types\">Serialize external types</a></p>\n<p><a href=\"https://github.com/Cysharp/MemoryPack#customformatter\">CustomFormatter</a></p>\n<p>MemoryPack標準で対応している型のシリアライズ以外の型のうち、すでに存在する外部の型をシリアライズしたい場合、MemoryPackではいくつかの手段が用意されています。この記事では軽くしか取り上げていませんが、 <a href=\"https://github.com/Cysharp/MemoryPack#formatterprovider-api\">カスタムフォーマッター</a>を利用することで独自の型のシリアライズをサポートできます。</p>\n<p>ただしカスタムフォーマッターの実装を、<code>MemoryPackReader</code>と<code>MemoryPackWriter</code>を用いて独自のバイナリ操作を行うのは難しいため、ドキュメントではラップ型を用意し、そちらの型で<code>MemoryPackInclude</code>と<code>MemoryPackIgnore</code>を用いてシリアライズ対象を調整し、直接<code>MemoryPackReader</code>と<code>MemoryPackWriter</code>を操作しない方法を推奨しています。</p>\n<p>具体例としてドキュメントの例そのままですが、<code>AnimationCurve</code>のシリアライズを、ラップ型での解決方法を紹介します。</p>\n<p><code>AnimationCurve</code>のシリアライズにはそのクラスの<code>preWrapMode</code>と <code>postWrapMode</code> 、<code>keys</code>をシリアライズする必要があります。そのため下記のように<code>SerializableAnimationCurve</code>というラップ型を作り、それぞれのフィールドに対するプロパティを作ったうえで<code>MemoryPackInclude</code>を用いてMemoryPackのシリアライズ対象に含めます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackable</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">readonly</span> <span class=\"token keyword\">partial</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">SerializableAnimationCurve</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackIgnore</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">AnimationCurve</span> AnimationCurve<span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackInclude</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token return-type class-name\">WrapMode</span> preWrapMode <span class=\"token operator\">=></span> AnimationCurve<span class=\"token punctuation\">.</span>preWrapMode<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackInclude</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token return-type class-name\">WrapMode</span> postWrapMode <span class=\"token operator\">=></span> AnimationCurve<span class=\"token punctuation\">.</span>postWrapMode<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackInclude</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token return-type class-name\">Keyframe<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> keys <span class=\"token operator\">=></span> AnimationCurve<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackConstructor</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token function\">SerializableAnimationCurve</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">WrapMode</span> preWrapMode<span class=\"token punctuation\">,</span> <span class=\"token class-name\">WrapMode</span> postWrapMode<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Keyframe<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> keys<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> curve <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">AnimationCurve</span><span class=\"token punctuation\">(</span>keys<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        curve<span class=\"token punctuation\">.</span>preWrapMode <span class=\"token operator\">=</span> preWrapMode<span class=\"token punctuation\">;</span>\n        curve<span class=\"token punctuation\">.</span>postWrapMode <span class=\"token operator\">=</span> postWrapMode<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>AnimationCurve <span class=\"token operator\">=</span> curve<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">SerializableAnimationCurve</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AnimationCurve</span> animationCurve<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>AnimationCurve <span class=\"token operator\">=</span> animationCurve<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>これで<code>AnimationCurve</code>をシリアライズするラップ型の実装ができました。下記のように<code>SerializableAnimationCurve</code>経由で<code>AnimationCurve</code>のシリアライズとデシリアライズができていることが確認できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> curve <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">AnimationCurve</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Keyframe<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Keyframe</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Keyframe</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> bin <span class=\"token operator\">=</span> MemoryPackSerializer<span class=\"token punctuation\">.</span><span class=\"token function\">Serialize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">SerializableAnimationCurve</span><span class=\"token punctuation\">(</span>curve<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> val <span class=\"token operator\">=</span> MemoryPackSerializer<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Deserialize</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>SerializableAnimationCurve<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>bin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 2</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span>AnimationCurve<span class=\"token punctuation\">.</span>length</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 0 -> 0</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span>\n    <span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span>AnimationCurve<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>time</span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> -> </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span>AnimationCurve<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">value</span></span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 1 -> 10</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span>\n    <span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span>AnimationCurve<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>time</span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> -> </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span>AnimationCurve<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">value</span></span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>ただし<code>AnimationCurve</code>のシリアライズに毎回<code>SerializableAnimationCurve</code>を書くのはかなり面倒なので、 <code>SerializableAnimationCurve</code> とカスタムフォーマッターを用いてこれを簡略化できます。</p>\n<p>まず<code>AnimationCurve</code>のカスタムフォーマッターを用意します。具体的には<code>MemoryPackFormatter&#x3C;AnimationCurve></code> を継承したクラスを実装します。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">MemoryPack</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">UnityEngine</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AnimationCurveFormatter</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">MemoryPackFormatter<span class=\"token punctuation\">&lt;</span>AnimationCurve<span class=\"token punctuation\">></span></span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">override</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Serialize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token class-name\">MemoryPackWriter</span> writer<span class=\"token punctuation\">,</span> <span class=\"token keyword\">ref</span> <span class=\"token class-name\">AnimationCurve<span class=\"token punctuation\">?</span></span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">value</span> <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteNullObjectHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        writer<span class=\"token punctuation\">.</span><span class=\"token function\">WritePackable</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">SerializableAnimationCurve</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">override</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Deserialize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token class-name\">MemoryPackReader</span> reader<span class=\"token punctuation\">,</span> <span class=\"token keyword\">ref</span> <span class=\"token class-name\">AnimationCurve<span class=\"token punctuation\">?</span></span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">.</span><span class=\"token function\">PeekIsNull</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">value</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> wrapped <span class=\"token operator\">=</span> reader<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">ReadPackable</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>SerializableAnimationCurve<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">value</span> <span class=\"token operator\">=</span> wrapped<span class=\"token punctuation\">.</span>AnimationCurve<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>カスタムフォーマッターでは上記のように<code>Serialize</code>と<code>Deserialize</code>を実装します。</p>\n<p>このなかで<code>SerializeableAnimationCurve</code>の<code>WritePackable</code>と<code>ReadPackable</code>を呼び出すことで、<code>AnimationCurve</code>のシリアライズとデシリアライズを<code>SerializableAnimationCurve</code>のフォーマッターに委譲しています。</p>\n<p>あとは、用意したカスタムフォーマッターを登録します。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">MemoryPackFormatterProvider<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Register</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>AnimationCurve<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">AnimationCurveFormatter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>このようにカスタムフォーマッターを用意することで、<code>AnimationCurve</code>のシリアライズは下記のように直接<code>AnimationCurve</code>をMemoryPackの各種メソッドに渡すことができ、とても自然に記述できるようになりました。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> curve <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">AnimationCurve</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Keyframe<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Keyframe</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Keyframe</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> bin <span class=\"token operator\">=</span> MemoryPackSerializer<span class=\"token punctuation\">.</span><span class=\"token function\">Serialize</span><span class=\"token punctuation\">(</span>curve<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> val <span class=\"token operator\">=</span> MemoryPackSerializer<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Deserialize</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>AnimationCurve<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>bin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 2</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span>length</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 0 -> 0</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>time</span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> -> </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">value</span></span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 1 -> 10</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>time</span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> -> </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">val<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">value</span></span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>このようにカスタムフォーマッターを実装する際は、<strong>直接バイナリの読み書きを自分で記述するのではなく、ラップ型を用意してそちらで読み書きさせること</strong>で、ミスを少なくすることが推奨されています。</p>\n<h2 id=\"バージョンと運用\" style=\"position:relative;\"><a href=\"#%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E3%81%A8%E9%81%8B%E7%94%A8\" aria-label=\"バージョンと運用 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>バージョンと運用</h2>\n<p>MemoryPackを運用する上で注意すべき点として、<code>[MemoryPackable]</code>をつけた型の運用があります。</p>\n<p>MemoryPackは通常、シリアライズ対象のメンバーをその順番にそのままシリアライズおよびデシリアライズしようとします。そのため、通常だと下記の制約があります。</p>\n<ul>\n<li>メンバーを後ろに追記は可能。またメンバー名の変更も可能。</li>\n<li>メンバーの削除はできない。</li>\n<li>メンバーの順番の入れ替えはできない。</li>\n<li>メンバーの種類（型）の変更はできない。</li>\n</ul>\n<p>具体例として、下記の型で一度シリアライズしたデータに対して</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackable</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">partial</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">VersionCheck</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> Prop1 <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">long</span></span> Prop2 <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>下記のように変更をいれるとデシリアライズが行えません。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// Prop1の削除をした</span>\n<span class=\"token punctuation\">[</span>MemoryPackable<span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">partial</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">VersionCheck</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// public int Prop1 { get; set; }</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">long</span></span> Prop2 <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Prop2とProp1を入れ替えた</span>\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackable</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">partial</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">VersionCheck</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">long</span></span> Prop2 <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> Prop1 <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>MemoryPackでは<code>[MemoryPackable]</code>属性の引数に<code>GenerateType.VersionTolerant</code>を指定することで、その型がバージョントレラントをサポートします。メンバーのすべての並びを<code>[MemoryPackOrder]</code>によって明示することで制約が以下のように緩和されます。</p>\n<ul>\n<li>メンバーを後ろに追記は可能。またメンバー名の変更も可能。</li>\n<li>**メンバーの削除ができる。ただし、 ****<code>[MemoryPackOrder]</code>**<strong>で指定したオーダーの再利用はできない。</strong></li>\n<li>メンバーの順番の入れ替えはできない。</li>\n<li>メンバーの種類（型）の変更はできない。</li>\n</ul>\n<p>具体的には、下記の２つの型は相互にシリアライズ・デシリアライズが可能です。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackable</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>GenerateType<span class=\"token punctuation\">.</span>VersionTolerant<span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">partial</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">VersionTolerantObject1</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackOrder</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> MyProperty0 <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">default</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackOrder</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">long</span></span> MyProperty1 <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">default</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackOrder</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">short</span></span> MyProperty2 <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">default</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackable</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>GenerateType<span class=\"token punctuation\">.</span>VersionTolerant<span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">partial</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">VersionTolerantObject2</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackOrder</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> MyProperty0 <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">default</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// メンバー削除に対応</span>\n    <span class=\"token comment\">// ただし、並び順の1番目は再利用ができない</span>\n    <span class=\"token comment\">//[MemoryPackOrder(1)]</span>\n    <span class=\"token comment\">//public long MyProperty1 { get; set; } = default;</span>\n\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackOrder</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">short</span></span> MyProperty2 <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">default</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 追記はいままでどおり可能</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MemoryPackOrder</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">short</span></span> MyProperty3 <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">default</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ただし<code>GenerateType.VersionTolerant</code>を指定すると、通常のシリアライズと比べて速度が落ちるのと、ペイロードが少し大きくなる点には注意が必要です。</p>\n<h2 id=\"パフォーマンスについて\" style=\"position:relative;\"><a href=\"#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-label=\"パフォーマンスについて permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>パフォーマンスについて</h2>\n<p><a href=\"https://github.com/Cysharp/MemoryPack#payload-size-and-compression\">Payload Size and Compression</a></p>\n<p>最後にMemoryPackのパフォーマンス、とくにペイロードのサイズについて触れておきます。</p>\n<p>まず気になる各種フォーマットとのペイロードサイズの比較ですが、下記の傾向になるようです。</p>\n<ul>\n<li>MemoryPackのデータにはキー情報がなく、さらにバイナリ形式なので、JSONと比べるとペイロードサイズが小さくなる可能性がある。</li>\n<li>intを多用するデータ構造の場合、MemoryPackやProtobufと比べるとサイズが大きくなる傾向にある。\n<ul>\n<li>MemoryPackでintは固定サイズで常に4バイトだが、MessagePackやProtobufでは<a href=\"https://developers.google.com/protocol-buffers/docs/encoding\">varint</a>エンコーディングが行われ、そのサイズは1〜5バイトの可変長サイズになる。ただし一般的なデータは0に近い値のほうが多い傾向にあるので、そのサイズが4バイトより小さくなりやすい。</li>\n</ul>\n</li>\n<li>floatとdoubleはMemoryPackでは4バイトと8バイト、MemoryPackでは5バイトと9バイト。たとえばVector3配列の場合はMemoryPackのほうが小さくなる。</li>\n<li>文字列はUTF8でシリアライズされるので他シリアライザーと同じ傾向となる。</li>\n</ul>\n<p>もしペイロードサイズが許容できない場合は、圧縮を検討します。MemoryPackでは標準でBrotli圧縮による圧縮・解凍をサポートしています。</p>\n<p><a href=\"https://github.com/Cysharp/MemoryPack#compression\">Compression</a></p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> v <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Person4</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"John\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 圧縮</span>\n\n<span class=\"token comment\">// BrotliCompressorは自分で解放</span>\n<span class=\"token keyword\">using</span> <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> compressor <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">BrotliCompressor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nMemoryPackSerializer<span class=\"token punctuation\">.</span><span class=\"token function\">Serialize</span><span class=\"token punctuation\">(</span>compressor<span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 圧縮済みのMemoryPackバイナリが取得できる</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> bin <span class=\"token operator\">=</span> compressor<span class=\"token punctuation\">.</span><span class=\"token function\">ToArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 解凍</span>\n\n<span class=\"token comment\">// BrotliDecompressorは自分で解放</span>\n<span class=\"token keyword\">using</span> <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> decompressor <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">BrotliDecompressor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> decompressedBuffer <span class=\"token operator\">=</span> decompressor<span class=\"token punctuation\">.</span><span class=\"token function\">Decompress</span><span class=\"token punctuation\">(</span>bin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 圧縮済みのバイナリを解凍してデシリアライズ</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> <span class=\"token keyword\">value</span> <span class=\"token operator\">=</span> MemoryPackSerializer<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Deserialize</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Person4<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>decompressedBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// John</span>\nDebug<span class=\"token punctuation\">.</span><span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\"><span class=\"token keyword\">value</span><span class=\"token punctuation\">.</span>Name</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>C#に特化したシリアライザーライブラリのMemoryPackについて紹介しました。</p>\n<p>C#に閉じた箇所、たとえばセーブデータの扱いなどで高速な保存・読み込みが行えそうなど、Unityでも活用できる箇所は多そうです。</p>\n<p>この記事では紹介しきれてないけど気になっている機能はたくさんあり、また時間があればそのへんも記事を書いていこうと思います。</p>\n<p>またMemoryPackは、.NET 7で最もパフォーマンスを発揮するシリアライザーということで、今後UnityのCore CLR移行が進んでモダンなC#環境になると、パフォーマンスの向上も期待できるのかも？ということで色々楽しみです。</p>\n<p>UnityでMemoryPackを導入してみようと検討されておられる方に、少しでも参考になれば幸いです。</p>","excerpt":"本記事は Unity Advent Calendar 2022 の19日目の記事です。 この記事では Cysharp/MemoryPackとUnityでの利用方法について紹介します。 MemoryPackとは MemoryPackは、Cysharp社が提供するC#に特化したシリアライザーです。 MemoryPackでは、C#インスタンスを独自のバイナリフォーマットに変換します。類似するライブラリとしてJSONシリアライザであればSystem.Text.JsonやJsonUtility…","fields":{"slug":"/2022/12/advent-calendar-unity-memory-pack/"},"frontmatter":{"date":"December 18, 2022","type":"tech","tags":["Unity","MemoryPack"],"title":"UnityでMemoryPackを利用してみる","description":"Unityで、C#に特化した高速なシリアライザーであるMemoryPackを導入する方法についてまとめています。","eyecatch":null}}},"pageContext":{"id":"f9a2b6e0-20d4-5531-9acc-8e8c6e91dff2"}},"staticQueryHashes":["1480509143","3159585216"]}