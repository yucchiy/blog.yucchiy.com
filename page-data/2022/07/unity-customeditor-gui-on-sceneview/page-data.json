{"componentChunkName":"component---src-templates-post-tsx","path":"/2022/07/unity-customeditor-gui-on-sceneview/","result":{"data":{"markdownRemark":{"html":"<p>Unityでコンポーネントのプロパティ値を調整するとき、特に座標値などを扱う場合は、インスペクター上の値とにらめっこしながら調整するより、シーンビュー上にGUIなどを出して直接調整するほうが効率的に作業できることがあります。また、シーンビュー上に調整用のGUIが出ていると何かと便利なこともあります。</p>\n<p>下記のようなコンポーネントの編集を例にとって、これをシーンビュー上で編集するようなGUIを検討してみることにします。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">UnityEngine</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Enemy</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">MonoBehaviour</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Name <span class=\"token operator\">=></span> _name<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Vector3</span> CameraFollowOffset <span class=\"token operator\">=></span> _hpBarOffset<span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">SerializeField</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Header</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"敵の名前\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> _name<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">SerializeField</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Header</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"敵のHPバーを表示する位置オフセット\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Vector3</span> _hpBarOffset<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"custom-editorの基本形\" style=\"position:relative;\"><a href=\"#custom-editor%E3%81%AE%E5%9F%BA%E6%9C%AC%E5%BD%A2\" aria-label=\"custom editorの基本形 permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Custom Editorの基本形</h2>\n<p>コンポーネントを編集するGUIを制作する方法は様々ですが、今回はCustom Editorを利用してみます。</p>\n<p><a href=\"https://docs.unity3d.com/Manual/editor-CustomEditors.html\">Unity - Manual: Custom Editors</a></p>\n<p>先程の <code>Enemy</code> コンポーネントのCustom Editorの基本形を示します。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">UnityEditor</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">CustomEditor</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\">Enemy</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">EnemyEditor</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">Editor</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">SerializedProperty</span> _name<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">SerializedProperty</span> _cameraFollowPosition<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">OnEnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// serializedObjectは、ヒエラルキーで選択中の</span>\n        <span class=\"token comment\">// EnemyコンポーネントのSerializedObject</span>\n        _name <span class=\"token operator\">=</span> serializedObject<span class=\"token punctuation\">.</span><span class=\"token function\">FindProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"_name\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        _cameraFollowPosition <span class=\"token operator\">=</span> serializedObject<span class=\"token punctuation\">.</span><span class=\"token function\">FindProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"_cameraFollowPosition\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">override</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">OnInspectorGUI</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// インスペクターの表示をカスタマイズしたいときはこっちで行う</span>\n\n        <span class=\"token comment\">// これを呼び出すと、標準で用意されるインスペクターがそのまま表示される</span>\n        <span class=\"token keyword\">base</span><span class=\"token punctuation\">.</span><span class=\"token function\">OnInspectorGUI</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 独自のインスペクター表示を行いたいときは、上記を呼び出さずに</span>\n        <span class=\"token comment\">// 自前でビューをつくるなどする</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">OnSceneGUI</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// シーンビューでGUIを描画したいときはこっちで行う</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Custom Editorは編集したいコンポーネントに対して1対1で作成します。今回は <code>Enemy</code> コンポーネントと対となる <code>EnemyEditor</code> を作成しています。<code>UnityEditor.Editor</code> クラスを継承し、さらに <code>CustomEditor</code> 属性を指定しておきます。</p>\n<p><code>OnEnable</code> でCustom Editorで編集したいシリアライズ可能なフィールドから <code>SerializedProperty</code> を初期化しておきます。フィールドやセッターが <code>public</code> であれば直接して編集しても良いのですが、エディター実装だけのためにそれらを <code>public</code> にするのは良くないので、特別な理由がない限りは <code>SerializedProperty</code> でフィールドを編集するようにします。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">private</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">OnEnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// serializedObjectは、ヒエラルキーで選択中の</span>\n    <span class=\"token comment\">// EnemyコンポーネントのSerializedObject</span>\n    _name <span class=\"token operator\">=</span> serializedObject<span class=\"token punctuation\">.</span><span class=\"token function\">FindProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"_name\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    _cameraFollowPosition <span class=\"token operator\">=</span> serializedObject<span class=\"token punctuation\">.</span><span class=\"token function\">FindProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"_cameraFollowPosition\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>あとは <code>OnInspectorGUI</code> や <code>OnSceneGUI</code> を実装してインスペクターなどの見た目をカスタマイズしていきます。今回は、シーンビュー上でコンポーネントを編集するビューを作成していきたいので、 <code>OnSceneGUI</code> に処理を記述していきます。</p>\n<h2 id=\"handles\" style=\"position:relative;\"><a href=\"#handles\" aria-label=\"handles permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Handles</h2>\n<p>Unityにはシーンビュー上で座標値やスケールなどを調整する3D GUIを描画する Handles という機能が標準で提供されています。</p>\n<p><a href=\"https://docs.unity3d.com/ScriptReference/Handles.html\">Unity - Scripting API: Handles</a></p>\n<p>名前を聞くと馴染みがないかもしれませんが、ゲームオブジェクトの位置や回転などを調整するときに出てくるxyz方向に向いた矢印のGUIもHandlesによって提供されています。</p>\n<p>（コードそのものを確認できていませんが、Handlesに同じGUIを描画する機能があるのでおそらく同じ機能を呼び出しているはず…）</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 779px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/81988d986b556a28e6f58c9ddcad38a5/96e92/87882D94D5CE8A33DE6DADFE614712B0.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACTklEQVQ4y3WP60tTYRzHz7/kVEZkrc1LEEOCanM7z7nv3DaVpBEEK8gSolcVREUhgTpDw21uYwuyQAzykkxLtqgFSb6oNxH4/hvPueTZXC8+/G7f3/f5PQzhJQyfv4DTgSD6+sM42RdAKNQPv/8Eunzd8HX3WHT5etDb60cwGMKZ0CBODYStPBAaQvDsMAaGzmEwfAnM6ucm1r79wGrzAG+bP7HS2MdK/TsqO19Q+lDH8tYeChufkF/fRX7jI8rbdZS2GyjVvqJSa1i6MtXWdpBb3wXzZnML5bV3WKhUsVitWnG+VEa2WEJ2uYi5QgGz+bzFTI6Sc3IaC5grlrCQe4nn8y/wdLEI5u7UbWSupiHGolB5ApVjoXJxJBxorvGsherUtoaFyrNI8Cx0gWBcUyERFkxKk2EqAkY1GSlV8iDaaBJUkbMwvf0WrYRRXYYh82AULoZUQoCp8McwZA4GF8WtTAqTmRTGZdbqddImFQGqyNqGSdqUCUwqdqCLYwkWlaUsDg9/4c/vA8w+e4ikNAJTcXVHO0mFgyrEqWHUKuyhDa11iWBCI6i+eo3NvSYezywhfW0KlxMx+0qP3kUVYmAUctzQlIi1lBQjKD55gPe1Om7en8bElRtIyQSGZGv+b0i/KLEw2zDEONKGgOlH93Bn8jrGxAgM0ashto7m1JB3DZ1ls4MpFankIpJCFLp49FBHLTcCRmYjlmHLZR6sWibQ23qusYv9+Ij7ZdIy1Gn0GNi13W+fGZ6LHcMITNle0v8te43YjrWr915NDf8Cr+yH+q+OUlYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"87882D94D5CE8A33DE6DADFE614712B0\"\n        title=\"87882D94D5CE8A33DE6DADFE614712B0\"\n        src=\"/static/81988d986b556a28e6f58c9ddcad38a5/96e92/87882D94D5CE8A33DE6DADFE614712B0.png\"\n        srcset=\"/static/81988d986b556a28e6f58c9ddcad38a5/772e8/87882D94D5CE8A33DE6DADFE614712B0.png 200w,\n/static/81988d986b556a28e6f58c9ddcad38a5/e17e5/87882D94D5CE8A33DE6DADFE614712B0.png 400w,\n/static/81988d986b556a28e6f58c9ddcad38a5/96e92/87882D94D5CE8A33DE6DADFE614712B0.png 779w\"\n        sizes=\"(max-width: 779px) 100vw, 779px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>この機能はユーザーも利用できます。さきほどの <code>Enemy</code> クラスの <code>_hpBarOffset</code> の位置調整を、上図の位置調整用のHandleを用いて行えるようにしてみます。まずはコード全文を示します。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">OnSceneGUI</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// シーンビューでGUIを描画したいときはこっちで行う</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> enemy <span class=\"token operator\">=</span> target <span class=\"token keyword\">as</span> <span class=\"token class-name\">Enemy</span><span class=\"token punctuation\">;</span>\n\n    serializedObject<span class=\"token punctuation\">.</span><span class=\"token function\">Update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> hpBarOffsetWorldPosition <span class=\"token operator\">=</span>\n        enemy<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">.</span>position <span class=\"token operator\">+</span>\n        enemy<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">.</span>localToWorldMatrix<span class=\"token punctuation\">.</span><span class=\"token function\">MultiplyVector</span><span class=\"token punctuation\">(</span>enemy<span class=\"token punctuation\">.</span>HPBarOffset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    EditorGUI<span class=\"token punctuation\">.</span><span class=\"token function\">BeginChangeCheck</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> newHPBarOffset <span class=\"token operator\">=</span> Handles<span class=\"token punctuation\">.</span><span class=\"token function\">PositionHandle</span><span class=\"token punctuation\">(</span>\n        hpBarOffsetWorldPosition<span class=\"token punctuation\">,</span>\n        enemy<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">.</span>rotation\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>EditorGUI<span class=\"token punctuation\">.</span><span class=\"token function\">EndChangeCheck</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Undo<span class=\"token punctuation\">.</span><span class=\"token function\">RecordObject</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Change Hp Bar Offset Position\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        _hpBarOffset<span class=\"token punctuation\">.</span>vector3Value <span class=\"token operator\">=</span>\n            enemy<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">.</span>worldToLocalMatrix<span class=\"token punctuation\">.</span><span class=\"token function\">MultiplyVector</span><span class=\"token punctuation\">(</span>\n                newHPBarOffset <span class=\"token operator\">-</span> enemy<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">.</span>position\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    serializedObject<span class=\"token punctuation\">.</span><span class=\"token function\">ApplyModifiedProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>位置調整のGUIは <code>Handles.PositionHandle</code> を呼び出すことで利用できます。</p>\n<p><a href=\"https://docs.unity3d.com/ScriptReference/Handles.PositionHandle.html\">Unity - Scripting API: Handles.PositionHandle</a></p>\n<p>引数として現在の位置とGUIの回転をそれぞれ<strong>ワールド座標</strong>で取り、戻り値としてユーザー操作によって移動した後の位置をワールド座標で返却します。</p>\n<p>このとき、実際に移動したかどうかを <code>EditorGUI.BeginChangeCheck</code> と <code>EditorGUI.EndChangeCheck</code> によって判定できるので、移動後のみ値を更新するようにします。また、Undo用の設定も合わせて行います。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> hpBarOffsetWorldPosition <span class=\"token operator\">=</span>\n    enemy<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">.</span>position <span class=\"token operator\">+</span>\n    <span class=\"token comment\">// 現在のenemyの位置+オフセットにenemyの位置を反映させる</span>\n    enemy<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">.</span>localToWorldMatrix<span class=\"token punctuation\">.</span><span class=\"token function\">MultiplyVector</span><span class=\"token punctuation\">(</span>\n        enemy<span class=\"token punctuation\">.</span>HPBarOffset\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> newHPBarOffset <span class=\"token operator\">=</span> Handles<span class=\"token punctuation\">.</span><span class=\"token function\">PositionHandle</span><span class=\"token punctuation\">(</span>\n    hpBarOffsetWorldPosition<span class=\"token punctuation\">,</span>\n    enemy<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">.</span>rotation\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 更新検知</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>EditorGUI<span class=\"token punctuation\">.</span><span class=\"token function\">EndChangeCheck</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Undo用のコマンドをつんでおく</span>\n    Undo<span class=\"token punctuation\">.</span><span class=\"token function\">RecordObject</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Change Hp Bar Offset Position\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// ローカルオフセットに戻す</span>\n    <span class=\"token comment\">// hpBarOffsetWorldPositionの逆操作</span>\n    _hpBarOffset<span class=\"token punctuation\">.</span>vector3Value <span class=\"token operator\">=</span>\n        enemy<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">.</span>worldToLocalMatrix<span class=\"token punctuation\">.</span><span class=\"token function\">MultiplyVector</span><span class=\"token punctuation\">(</span>\n            newHPBarOffset <span class=\"token operator\">-</span> enemy<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">.</span>position\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>これで実装ができました。実際に <code>Handles.PositionHandle</code> によってオフセットを調整する様子を下図に示します。</p>\n<p><img src=\"/6bbf155311b994101b009eee51a31f4b/FD71B4E6371BED9DE7192F19CC2A8ADB.gif\" alt=\"\"></p>\n<h3 id=\"handlesdrawingscope-でオブジェクトのローカル座標で処理を記述する\" style=\"position:relative;\"><a href=\"#handlesdrawingscope-%E3%81%A7%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E5%BA%A7%E6%A8%99%E3%81%A7%E5%87%A6%E7%90%86%E3%82%92%E8%A8%98%E8%BF%B0%E3%81%99%E3%82%8B\" aria-label=\"handlesdrawingscope でオブジェクトのローカル座標で処理を記述する permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code>Handles.DrawingScope</code> でオブジェクトのローカル座標で処理を記述する</h3>\n<p>オフセット更新のために <code>Handles.PositionHandle</code> に渡す引数の位置や回転、戻り値の位置がすべてワールド座標なのでオフセットからワールド座標に変換して、また、受け取る座標もワールド座標なのでそこからローカル座標に戻してオフセットに代入していました。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// PositionHandleの座標値はワールド座標なので座標変換</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> hpBarOffsetWorldPosition <span class=\"token operator\">=</span>\n    enemy<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">.</span>position <span class=\"token operator\">+</span>\n    <span class=\"token comment\">// 現在のenemyの位置+オフセットにenemyの位置を反映させる</span>\n    enemy<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">.</span>localToWorldMatrix<span class=\"token punctuation\">.</span><span class=\"token function\">MultiplyVector</span><span class=\"token punctuation\">(</span>\n        enemy<span class=\"token punctuation\">.</span>HPBarOffset\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> newHPBarOffset <span class=\"token operator\">=</span> Handles<span class=\"token punctuation\">.</span><span class=\"token function\">PositionHandle</span><span class=\"token punctuation\">(</span>\n    hpBarOffsetWorldPosition<span class=\"token punctuation\">,</span>\n    enemy<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">.</span>rotation\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// オフセットはそのオブジェクトのローカル座標なので</span>\n<span class=\"token comment\">// ワールド座標からローカル座標に変換して代入</span>\n_hpBarOffset<span class=\"token punctuation\">.</span>vector3Value <span class=\"token operator\">=</span>\n    enemy<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">.</span>worldToLocalMatrix<span class=\"token punctuation\">.</span><span class=\"token function\">MultiplyVector</span><span class=\"token punctuation\">(</span>\n        newHPBarOffset <span class=\"token operator\">-</span> enemy<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">.</span>position\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>上記のコードのように<strong>ローカルとワールド座標の変換を意識してコードを書くと煩雑になって</strong>分かりづらくなります。</p>\n<p>これを解決するために <code>Handles</code> には <code>Handles.matrix</code> というstaticな変数が用意されています。ここに値を代入しておくと、 <code>Handles</code> の操作に <code>Handles.matrix</code> の行列（または逆行列）が乗算されます。</p>\n<p>利用例としてはゲームオブジェクトの <code>Transform.localToWorldMatrix</code> を代入すると、ハンドルに渡す座標や回転を、そのゲームオブジェクトのローカル座標で扱われるようになるなどです。</p>\n<p>ちょっとややこしいのですが、さきほどのオフセットの編集の実装を <code>Handles.matrix</code> を用いると、下記コードで置き換えることができます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Handles<span class=\"token punctuation\">.</span>DrawingScope</span><span class=\"token punctuation\">(</span>enemy<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">.</span>localToWorldMatrix<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// このusingスコープ中は、Handles.matrixに</span>\n    <span class=\"token comment\">// enemy.transform.localToWorldMatrixが代入されている</span>\n\n    <span class=\"token comment\">// 座標・回転・スケールは enemy のローカル空間で扱う事ができる</span>\n    EditorGUI<span class=\"token punctuation\">.</span><span class=\"token function\">BeginChangeCheck</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> newHpBarOffset <span class=\"token operator\">=</span> Handles<span class=\"token punctuation\">.</span><span class=\"token function\">PositionHandle</span><span class=\"token punctuation\">(</span>\n        _hpBarOffset<span class=\"token punctuation\">.</span>vector3Value<span class=\"token punctuation\">,</span>\n        Quaternion<span class=\"token punctuation\">.</span>identity\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Handles<span class=\"token punctuation\">.</span><span class=\"token function\">Label</span><span class=\"token punctuation\">(</span>_hpBarOffset<span class=\"token punctuation\">.</span>vector3Value<span class=\"token punctuation\">,</span> <span class=\"token string\">\"HP Bar Offset\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>EditorGUI<span class=\"token punctuation\">.</span><span class=\"token function\">EndChangeCheck</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Undo<span class=\"token punctuation\">.</span><span class=\"token function\">RecordObject</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Change Hp Bar Offset Position\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        _hpBarOffset<span class=\"token punctuation\">.</span>vector3Value <span class=\"token operator\">=</span> newHpBarOffset<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>usingスコープ中はハンドルの操作がすべて <code>enemy</code> のローカル座標で行われるため、<strong>ワールド座標とローカル座標の変換がコード中から消えて</strong>、かなりすっきりとしたかと思います。</p>\n<h2 id=\"シーンビューにguiを出す\" style=\"position:relative;\"><a href=\"#%E3%82%B7%E3%83%BC%E3%83%B3%E3%83%93%E3%83%A5%E3%83%BC%E3%81%ABgui%E3%82%92%E5%87%BA%E3%81%99\" aria-label=\"シーンビューにguiを出す permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>シーンビューにGUIを出す</h2>\n<p>次に、シーンビュー上にGUIを出して、コンポーネント編集の効率化してみたいと思います。</p>\n<p>シーンビュー上にGUIを出す方法もいくつかありますが、 <code>OnSceneGUI</code> 中  <code>Handles.BeginGUI</code> を呼び出すと、 <code>Handles.EndGUI</code> を呼び出す間はIMGUIの表示を行えるようになります。</p>\n<p>試しに、下図のような <code>Enemy._name</code> をシーンビュー上で直接編集するGUIを作ってみます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 632px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b99c22c27ae058161143ec59e079344b/084e2/CD0FC504D4750897F4D5192355C3AF76.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB0klEQVQ4y32ST4vTQBjG8+3WRlqk2zZt/kxmMpPJZJK4sFp01xX/YG96UkRXUFnYBW+Ke1ERL4KKB8W7R737CR7JJM2OtvTwY8jkl+d95504ZZailKKjqEkFSsUxP2DQot2THMbNUvPc+Gm3V2YSpZJwtKBYS0pRVQQ6iaB5jEJQyDiAosF6XzCDk3OC/1Gc4GJKcHknh0wrKCnA/BGePXmEl6dvIeI6NG7gFiKGkycRViGQxMNuQXBJV7iRMSTBGJ++fMXh8WvwcApdF09I41vNOHkSoiEyq+YRRDTD/cUcb949xr6mqMgYmod4fnSMvYNbkGSK9Y1EdmCLiKH8C/j98zt+/PqDvWt3oKhv3mU0wIpvw9cEqoSgJNv49vkDHp68wnx3HyWdQtWX055iE07OQjQ0N6hYiCwc4+P7U9x9+gK3dySu+30T2HksMOuGwKBDJwFyOsODxRXcW9zEVU1QsQAF/9c7IzQFVFvAMfOxhPqXILMJpsMByGiAYDKEPxkiCb32FP5KoP3sLKXl4Geeh35/gF7PRc89D9d1sbV1Dt5oG7qece21LMMVOytiOly2nLVC/WHBo45SkCas9ZQVZjdU43RSG7gJ21X25Vij+AuqnzvCtjkuawAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"CD0FC504D4750897F4D5192355C3AF76\"\n        title=\"CD0FC504D4750897F4D5192355C3AF76\"\n        src=\"/static/b99c22c27ae058161143ec59e079344b/084e2/CD0FC504D4750897F4D5192355C3AF76.png\"\n        srcset=\"/static/b99c22c27ae058161143ec59e079344b/772e8/CD0FC504D4750897F4D5192355C3AF76.png 200w,\n/static/b99c22c27ae058161143ec59e079344b/e17e5/CD0FC504D4750897F4D5192355C3AF76.png 400w,\n/static/b99c22c27ae058161143ec59e079344b/084e2/CD0FC504D4750897F4D5192355C3AF76.png 632w\"\n        sizes=\"(max-width: 632px) 100vw, 632px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>まずはコード全文を示します。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// ワールド座標からGUI座標を取得する</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> enemyGUIPosition <span class=\"token operator\">=</span> HandleUtility<span class=\"token punctuation\">.</span><span class=\"token function\">WorldToGUIPoint</span><span class=\"token punctuation\">(</span>\n    enemy<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">.</span>position\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// BeginGUI~EndGUI間ではGUI描画を行うことができる</span>\nHandles<span class=\"token punctuation\">.</span><span class=\"token function\">BeginGUI</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 試しにEnemy._nameを編集するGUIをシーンビュー上に配置</span>\n_name<span class=\"token punctuation\">.</span>stringValue <span class=\"token operator\">=</span> EditorGUI<span class=\"token punctuation\">.</span><span class=\"token function\">TextField</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Rect</span><span class=\"token punctuation\">(</span>\n        <span class=\"token comment\">// 3Dの位置から少し下に表示してみる</span>\n        enemyGUIPosition <span class=\"token operator\">+</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector2</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector2</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    _name<span class=\"token punctuation\">.</span>stringValue\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nHandles<span class=\"token punctuation\">.</span><span class=\"token function\">EndGUI</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>GUIで、3Dオブジェクトの位置を基準になにか出す、ということを行うには、3Dオブジェクトのワールド座標から対応するGUI座標の位置を取得する必要があります。</p>\n<p><code>HandleUtility.WorldToGUIPoint</code> を用いると、ゲームオブジェクトの位置から対応するGUI座標上の位置を取得できます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// 対象のenemyのワールド座標からGUI座標上の位置を取得している</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> enemyGUIPosition <span class=\"token operator\">=</span> HandleUtility<span class=\"token punctuation\">.</span><span class=\"token function\">WorldToGUIPoint</span><span class=\"token punctuation\">(</span>\n    enemy<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">.</span>position\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>あとはGUI描画を行います。 テキストフィールドを描画して <code>Enemy._name</code> を編集できるようにしてみます。</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// BeginGUI~EndGUI間ではGUI描画を行うことができる</span>\nHandles<span class=\"token punctuation\">.</span><span class=\"token function\">BeginGUI</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n_name<span class=\"token punctuation\">.</span>stringValue <span class=\"token operator\">=</span> EditorGUI<span class=\"token punctuation\">.</span><span class=\"token function\">TextField</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Rect</span><span class=\"token punctuation\">(</span>\n        <span class=\"token comment\">// 3Dの位置から少し下に表示してみる</span>\n        enemyGUIPosition <span class=\"token operator\">+</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector2</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Vector2</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    _name<span class=\"token punctuation\">.</span>stringValue\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nHandles<span class=\"token punctuation\">.</span><span class=\"token function\">EndGUI</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>上記の実装で、下図のように名前編集のテキストフィールドをシーンビュー上に表示することができました。</p>\n<p><img src=\"/7372dcdfe37a6e48c2dacd6b707e68c5/12F37EC3646DB75018DAA502D8521842.gif\" alt=\"\"></p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"header-link before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>シーンビュー上で調整用のGUIや3Dを表示する方法や、Handlesを扱うときの座標の扱いを少し簡単にする <code>Handles.DrawingScope</code> の使い方などについて解説しました。</p>\n<p>調整用のビューの実装にこだわるのはなかなか大変で時間もかかりますが、上手に作るとコンテンツ制作の効率化に大きく貢献します。</p>\n<p>そのための手助けとして、この記事が役に立つと幸いです。</p>","excerpt":"Unityでコンポーネントのプロパティ値を調整するとき、特に座標値などを扱う場合は、インスペクター上の値とにらめっこしながら調整するより、シーンビュー上にGUIなどを出して直接調整するほうが効率的に作業できることがあります。また、シーンビュー上に調整用のGUIが出ていると何かと便利なこともあります。 下記のようなコンポーネントの編集を例にとって、これをシーンビュー上で編集するようなGUIを検討してみることにします。 Custom Editorの基本形 コンポーネントを編集するGUI…","fields":{"slug":"/2022/07/unity-customeditor-gui-on-sceneview/"},"frontmatter":{"date":"July 03, 2022","type":"tech","tags":["Unity","エディタ拡張"],"title":"Custom EditorでシーンビューにHandleやGUIを出して調整作業を効率化する","description":"シーンビュー上に調整用のGUIを表示することでコンポーネントの調整作業を効率化する方法について紹介します。","eyecatch":{"publicURL":"/static/13af79e9d7c22b29cbc889613bbb9935/B6E112218E097436E6296A58FE2039A7.png"}}}},"pageContext":{"id":"aa50eaf3-d4f1-5722-94e4-cf0f5e76de5a"}},"staticQueryHashes":["1480509143","3159585216"]}